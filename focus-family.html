<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Focus Family</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Bricolage+Grotesque:wght@300;400;600;800;900&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #12121a;
    --surface2: #1a1a26;
    --accent: #7c3aed;
    --accent2: #f59e0b;
    --accent3: #10b981;
    --accent4: #f43f5e;
    --text: #e8e8f0;
    --text-muted: #6b6b8a;
    --border: rgba(124,58,237,0.2);
    --glow: rgba(124,58,237,0.4);
    --focos: #f59e0b;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Bricolage Grotesque', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }
  /* Animated bg */
  body::before {
    content:'';
    position:fixed;
    inset:0;
    background: 
      radial-gradient(ellipse 80% 50% at 20% 20%, rgba(124,58,237,0.12) 0%, transparent 60%),
      radial-gradient(ellipse 60% 40% at 80% 80%, rgba(245,158,11,0.08) 0%, transparent 60%),
      radial-gradient(ellipse 50% 30% at 60% 10%, rgba(16,185,129,0.06) 0%, transparent 50%);
    pointer-events:none;
    z-index:0;
  }

  /* LAYOUT */
  .app-shell { display:flex; min-height:100vh; position:relative; z-index:1; }

  /* SIDEBAR */
  .sidebar {
    width: 240px;
    background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    padding: 24px 0;
    position: fixed;
    top:0; left:0; bottom:0;
    z-index:100;
  }
  .logo {
    padding: 0 24px 32px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 16px;
  }
  .logo-mark {
    font-family:'Space Mono', monospace;
    font-size:11px;
    color:var(--accent);
    text-transform:uppercase;
    letter-spacing:3px;
    margin-bottom:4px;
  }
  .logo-name {
    font-size:22px;
    font-weight:900;
    background: linear-gradient(135deg, #a78bfa, #f59e0b);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .nav-section {
    padding: 8px 12px;
    flex:1;
  }
  .nav-label {
    font-size:10px;
    font-weight:700;
    color:var(--text-muted);
    text-transform:uppercase;
    letter-spacing:2px;
    padding: 0 12px;
    margin: 16px 0 8px;
  }
  .nav-item {
    display:flex;
    align-items:center;
    gap:12px;
    padding:10px 12px;
    border-radius:10px;
    cursor:pointer;
    transition: all 0.2s;
    color:var(--text-muted);
    font-size:14px;
    font-weight:600;
    position:relative;
  }
  .nav-item:hover { background:rgba(124,58,237,0.1); color:var(--text); }
  .nav-item.active {
    background: rgba(124,58,237,0.2);
    color:#a78bfa;
  }
  .nav-item.active::before {
    content:'';
    position:absolute;
    left:0; top:50%;
    transform:translateY(-50%);
    width:3px; height:20px;
    background:var(--accent);
    border-radius:0 3px 3px 0;
  }
  .nav-icon { font-size:18px; width:22px; text-align:center; }
  .nav-badge {
    margin-left:auto;
    background:var(--accent4);
    color:white;
    font-size:10px;
    font-weight:700;
    padding:2px 6px;
    border-radius:20px;
  }

  /* Profile switch */
  .profile-toggle {
    margin: 16px 12px 0;
    background: var(--surface2);
    border-radius:12px;
    padding:4px;
    display:flex;
    border: 1px solid var(--border);
  }
  .profile-btn {
    flex:1;
    padding:8px;
    border-radius:8px;
    text-align:center;
    font-size:12px;
    font-weight:700;
    cursor:pointer;
    transition:all 0.2s;
    color:var(--text-muted);
  }
  .profile-btn.active {
    background: var(--accent);
    color:white;
    box-shadow: 0 0 12px var(--glow);
  }

  /* MAIN CONTENT */
  .main {
    margin-left:240px;
    flex:1;
    padding:32px;
    display:none;
  }
  .main.active { display:block; }

  /* Page header */
  .page-header {
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin-bottom:32px;
  }
  .page-title {
    font-size:32px;
    font-weight:900;
  }
  .page-subtitle {
    font-size:14px;
    color:var(--text-muted);
    margin-top:4px;
  }

  /* FOCOS DISPLAY */
  .focos-badge {
    display:flex;
    align-items:center;
    gap:10px;
    background: linear-gradient(135deg, rgba(245,158,11,0.15), rgba(245,158,11,0.05));
    border: 1px solid rgba(245,158,11,0.3);
    border-radius:16px;
    padding:12px 20px;
  }
  .focos-icon { font-size:24px; }
  .focos-count {
    font-family:'Space Mono',monospace;
    font-size:28px;
    font-weight:700;
    color:var(--focos);
  }
  .focos-label { font-size:12px; color:var(--text-muted); font-weight:600; }

  /* CARDS */
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius:16px;
    padding:24px;
    position:relative;
    overflow:hidden;
  }
  .card::before {
    content:'';
    position:absolute;
    top:0; left:0; right:0;
    height:1px;
    background: linear-gradient(90deg, transparent, var(--accent), transparent);
    opacity:0.5;
  }
  .card-title {
    font-size:13px;
    font-weight:700;
    color:var(--text-muted);
    text-transform:uppercase;
    letter-spacing:1.5px;
    margin-bottom:16px;
  }

  /* GRID LAYOUTS */
  .grid-3 { display:grid; grid-template-columns:repeat(3,1fr); gap:16px; margin-bottom:24px; }
  .grid-2 { display:grid; grid-template-columns:repeat(2,1fr); gap:16px; margin-bottom:24px; }

  /* STAT CARDS */
  .stat-card {
    background: var(--surface);
    border:1px solid var(--border);
    border-radius:16px;
    padding:20px;
    display:flex;
    flex-direction:column;
    gap:8px;
    position:relative;
    overflow:hidden;
    transition: transform 0.2s, box-shadow 0.2s;
    cursor:default;
  }
  .stat-card:hover { transform:translateY(-2px); box-shadow:0 8px 32px rgba(124,58,237,0.15); }
  .stat-icon { font-size:28px; }
  .stat-value {
    font-size:36px;
    font-weight:900;
    font-family:'Space Mono',monospace;
    line-height:1;
  }
  .stat-label { font-size:13px; color:var(--text-muted); font-weight:600; }
  .stat-change { font-size:12px; font-weight:700; margin-top:4px; }
  .stat-change.up { color:var(--accent3); }
  .stat-change.flame { color:#fb923c; }
  .stat-card.purple .stat-value { color:#a78bfa; }
  .stat-card.amber .stat-value { color:var(--focos); }
  .stat-card.green .stat-value { color:var(--accent3); }
  .stat-card.rose .stat-value { color:#fb7185; }

  /* XP BAR */
  .xp-section {
    background: var(--surface);
    border:1px solid var(--border);
    border-radius:16px;
    padding:20px;
    margin-bottom:24px;
  }
  .xp-header {
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:12px;
  }
  .xp-level {
    display:flex;
    align-items:center;
    gap:12px;
  }
  .level-badge {
    width:48px; height:48px;
    background: linear-gradient(135deg,#7c3aed,#4f46e5);
    border-radius:12px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:900;
    font-size:18px;
    box-shadow:0 0 16px rgba(124,58,237,0.4);
  }
  .level-name { font-size:20px; font-weight:800; }
  .level-sub { font-size:13px; color:var(--text-muted); }
  .xp-numbers { font-size:13px; color:var(--text-muted); font-family:'Space Mono',monospace; }
  .xp-bar-track {
    background: rgba(255,255,255,0.06);
    border-radius:100px;
    height:10px;
    overflow:hidden;
  }
  .xp-bar-fill {
    height:100%;
    background: linear-gradient(90deg, #7c3aed, #a78bfa, #f59e0b);
    border-radius:100px;
    width:62%;
    position:relative;
    animation: shimmer 2s infinite;
    background-size:200% 100%;
  }
  @keyframes shimmer {
    0%{background-position:0% 0%}
    100%{background-position:200% 0%}
  }

  /* WEEKLY PLANNER */
  .week-grid {
    display:grid;
    grid-template-columns:80px repeat(7,1fr);
    gap:4px;
    margin-bottom:24px;
  }
  .week-day-header {
    text-align:center;
    padding:12px 4px;
    font-size:12px;
    font-weight:700;
    color:var(--text-muted);
    text-transform:uppercase;
    letter-spacing:1px;
  }
  .week-day-header.today { color:#a78bfa; }
  .week-day-num {
    font-size:20px;
    font-weight:900;
    margin-bottom:2px;
    color:var(--text);
  }
  .week-day-num.today {
    width:32px; height:32px;
    background:var(--accent);
    border-radius:50%;
    display:flex;
    align-items:center;
    justify-content:center;
    margin:0 auto 2px;
    font-size:16px;
    box-shadow:0 0 12px var(--glow);
  }
  .time-label {
    padding:0 8px;
    font-size:11px;
    font-family:'Space Mono',monospace;
    color:var(--text-muted);
    height:44px;
    display:flex;
    align-items:center;
  }
  .time-slot {
    height:44px;
    border:1px solid rgba(255,255,255,0.03);
    border-radius:4px;
    position:relative;
    cursor:pointer;
    transition: background 0.15s;
  }
  .time-slot:hover { background:rgba(124,58,237,0.08); }
  .event-block {
    position:absolute;
    inset:2px;
    border-radius:6px;
    padding:4px 6px;
    font-size:11px;
    font-weight:700;
    display:flex;
    flex-direction:column;
    justify-content:center;
    cursor:pointer;
    transition:transform 0.15s, filter 0.15s;
  }
  .event-block:hover { transform:scaleX(1.02); filter:brightness(1.1); }
  .event-block.clase { background:rgba(124,58,237,0.3); border-left:3px solid #7c3aed; color:#c4b5fd; }
  .event-block.estudio { background:rgba(16,185,129,0.25); border-left:3px solid #10b981; color:#6ee7b7; }
  .event-block.ocio { background:rgba(245,158,11,0.2); border-left:3px solid #f59e0b; color:#fde68a; }
  .event-block.examen { background:rgba(244,63,94,0.25); border-left:3px solid #f43f5e; color:#fda4af; }
  .event-name { overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

  /* POMODORO */
  .pomodoro-card {
    background: var(--surface);
    border:1px solid var(--border);
    border-radius:20px;
    padding:28px;
    text-align:center;
    position:relative;
    overflow:hidden;
  }
  .timer-ring {
    width:160px; height:160px;
    margin:0 auto 20px;
    position:relative;
  }
  .timer-ring svg { transform:rotate(-90deg); }
  .timer-ring circle {
    fill:none;
    stroke:rgba(124,58,237,0.15);
    stroke-width:8;
  }
  .timer-ring circle.progress {
    stroke:url(#timerGrad);
    stroke-width:8;
    stroke-linecap:round;
    stroke-dasharray:440;
    stroke-dashoffset:110;
    transition:stroke-dashoffset 1s linear;
  }
  .timer-time {
    position:absolute;
    inset:0;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    font-family:'Space Mono',monospace;
    font-size:36px;
    font-weight:700;
    color:var(--text);
  }
  .timer-phase { font-size:11px; color:var(--text-muted); margin-top:4px; }
  .timer-subject {
    font-size:16px;
    font-weight:700;
    color:#a78bfa;
    margin-bottom:20px;
  }
  .timer-controls { display:flex; gap:12px; justify-content:center; }
  .btn {
    padding:10px 24px;
    border-radius:10px;
    font-size:14px;
    font-weight:700;
    font-family:'Bricolage Grotesque',sans-serif;
    cursor:pointer;
    border:none;
    transition:all 0.2s;
  }
  .btn-primary {
    background: linear-gradient(135deg,#7c3aed,#6d28d9);
    color:white;
    box-shadow:0 4px 16px rgba(124,58,237,0.4);
  }
  .btn-primary:hover { transform:translateY(-1px); box-shadow:0 6px 20px rgba(124,58,237,0.5); }
  .btn-ghost {
    background:transparent;
    color:var(--text-muted);
    border:1px solid var(--border);
  }
  .btn-ghost:hover { background:rgba(255,255,255,0.05); color:var(--text); }
  .btn-success {
    background:linear-gradient(135deg,#059669,#10b981);
    color:white;
  }

  /* INSIGNIAS */
  .badges-grid {
    display:grid;
    grid-template-columns:repeat(auto-fill, minmax(100px,1fr));
    gap:12px;
  }
  .badge-item {
    background:var(--surface2);
    border:1px solid var(--border);
    border-radius:14px;
    padding:16px 8px;
    text-align:center;
    transition:all 0.2s;
    cursor:pointer;
    position:relative;
  }
  .badge-item:hover { transform:translateY(-3px); border-color:rgba(124,58,237,0.5); }
  .badge-item.earned { border-color:rgba(245,158,11,0.4); }
  .badge-item.earned::after {
    content:'‚úì';
    position:absolute;
    top:8px; right:8px;
    font-size:10px;
    color:var(--focos);
    font-weight:700;
  }
  .badge-item.locked { opacity:0.4; filter:grayscale(1); }
  .badge-emoji { font-size:32px; margin-bottom:8px; display:block; }
  .badge-name { font-size:11px; font-weight:700; color:var(--text); line-height:1.3; }
  .badge-desc { font-size:10px; color:var(--text-muted); margin-top:4px; }

  /* EMOCIONES */
  .emotion-grid {
    display:grid;
    grid-template-columns:repeat(3,1fr);
    gap:10px;
    margin-bottom:16px;
  }
  .emotion-btn {
    background:var(--surface2);
    border:2px solid transparent;
    border-radius:14px;
    padding:16px 8px;
    text-align:center;
    cursor:pointer;
    transition:all 0.2s;
    font-size:28px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:6px;
  }
  .emotion-btn:hover { border-color:rgba(124,58,237,0.4); transform:scale(1.05); }
  .emotion-btn.selected { border-color:var(--accent); background:rgba(124,58,237,0.15); }
  .emotion-label { font-size:11px; font-weight:700; color:var(--text-muted); }

  /* PACTOS */
  .pacto-card {
    background: linear-gradient(135deg, rgba(124,58,237,0.1), rgba(245,158,11,0.05));
    border:1px solid rgba(124,58,237,0.3);
    border-radius:16px;
    padding:20px;
    margin-bottom:12px;
    transition:all 0.2s;
  }
  .pacto-card:hover { transform:translateY(-2px); }
  .pacto-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
  .pacto-title { font-size:16px; font-weight:800; }
  .pacto-reward {
    display:flex;
    align-items:center;
    gap:6px;
    background:rgba(245,158,11,0.15);
    border:1px solid rgba(245,158,11,0.3);
    border-radius:8px;
    padding:6px 12px;
    font-size:13px;
    font-weight:700;
    color:var(--focos);
  }
  .pacto-progress-track {
    background:rgba(255,255,255,0.06);
    border-radius:100px;
    height:8px;
    overflow:hidden;
    margin-top:12px;
  }
  .pacto-progress-fill {
    height:100%;
    border-radius:100px;
    background:linear-gradient(90deg,var(--accent),#a78bfa);
  }
  .pacto-meta {
    display:flex;
    justify-content:space-between;
    margin-top:8px;
    font-size:12px;
    color:var(--text-muted);
    font-weight:600;
  }
  .pacto-status {
    display:inline-flex;
    align-items:center;
    gap:4px;
    font-size:12px;
    font-weight:700;
    padding:4px 10px;
    border-radius:20px;
  }
  .pacto-status.activo { background:rgba(16,185,129,0.15); color:var(--accent3); }
  .pacto-status.pendiente { background:rgba(245,158,11,0.15); color:var(--focos); }

  /* ECONOMIA */
  .economy-header {
    display:flex;
    align-items:center;
    gap:16px;
    background:linear-gradient(135deg,rgba(245,158,11,0.1),transparent);
    border:1px solid rgba(245,158,11,0.2);
    border-radius:16px;
    padding:20px;
    margin-bottom:24px;
  }
  .wallet-icon { font-size:48px; }
  .wallet-balance {
    font-family:'Space Mono',monospace;
    font-size:48px;
    font-weight:700;
    color:var(--focos);
    line-height:1;
  }
  .wallet-label { font-size:14px; color:var(--text-muted); margin-top:4px; }
  .wallet-actions { margin-left:auto; display:flex; gap:10px; }

  .reward-item {
    background:var(--surface2);
    border:1px solid var(--border);
    border-radius:14px;
    padding:16px;
    display:flex;
    align-items:center;
    gap:16px;
    margin-bottom:10px;
    transition:all 0.2s;
    cursor:pointer;
  }
  .reward-item:hover { border-color:rgba(245,158,11,0.3); transform:translateX(4px); }
  .reward-emoji { font-size:32px; width:48px; text-align:center; }
  .reward-info { flex:1; }
  .reward-name { font-size:15px; font-weight:700; }
  .reward-desc { font-size:12px; color:var(--text-muted); margin-top:2px; }
  .reward-cost {
    display:flex;
    align-items:center;
    gap:6px;
    font-family:'Space Mono',monospace;
    font-size:16px;
    font-weight:700;
    color:var(--focos);
  }
  .reward-cat {
    font-size:10px;
    font-weight:700;
    text-transform:uppercase;
    letter-spacing:1px;
    padding:3px 8px;
    border-radius:20px;
  }
  .reward-cat.small { background:rgba(16,185,129,0.15); color:var(--accent3); }
  .reward-cat.medium { background:rgba(124,58,237,0.15); color:#a78bfa; }
  .reward-cat.big { background:rgba(244,63,94,0.15); color:#fb7185; }

  /* PADRES VIEW */
  .parent-header {
    background:linear-gradient(135deg,rgba(16,185,129,0.1),rgba(16,185,129,0.03));
    border:1px solid rgba(16,185,129,0.2);
    border-radius:16px;
    padding:20px;
    margin-bottom:24px;
    display:flex;
    align-items:center;
    gap:16px;
  }
  .child-avatar {
    width:56px; height:56px;
    background:linear-gradient(135deg,#7c3aed,#f59e0b);
    border-radius:50%;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:28px;
    box-shadow:0 0 16px rgba(124,58,237,0.3);
  }
  .weekly-summary {
    display:grid;
    grid-template-columns:repeat(4,1fr);
    gap:12px;
    margin-bottom:24px;
  }
  .summary-mini {
    background:var(--surface);
    border:1px solid var(--border);
    border-radius:12px;
    padding:16px;
    text-align:center;
  }
  .summary-mini-val {
    font-size:28px;
    font-weight:900;
    font-family:'Space Mono',monospace;
  }
  .summary-mini-label { font-size:11px; color:var(--text-muted); margin-top:4px; font-weight:600; }

  .dialog-suggestion {
    background:rgba(16,185,129,0.08);
    border:1px solid rgba(16,185,129,0.2);
    border-radius:14px;
    padding:16px;
    margin-bottom:10px;
    display:flex;
    gap:12px;
    align-items:flex-start;
  }
  .dialog-icon { font-size:20px; }
  .dialog-text { font-size:14px; line-height:1.5; color:var(--text); font-style:italic; }

  /* NOTIFICATION */
  .toast {
    position:fixed;
    bottom:24px; right:24px;
    background:var(--surface);
    border:1px solid var(--border);
    border-radius:14px;
    padding:16px 20px;
    display:flex;
    align-items:center;
    gap:12px;
    z-index:1000;
    transform:translateX(200%);
    transition:transform 0.4s cubic-bezier(0.34,1.56,0.64,1);
    max-width:320px;
    box-shadow:0 8px 32px rgba(0,0,0,0.4);
  }
  .toast.show { transform:translateX(0); }
  .toast-icon { font-size:24px; }
  .toast-content { flex:1; }
  .toast-title { font-size:14px; font-weight:700; }
  .toast-msg { font-size:12px; color:var(--text-muted); margin-top:2px; }

  /* TABS */
  .tab-bar {
    display:flex;
    gap:4px;
    background:var(--surface2);
    border-radius:12px;
    padding:4px;
    margin-bottom:24px;
    border:1px solid var(--border);
    width:fit-content;
  }
  .tab {
    padding:8px 20px;
    border-radius:8px;
    font-size:13px;
    font-weight:700;
    cursor:pointer;
    color:var(--text-muted);
    transition:all 0.2s;
  }
  .tab.active { background:var(--accent); color:white; box-shadow:0 0 12px rgba(124,58,237,0.4); }
  .tab:hover:not(.active) { color:var(--text); }

  /* RACHA */
  .racha-row {
    display:flex;
    gap:6px;
    margin-bottom:16px;
  }
  .racha-day {
    flex:1;
    height:40px;
    border-radius:8px;
    background:rgba(255,255,255,0.04);
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:18px;
    border:1px solid rgba(255,255,255,0.06);
    transition:all 0.2s;
  }
  .racha-day.done { background:rgba(16,185,129,0.2); border-color:rgba(16,185,129,0.3); }
  .racha-day.perfect { background:rgba(124,58,237,0.25); border-color:rgba(124,58,237,0.4); }
  .racha-day.today-dot { border-color:rgba(245,158,11,0.6); }

  /* Utility */
  .flex { display:flex; }
  .flex-col { flex-direction:column; }
  .items-center { align-items:center; }
  .justify-between { justify-content:space-between; }
  .gap-3 { gap:12px; }
  .gap-4 { gap:16px; }
  .mt-4 { margin-top:16px; }
  .mt-6 { margin-top:24px; }
  .fw-700 { font-weight:700; }
  .text-muted { color:var(--text-muted); font-size:13px; }
  .text-small { font-size:12px; }
  .text-success { color:var(--accent3); }
  .text-amber { color:var(--focos); }
  .text-purple { color:#a78bfa; }
  .pill {
    display:inline-flex;
    align-items:center;
    gap:4px;
    font-size:11px;
    font-weight:700;
    padding:4px 10px;
    border-radius:20px;
    text-transform:uppercase;
    letter-spacing:0.5px;
  }
  .pill-purple { background:rgba(124,58,237,0.2); color:#a78bfa; }
  .pill-amber { background:rgba(245,158,11,0.2); color:var(--focos); }
  .pill-green { background:rgba(16,185,129,0.2); color:var(--accent3); }

  /* TOGGLE SWITCH */
  .toggle-switch {
    width:48px; height:26px;
    background:rgba(255,255,255,0.1);
    border-radius:100px;
    padding:3px;
    cursor:pointer;
    transition:background 0.3s;
    flex-shrink:0;
    border:1px solid rgba(255,255,255,0.1);
  }
  .toggle-switch.on { background:var(--accent3); border-color:var(--accent3); }
  .toggle-knob {
    width:18px; height:18px;
    background:white;
    border-radius:50%;
    transition:transform 0.3s cubic-bezier(0.34,1.56,0.64,1);
    box-shadow:0 1px 4px rgba(0,0,0,0.3);
  }
  .toggle-switch.on .toggle-knob { transform:translateX(22px); }

  /* CLASSROOM task card */
  .cl-task {
    background:var(--surface2);
    border:1px solid var(--border);
    border-radius:14px;
    padding:16px;
    display:flex;
    align-items:center;
    gap:14px;
    transition:all 0.2s;
  }
  .cl-task:hover { border-color:rgba(66,133,244,0.4); transform:translateX(3px); }
  .cl-task.imported { border-color:rgba(16,185,129,0.3); opacity:0.6; }
  .cl-subject-dot {
    width:12px; height:12px;
    border-radius:50%;
    flex-shrink:0;
  }
  .urgency-badge {
    font-size:11px;
    font-weight:700;
    padding:3px 8px;
    border-radius:20px;
  }
  .urgency-high { background:rgba(244,63,94,0.15); color:#fb7185; }
  .urgency-mid { background:rgba(245,158,11,0.15); color:var(--focos); }
  .urgency-low { background:rgba(16,185,129,0.15); color:var(--accent3); }


  /* ‚îÄ‚îÄ ONBOARDING OVERLAY ‚îÄ‚îÄ */
  .onboarding {
    position: fixed;
    inset: 0;
    background: var(--bg);
    z-index: 9999;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 32px;
    animation: fadeIn 0.4s ease;
  }
  .onboarding.hidden { display: none; }

  .ob-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 24px;
    padding: 48px;
    max-width: 480px;
    width: 100%;
    text-align: center;
    position: relative;
    overflow: hidden;
  }
  .ob-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: linear-gradient(90deg, #7c3aed, #f59e0b, #10b981);
  }
  .ob-logo {
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    color: var(--accent);
    text-transform: uppercase;
    letter-spacing: 3px;
    margin-bottom: 6px;
  }
  .ob-title {
    font-size: 32px;
    font-weight: 900;
    background: linear-gradient(135deg, #a78bfa, #f59e0b);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 8px;
  }
  .ob-subtitle {
    font-size: 15px;
    color: var(--text-muted);
    margin-bottom: 36px;
    line-height: 1.6;
  }

  /* Role selector cards */
  .role-cards { display: flex; gap: 16px; margin-bottom: 28px; }
  .role-card {
    flex: 1;
    background: var(--surface2);
    border: 2px solid var(--border);
    border-radius: 16px;
    padding: 24px 16px;
    cursor: pointer;
    transition: all 0.25s cubic-bezier(0.34,1.56,0.64,1);
    text-align: center;
  }
  .role-card:hover { transform: translateY(-4px); border-color: rgba(124,58,237,0.5); }
  .role-card.selected { border-color: var(--accent); background: rgba(124,58,237,0.12); box-shadow: 0 0 24px rgba(124,58,237,0.2); }
  .role-emoji { font-size: 48px; margin-bottom: 12px; display: block; }
  .role-label { font-size: 17px; font-weight: 900; margin-bottom: 4px; }
  .role-desc { font-size: 12px; color: var(--text-muted); line-height: 1.4; }

  /* Input field */
  .ob-input {
    width: 100%;
    padding: 14px 18px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 12px;
    color: var(--text);
    font-size: 15px;
    font-family: inherit;
    margin-bottom: 12px;
    transition: border-color 0.2s;
    outline: none;
  }
  .ob-input:focus { border-color: rgba(124,58,237,0.6); box-shadow: 0 0 0 3px rgba(124,58,237,0.1); }
  .ob-input::placeholder { color: var(--text-muted); }

  /* Google button */
  .btn-google {
    width: 100%;
    padding: 14px;
    background: white;
    color: #1a1a26;
    border: none;
    border-radius: 12px;
    font-size: 15px;
    font-weight: 700;
    font-family: inherit;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    margin-bottom: 12px;
    transition: all 0.2s;
    box-shadow: 0 4px 16px rgba(0,0,0,0.3);
  }
  .btn-google:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(0,0,0,0.4); }

  .ob-divider {
    display: flex;
    align-items: center;
    gap: 12px;
    margin: 16px 0;
    color: var(--text-muted);
    font-size: 12px;
  }
  .ob-divider::before, .ob-divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  .ob-back {
    background: none;
    border: none;
    color: var(--text-muted);
    font-size: 13px;
    font-family: inherit;
    cursor: pointer;
    margin-top: 16px;
    padding: 8px 16px;
    border-radius: 8px;
    transition: all 0.2s;
  }
  .ob-back:hover { color: var(--text); background: rgba(255,255,255,0.05); }

  /* QR styles */
  .qr-container {
    width: 200px;
    height: 200px;
    margin: 0 auto 20px;
    background: white;
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    box-shadow: 0 0 40px rgba(124,58,237,0.3);
  }
  .qr-inner {
    width: 176px;
    height: 176px;
    display: grid;
    grid-template-columns: repeat(11, 1fr);
    gap: 2px;
    padding: 8px;
  }
  .qr-cell { border-radius: 2px; }
  .qr-cell.dark { background: #1a1a26; }
  .qr-cell.light { background: white; }

  .family-code {
    font-family: 'Space Mono', monospace;
    font-size: 28px;
    font-weight: 700;
    color: var(--accent);
    letter-spacing: 6px;
    background: rgba(124,58,237,0.1);
    border: 1px solid rgba(124,58,237,0.3);
    border-radius: 12px;
    padding: 16px 24px;
    margin: 16px 0;
    display: inline-block;
  }

  .scanning-ring {
    width: 220px;
    height: 220px;
    margin: 0 auto 24px;
    border-radius: 20px;
    border: 3px solid rgba(124,58,237,0.3);
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(124,58,237,0.04);
  }
  .scanning-ring::before {
    content: '';
    position: absolute;
    top: -3px; left: -3px; right: -3px; bottom: -3px;
    border-radius: 22px;
    border: 3px solid transparent;
    border-top-color: var(--accent);
    animation: spin 1.5s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .scan-line {
    position: absolute;
    left: 10px; right: 10px;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--accent), transparent);
    animation: scanMove 2s ease-in-out infinite;
  }
  @keyframes scanMove {
    0%, 100% { top: 20px; }
    50% { top: 190px; }
  }

  /* Linked success */
  .success-check {
    width: 80px;
    height: 80px;
    background: linear-gradient(135deg, var(--accent3), #059669);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 40px;
    margin: 0 auto 20px;
    animation: popIn 0.5s cubic-bezier(0.34,1.56,0.64,1);
    box-shadow: 0 0 40px rgba(16,185,129,0.4);
  }
  @keyframes popIn {
    from { transform: scale(0); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
  }

  /* Steps indicator */
  .ob-steps {
    display: flex;
    gap: 8px;
    justify-content: center;
    margin-bottom: 32px;
  }
  .ob-step {
    width: 32px;
    height: 4px;
    border-radius: 100px;
    background: var(--surface2);
    transition: all 0.3s;
  }
  .ob-step.active { background: var(--accent); width: 48px; }
  .ob-step.done { background: var(--accent3); }

  /* Animation */
  @keyframes fadeIn {
    from { opacity:0; transform:translateY(12px); }
    to { opacity:1; transform:translateY(0); }
  }
  .main.active { animation:fadeIn 0.3s ease; }

  .section-title {
    font-size:18px;
    font-weight:800;
    margin-bottom:16px;
    display:flex;
    align-items:center;
    gap:8px;
  }
</style>
</head>
<body>


<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     ONBOARDING OVERLAYS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

<!-- SCREEN 0: WELCOME / ROLE SELECTOR -->
<div class="onboarding" id="ob-welcome">
  <div class="ob-card">
    <div style="position:absolute;top:-40px;right:-40px;font-size:160px;opacity:0.04;">üéì</div>
    <div class="ob-logo">üì° Focus Family</div>
    <div class="ob-title">Focus Family</div>
    <div class="ob-subtitle">La app que conecta el estudio del adolescente con el acompa√±amiento familiar</div>
    <div class="ob-steps">
      <div class="ob-step active" id="step-0-0"></div>
      <div class="ob-step" id="step-0-1"></div>
      <div class="ob-step" id="step-0-2"></div>
    </div>
    <div class="role-cards">
      <div class="role-card" id="role-hijo" onclick="selectRole('hijo')">
        <span class="role-emoji">üéí</span>
        <div class="role-label">Soy alumno</div>
        <div class="role-desc">Organizo mis estudios y gano Focos</div>
      </div>
      <div class="role-card" id="role-padre" onclick="selectRole('padre')">
        <span class="role-emoji">üë®‚Äçüë©‚Äçüë¶</span>
        <div class="role-label">Soy padre/madre</div>
        <div class="role-desc">Acompa√±o a mi hijo y gestionamos pactos</div>
      </div>
    </div>
    <button class="btn btn-primary" style="width:100%;padding:16px;font-size:16px;" id="btn-role-continue" onclick="goToLogin()" disabled style="opacity:0.4;">
      Continuar ‚Üí
    </button>
    <div style="margin-top:16px;font-size:12px;color:var(--text-muted);">¬øYa tienes cuenta? <span style="color:#a78bfa;cursor:pointer;font-weight:700;" onclick="goToLogin()">Iniciar sesi√≥n</span></div>
  </div>
</div>

<!-- SCREEN 1: LOGIN / REGISTER -->
<div class="onboarding hidden" id="ob-login">
  <div class="ob-card">
    <div class="ob-steps">
      <div class="ob-step done"></div>
      <div class="ob-step active"></div>
      <div class="ob-step"></div>
    </div>
    <div id="ob-login-emoji" style="font-size:52px;margin-bottom:16px;">üéí</div>
    <div class="ob-title" id="ob-login-title">Crea tu cuenta</div>
    <div class="ob-subtitle" id="ob-login-subtitle">Como alumno, organiza tu estudio y gana Focos</div>

    <button class="btn-google" onclick="loginWithGoogle()">
      <svg width="20" height="20" viewBox="0 0 48 48"><path fill="#4285F4" d="M44.5 20H24v8.5h11.8C34.7 33.9 30.1 37 24 37c-7.2 0-13-5.8-13-13s5.8-13 13-13c3.1 0 5.9 1.1 8.1 2.9l6.4-6.4C34.6 4.1 29.6 2 24 2 11.8 2 2 11.8 2 24s9.8 22 22 22c11 0 21-8 21-22 0-1.3-.2-2.7-.5-4z"/></svg>
      Continuar con Google
    </button>

    <div class="ob-divider">o con email</div>

    <input class="ob-input" type="text" placeholder="Tu nombre" id="input-name" />
    <input class="ob-input" type="email" placeholder="Email" id="input-email" />
    <input class="ob-input" type="password" placeholder="Contrase√±a" id="input-pass" />

    <button class="btn btn-primary" style="width:100%;padding:14px;font-size:15px;" onclick="doRegister()">
      Crear cuenta y continuar ‚Üí
    </button>

    <button class="ob-back" onclick="goBack('ob-welcome')">‚Üê Volver</button>
  </div>
</div>

<!-- SCREEN 2A: PADRE GENERA QR -->
<div class="onboarding hidden" id="ob-padre-qr">
  <div class="ob-card" style="max-width:520px;">
    <div class="ob-steps">
      <div class="ob-step done"></div>
      <div class="ob-step done"></div>
      <div class="ob-step active"></div>
    </div>
    <div style="font-size:14px;color:var(--text-muted);margin-bottom:4px;font-weight:600;">Paso 3 de 3</div>
    <div class="ob-title" style="font-size:26px;">Vincula a tu hijo/a</div>
    <div class="ob-subtitle" style="margin-bottom:24px;">Mu√©strale este QR o dile el c√≥digo. Cuando lo escanee, quedar√©is conectados autom√°ticamente.</div>

    <!-- QR Code -->
    <div class="qr-container" id="qr-display">
      <canvas id="qr-canvas" width="176" height="176"></canvas>
    </div>

    <!-- Family code -->
    <div class="family-code" id="family-code-display">FAM-4X92K</div>

    <div style="display:flex;gap:10px;justify-content:center;margin-bottom:20px;">
      <button class="btn btn-ghost" style="font-size:13px;" onclick="copyCode()">üìã Copiar c√≥digo</button>
      <button class="btn btn-ghost" style="font-size:13px;" onclick="shareQR()">üì§ Compartir QR</button>
      <button class="btn btn-ghost" style="font-size:13px;" onclick="regenerateCode()">‚Ü∫ Regenerar</button>
    </div>

    <!-- Waiting indicator -->
    <div id="qr-waiting" style="display:flex;align-items:center;justify-content:center;gap:10px;padding:14px;background:rgba(124,58,237,0.08);border:1px solid rgba(124,58,237,0.2);border-radius:12px;font-size:13px;color:var(--text-muted);margin-bottom:20px;">
      <div style="width:8px;height:8px;border-radius:50%;background:var(--accent);animation:pulse 1.5s infinite;"></div>
      Esperando que tu hijo/a escanee el c√≥digo...
    </div>

    <!-- Children already linked (if any) -->
    <div id="linked-children" style="display:none;margin-bottom:16px;">
      <div style="font-size:12px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;">Hijos vinculados</div>
    </div>

    <button class="btn btn-primary" style="width:100%;padding:14px;font-size:15px;" onclick="enterApp()">
      Entrar al panel familiar ‚Üí
    </button>
    <div style="font-size:12px;color:var(--text-muted);margin-top:12px;">Puedes a√±adir m√°s hijos despu√©s desde Ajustes</div>
  </div>
</div>

<!-- SCREEN 2B: HIJO ESCANEA QR -->
<div class="onboarding hidden" id="ob-hijo-qr">
  <div class="ob-card" style="max-width:480px;">
    <div class="ob-steps">
      <div class="ob-step done"></div>
      <div class="ob-step done"></div>
      <div class="ob-step active"></div>
    </div>
    <div style="font-size:14px;color:var(--text-muted);margin-bottom:4px;font-weight:600;">Paso 3 de 3</div>
    <div class="ob-title" style="font-size:26px;">Con√©ctate con tu familia</div>
    <div class="ob-subtitle" style="margin-bottom:24px;">Escanea el QR que te muestra tu padre/madre, o introduce el c√≥digo de 6 caracteres.</div>

    <!-- Scanner mockup -->
    <div class="scanning-ring" id="scanner-view">
      <div class="scan-line"></div>
      <div style="font-size:11px;color:var(--text-muted);position:absolute;bottom:-24px;width:100%;text-align:center;">Apunta la c√°mara al QR</div>
    </div>

    <div class="ob-divider" style="margin-top:32px;">o introduce el c√≥digo manualmente</div>

    <!-- Manual code input -->
    <div style="display:flex;gap:8px;margin-bottom:16px;">
      <span style="display:flex;align-items:center;padding:0 12px;background:var(--surface2);border:1px solid var(--border);border-radius:12px;font-size:15px;font-weight:700;color:var(--text-muted);">FAM-</span>
      <input class="ob-input" style="margin:0;flex:1;font-family:'Space Mono',monospace;font-size:18px;font-weight:700;letter-spacing:4px;text-transform:uppercase;" type="text" placeholder="4X92K" maxlength="5" id="code-input" oninput="checkCode(this)" />
    </div>

    <button class="btn btn-primary" style="width:100%;padding:14px;font-size:15px;" id="btn-verify-code" onclick="verifyCode()" disabled>
      Verificar c√≥digo ‚Üí
    </button>

    <button class="btn btn-ghost" style="width:100%;margin-top:8px;" onclick="simulateScan()">
      üì∑ Simular escaneo QR (demo)
    </button>

    <button class="ob-back" onclick="goBack('ob-login')">‚Üê Volver</button>
  </div>
</div>

<!-- SCREEN 3: VINCULACI√ìN EXITOSA -->
<div class="onboarding hidden" id="ob-success">
  <div class="ob-card">
    <div class="success-check">‚úì</div>
    <div class="ob-title" style="font-size:28px;" id="success-title">¬°Conectados!</div>
    <div class="ob-subtitle" id="success-subtitle">Ya est√°is vinculados. Alejandro puede ver sus Focos y t√∫ puedes ver su progreso semanal.</div>

    <div style="display:flex;align-items:center;justify-content:center;gap:16px;margin:24px 0;padding:20px;background:rgba(16,185,129,0.08);border:1px solid rgba(16,185,129,0.2);border-radius:16px;">
      <div style="text-align:center;">
        <div style="font-size:36px;" id="success-child-emoji">üë¶</div>
        <div style="font-size:13px;font-weight:700;margin-top:6px;" id="success-child-name">Alejandro</div>
        <div style="font-size:11px;color:var(--accent3);">Alumno</div>
      </div>
      <div style="flex:1;height:2px;background:linear-gradient(90deg,var(--accent3),var(--accent));border-radius:100px;position:relative;">
        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:16px;">üîó</div>
      </div>
      <div style="text-align:center;">
        <div style="font-size:36px;" id="success-parent-emoji">üë®</div>
        <div style="font-size:13px;font-weight:700;margin-top:6px;" id="success-parent-name">Cuenta familiar</div>
        <div style="font-size:11px;color:var(--accent3);">Padre/madre</div>
      </div>
    </div>

    <button class="btn btn-primary" style="width:100%;padding:16px;font-size:16px;" id="btn-enter-app" onclick="enterApp()">
      Entrar a Focus Family üöÄ
    </button>
  </div>
</div>

<!-- PERFIL PAGE (dentro del app) -->
<style>
@keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.5;transform:scale(1.3)} }
</style>


<div class="app-shell" id="app-shell" style="display:none!important;">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="logo">
      <div class="logo-mark">üì° App</div>
      <div class="logo-name">Focus Family</div>
    </div>

    <!-- User card in sidebar -->
    <div id="sidebar-user" style="margin:0 12px 16px;background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:12px;cursor:pointer;transition:all 0.2s;" onclick="showPage('perfil')" onmouseover="this.style.borderColor='rgba(124,58,237,0.4)'" onmouseout="this.style.borderColor='var(--border)'">
      <div style="display:flex;align-items:center;gap:10px;">
        <div id="sidebar-avatar" style="width:36px;height:36px;background:linear-gradient(135deg,#7c3aed,#f59e0b);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;">üë¶</div>
        <div style="flex:1;min-width:0;">
          <div id="sidebar-name" style="font-size:13px;font-weight:800;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">Alejandro</div>
          <div id="sidebar-role" style="font-size:10px;color:var(--accent3);font-weight:700;text-transform:uppercase;letter-spacing:1px;">Alumno</div>
        </div>
        <div style="font-size:16px;">‚öôÔ∏è</div>
      </div>
    </div>

    <div class="nav-section">
      <div class="nav-label">Principal</div>
      <div class="nav-item active" onclick="showPage('dashboard')" id="nav-dashboard">
        <span class="nav-icon">üè†</span> Inicio
      </div>
      <div class="nav-item" onclick="showPage('planner')" id="nav-planner">
        <span class="nav-icon">üìÖ</span> Planificador
      </div>
      <div class="nav-item" onclick="showPage('pomodoro')" id="nav-pomodoro">
        <span class="nav-icon">‚è±Ô∏è</span> Modo Estudio
      </div>
      <div class="nav-label">Progreso</div>
      <div class="nav-item" onclick="showPage('badges')" id="nav-badges">
        <span class="nav-icon">üèÜ</span> Insignias
      </div>
      <div class="nav-item" onclick="showPage('economia')" id="nav-economia">
        <span class="nav-icon">ü™ô</span> Econom√≠a
      </div>
      <div class="nav-label">Familia</div>
      <div class="nav-item" onclick="showPage('padres')" id="nav-padres">
        <span class="nav-icon">üë®‚Äçüë©‚Äçüë¶</span> Panel Familiar
      </div>
      <div class="nav-item" onclick="showPage('recompensas')" id="nav-recompensas">
        <span class="nav-icon">üéÅ</span> Recompensas
      </div>
      <div class="nav-item" onclick="showPage('pactos')" id="nav-pactos">
        <span class="nav-icon">ü§ù</span> Pactos
        <span class="nav-badge">1</span>
      </div>
      <div class="nav-item" onclick="showPage('tecnicas')" id="nav-tecnicas">
        <span class="nav-icon">üìö</span> T√©cnicas
      </div>
      <div class="nav-label">Inteligencia</div>
      <div class="nav-item" onclick="showPage('ia')" id="nav-ia">
        <span class="nav-icon">üß†</span> IA Personal
      </div>
      <div class="nav-item" onclick="showPage('examenes')" id="nav-examenes">
        <span class="nav-icon">üéØ</span> Ex√°menes
      </div>
      <div class="nav-item" onclick="showPage('heatmap')" id="nav-heatmap">
        <span class="nav-icon">üóìÔ∏è</span> Mapa Anual
      </div>
      <div class="nav-label">Comunidad</div>
      <div class="nav-item" onclick="showPage('temporada')" id="nav-temporada">
        <span class="nav-icon">üèÜ</span> Temporada
      </div>
      <div class="nav-item" onclick="showPage('clase')" id="nav-clase">
        <span class="nav-icon">üè´</span> Mi Clase
      </div>
      <div class="nav-label">Familia</div>
      <div class="nav-item" onclick="showPage('focos-solidarios')" id="nav-focos-solidarios">
        <span class="nav-icon">ü´∂</span> Focos Solidarios
      </div>
      <div class="nav-label">Integraci√≥n</div>
      <div class="nav-item" onclick="showPage('classroom')" id="nav-classroom">
        <span class="nav-icon">üéì</span> Classroom
        <span class="nav-badge" style="background:var(--accent3);">SYNC</span>
      </div>
      <div style="margin-top:auto;padding-top:16px;border-top:1px solid var(--border);margin:16px 12px 0;">
        <div class="nav-item" onclick="showPage('perfil')" id="nav-perfil" style="color:var(--text-muted);">
          <span class="nav-icon">‚öôÔ∏è</span> Mi perfil y familia
        </div>
      </div>
    </div>
  </aside>

  <!-- ===================== DASHBOARD ===================== -->
  <main class="main active" id="page-dashboard">
    <div class="page-header">
      <div>
        <div class="page-title">üëã ¬°Hola, Alejandro!</div>
        <div class="page-subtitle">Semana 2 de Febrero ¬∑ <span class="text-amber">üî• Racha de 5 d√≠as</span></div>
      </div>
      <div class="focos-badge">
        <span class="focos-icon">üîÜ</span>
        <div>
          <div class="focos-count" id="focos-display">347</div>
          <div class="focos-label">FOCOS</div>
        </div>
      </div>
    </div>

    <!-- XP Bar -->
    <div class="xp-section">
      <div class="xp-header">
        <div class="xp-level">
          <div class="level-badge">4</div>
          <div>
            <div class="level-name">Maestro del Enfoque</div>
            <div class="level-sub">Nivel 4 de 8</div>
          </div>
        </div>
        <div class="xp-numbers">347 / 500 XP</div>
      </div>
      <div class="xp-bar-track">
        <div class="xp-bar-fill"></div>
      </div>
      <div style="display:flex;justify-content:space-between;margin-top:8px;font-size:11px;color:var(--text-muted);">
        <span>Nivel 4</span>
        <span>153 Focos para el Nivel 5 ‚Üí <strong style="color:#a78bfa">Sabio</strong></span>
        <span>Nivel 5</span>
      </div>
    </div>

    <!-- Stats -->
    <div class="grid-3">
      <div class="stat-card purple">
        <div class="stat-icon">üìö</div>
        <div class="stat-value">12</div>
        <div class="stat-label">Bloques esta semana</div>
        <div class="stat-change up">‚Üë +3 vs semana pasada</div>
      </div>
      <div class="stat-card amber">
        <div class="stat-icon">üíé</div>
        <div class="stat-value">8</div>
        <div class="stat-label">Bloques perfectos</div>
        <div class="stat-change up">‚Üë 67% sin interrupciones</div>
      </div>
      <div class="stat-card rose">
        <div class="stat-icon">üî•</div>
        <div class="stat-value">5</div>
        <div class="stat-label">D√≠as de racha</div>
        <div class="stat-change flame">¬°R√©cord personal!</div>
      </div>
    </div>

    <!-- Racha semanal -->
    <div class="card" style="margin-bottom:24px;">
      <div class="card-title">Racha de la semana</div>
      <div class="racha-row">
        <div class="racha-day perfect">üíé</div>
        <div class="racha-day done">‚úÖ</div>
        <div class="racha-day perfect">üíé</div>
        <div class="racha-day done">‚úÖ</div>
        <div class="racha-day today-dot">üìç</div>
        <div class="racha-day">‚Äî</div>
        <div class="racha-day">‚Äî</div>
      </div>
      <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--text-muted);font-weight:600;">
        <span>LUN</span><span>MAR</span><span>MI√â</span><span>JUE</span><span>HOY</span><span>SAB</span><span>DOM</span>
      </div>
    </div>

    <!-- Hoy -->
    <div class="grid-2">
      <div class="card">
        <div class="card-title">üìã Agenda de hoy</div>
        <div style="display:flex;flex-direction:column;gap:8px;">
          <div style="display:flex;align-items:center;gap:10px;padding:10px;background:rgba(124,58,237,0.1);border-radius:10px;border-left:3px solid #7c3aed;">
            <span style="font-size:14px;font-family:'Space Mono',monospace;color:var(--text-muted);">09:00</span>
            <span style="font-size:14px;font-weight:700;color:#c4b5fd;">üìê Matem√°ticas</span>
            <span class="pill pill-purple" style="margin-left:auto;">Clase</span>
          </div>
          <div style="display:flex;align-items:center;gap:10px;padding:10px;background:rgba(124,58,237,0.1);border-radius:10px;border-left:3px solid #7c3aed;">
            <span style="font-size:14px;font-family:'Space Mono',monospace;color:var(--text-muted);">11:00</span>
            <span style="font-size:14px;font-weight:700;color:#c4b5fd;">üî¨ F√≠sica</span>
            <span class="pill pill-purple" style="margin-left:auto;">Clase</span>
          </div>
          <div style="display:flex;align-items:center;gap:10px;padding:10px;background:rgba(16,185,129,0.1);border-radius:10px;border-left:3px solid #10b981;">
            <span style="font-size:14px;font-family:'Space Mono',monospace;color:var(--text-muted);">16:30</span>
            <span style="font-size:14px;font-weight:700;color:#6ee7b7;">üìù Repaso Mates</span>
            <span class="pill pill-green" style="margin-left:auto;">Estudio</span>
          </div>
          <div style="display:flex;align-items:center;gap:10px;padding:10px;background:rgba(245,158,11,0.08);border-radius:10px;border-left:3px solid #f59e0b;">
            <span style="font-size:14px;font-family:'Space Mono',monospace;color:var(--text-muted);">19:00</span>
            <span style="font-size:14px;font-weight:700;color:#fde68a;">üéÆ Tiempo libre</span>
            <span class="pill pill-amber" style="margin-left:auto;">Ocio</span>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">üéØ Registro emocional</div>
        <div style="font-size:13px;color:var(--text-muted);margin-bottom:12px;">¬øC√≥mo fue tu sesi√≥n de hoy?</div>
        <div class="emotion-grid" style="grid-template-columns:repeat(3,1fr);">
          <div class="emotion-btn" onclick="selectEmotion(this,'genial')">üòä<span class="emotion-label">Genial</span></div>
          <div class="emotion-btn" onclick="selectEmotion(this,'regular')">üòê<span class="emotion-label">Regular</span></div>
          <div class="emotion-btn" onclick="selectEmotion(this,'costado')">üò´<span class="emotion-label">Cost√≥</span></div>
          <div class="emotion-btn" onclick="selectEmotion(this,'cansado')">üò¥<span class="emotion-label">Cansado</span></div>
          <div class="emotion-btn" onclick="selectEmotion(this,'frustrado')">üò§<span class="emotion-label">Frustrado</span></div>
          <div class="emotion-btn" onclick="selectEmotion(this,'concentrado')">üß†<span class="emotion-label">Enfocado</span></div>
        </div>
        <button class="btn btn-success" style="width:100%;margin-top:8px;" onclick="saveEmotion()">Guardar (+2 üîÜ)</button>
      </div>
    </div>
  </main>

  <!-- ===================== PLANIFICADOR ===================== -->
  <main class="main" id="page-planner">
    <div class="page-header">
      <div>
        <div class="page-title">üìÖ Planificador Semanal</div>
        <div class="page-subtitle">17 - 23 Febrero 2025 ¬∑ <span class="text-purple">+10 Focos por planificar</span></div>
      </div>
      <div style="display:flex;gap:10px;">
        <button class="btn btn-ghost">‚Üê Anterior</button>
        <button class="btn btn-primary" onclick="showToast('‚úÖ','¬°Semana planificada!','Has ganado 10 üîÜ Focos')">Guardar plan (+10 üîÜ)</button>
      </div>
    </div>

    <!-- Leyenda -->
    <div style="display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap;">
      <div style="display:flex;align-items:center;gap:6px;font-size:12px;font-weight:700;color:#c4b5fd;"><div style="width:12px;height:12px;background:#7c3aed;border-radius:3px;"></div>Clase</div>
      <div style="display:flex;align-items:center;gap:6px;font-size:12px;font-weight:700;color:#6ee7b7;"><div style="width:12px;height:12px;background:#10b981;border-radius:3px;"></div>Estudio</div>
      <div style="display:flex;align-items:center;gap:6px;font-size:12px;font-weight:700;color:#fde68a;"><div style="width:12px;height:12px;background:#f59e0b;border-radius:3px;"></div>Ocio</div>
      <div style="display:flex;align-items:center;gap:6px;font-size:12px;font-weight:700;color:#fda4af;"><div style="width:12px;height:12px;background:#f43f5e;border-radius:3px;"></div>Examen</div>
    </div>

    <!-- Week grid -->
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:16px;overflow-x:auto;">
      <div class="week-grid" id="week-grid">
        <!-- Headers -->
        <div></div>
        <div class="week-day-header"><div class="week-day-num">17</div>LUN</div>
        <div class="week-day-header"><div class="week-day-num">18</div>MAR</div>
        <div class="week-day-header"><div class="week-day-num">19</div>MI√â</div>
        <div class="week-day-header"><div class="week-day-num">20</div>JUE</div>
        <div class="week-day-header today"><div class="week-day-num today">21</div>VIE</div>
        <div class="week-day-header"><div class="week-day-num">22</div>S√ÅB</div>
        <div class="week-day-header"><div class="week-day-num">23</div>DOM</div>
      </div>
      <div id="time-rows"></div>
    </div>
  </main>

  <!-- PLANNER EVENT MODAL -->
  <div id="event-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:600;align-items:center;justify-content:center;" onclick="if(event.target===this)closeEventModal()">
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:28px;max-width:420px;width:90%;position:relative;animation:fadeIn 0.2s ease;" onclick="event.stopPropagation()">

      <!-- Header -->
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">
        <div style="font-size:18px;font-weight:900;" id="event-modal-title">Nuevo evento</div>
        <div style="display:flex;gap:8px;align-items:center;">
          <button id="btn-delete-event" style="display:none;background:rgba(244,63,94,0.12);border:1px solid rgba(244,63,94,0.3);color:#fb7185;border-radius:8px;padding:6px 12px;font-size:12px;font-weight:700;cursor:pointer;" onclick="deleteEvent()">üóëÔ∏è Eliminar</button>
          <span style="cursor:pointer;font-size:20px;color:var(--text-muted);padding:4px 8px;" onclick="closeEventModal()">‚úï</span>
        </div>
      </div>

      <!-- Day + Hour info -->
      <div style="font-size:13px;color:#a78bfa;font-weight:700;margin-bottom:16px;font-family:Space Mono,monospace;" id="event-modal-slot"></div>

      <!-- Event name -->
      <div style="font-size:12px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">Nombre del evento</div>
      <input id="event-name-input" class="ob-input" type="text" placeholder="ej: Estudio Matem√°ticas" style="margin-bottom:16px;" onkeydown="if(event.key==='Enter')saveEvent()" />

      <!-- Type selector -->
      <div style="font-size:12px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;">Tipo</div>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:20px;" id="type-selector">
        <div onclick="selectEventType('clase',this)" class="type-opt" data-type="clase"
          style="padding:10px 6px;border-radius:10px;border:2px solid rgba(124,58,237,0.3);background:rgba(124,58,237,0.1);text-align:center;cursor:pointer;transition:all 0.15s;">
          <div style="font-size:18px;">üè´</div>
          <div style="font-size:11px;font-weight:700;color:#c4b5fd;margin-top:3px;">Clase</div>
        </div>
        <div onclick="selectEventType('estudio',this)" class="type-opt" data-type="estudio"
          style="padding:10px 6px;border-radius:10px;border:2px solid rgba(16,185,129,0.3);background:rgba(16,185,129,0.1);text-align:center;cursor:pointer;transition:all 0.15s;">
          <div style="font-size:18px;">üìñ</div>
          <div style="font-size:11px;font-weight:700;color:#6ee7b7;margin-top:3px;">Estudio</div>
        </div>
        <div onclick="selectEventType('ocio',this)" class="type-opt" data-type="ocio"
          style="padding:10px 6px;border-radius:10px;border:2px solid rgba(245,158,11,0.3);background:rgba(245,158,11,0.1);text-align:center;cursor:pointer;transition:all 0.15s;">
          <div style="font-size:18px;">üéÆ</div>
          <div style="font-size:11px;font-weight:700;color:#fde68a;margin-top:3px;">Ocio</div>
        </div>
        <div onclick="selectEventType('examen',this)" class="type-opt" data-type="examen"
          style="padding:10px 6px;border-radius:10px;border:2px solid rgba(244,63,94,0.3);background:rgba(244,63,94,0.1);text-align:center;cursor:pointer;transition:all 0.15s;">
          <div style="font-size:18px;">üìù</div>
          <div style="font-size:11px;font-weight:700;color:#fda4af;margin-top:3px;">Examen</div>
        </div>
      </div>

      <!-- Time range picker -->
      <div style="font-size:12px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;">Hora de inicio y fin</div>
      <div style="display:flex;gap:12px;align-items:center;margin-bottom:8px;">
        <div style="flex:1;">
          <div style="font-size:11px;color:var(--text-muted);font-weight:600;margin-bottom:6px;">Inicio</div>
          <select id="event-start-select" class="ob-input" style="margin:0;cursor:pointer;font-family:Space Mono,monospace;font-size:14px;" onchange="updateEventEndOptions()"></select>
        </div>
        <div style="font-size:20px;color:var(--text-muted);padding-top:18px;">‚Üí</div>
        <div style="flex:1;">
          <div style="font-size:11px;color:var(--text-muted);font-weight:600;margin-bottom:6px;">Fin</div>
          <select id="event-end-select" class="ob-input" style="margin:0;cursor:pointer;font-family:Space Mono,monospace;font-size:14px;" onchange="updateDurationLabel()"></select>
        </div>
        <div style="padding-top:18px;text-align:center;min-width:60px;">
          <div style="font-family:Space Mono,monospace;font-size:16px;font-weight:700;color:#a78bfa;" id="duration-label">1h</div>
          <div style="font-size:10px;color:var(--text-muted);">duraci√≥n</div>
        </div>
      </div>
      <div style="margin-bottom:20px;padding:8px 12px;background:rgba(124,58,237,0.06);border-radius:8px;font-size:12px;color:var(--text-muted);" id="time-range-preview">
        Bloque de <strong style="color:#a78bfa;" id="time-range-text">1 hora</strong>
      </div>

      <!-- Save -->
      <button class="btn btn-primary" style="width:100%;padding:14px;font-size:15px;" onclick="saveEvent()">
        <span id="save-event-label">A√±adir al planificador</span>
      </button>
    </div>
  </div>

  <!-- ===================== POMODORO ===================== -->
  <main class="main" id="page-pomodoro">
    <div class="page-header">
      <div>
        <div class="page-title">‚è±Ô∏è Modo Estudio</div>
        <div class="page-subtitle">T√©cnica Pomodoro ¬∑ 25 min enfoque / 5 min descanso</div>
      </div>
      <div class="focos-badge">
        <span class="focos-icon">üîÜ</span>
        <div>
          <div class="focos-count" id="focos-display2">347</div>
          <div class="focos-label">FOCOS</div>
        </div>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px;">
      <!-- Timer -->
      <div class="pomodoro-card">
        <div class="card-title">Sesi√≥n activa</div>
        <div class="timer-subject" id="subject-display">üìê Matem√°ticas - Derivadas</div>
        <div class="timer-ring">
          <svg width="160" height="160" viewBox="0 0 160 160">
            <defs>
              <linearGradient id="timerGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" stop-color="#7c3aed"/>
                <stop offset="100%" stop-color="#f59e0b"/>
              </linearGradient>
            </defs>
            <circle cx="80" cy="80" r="70"/>
            <circle class="progress" cx="80" cy="80" r="70" id="timer-circle"/>
          </svg>
          <div class="timer-time">
            <span id="timer-display">25:00</span>
            <span class="timer-phase" id="timer-phase">ENFOQUE</span>
          </div>
        </div>
        <div style="display:flex;gap:10px;justify-content:center;margin-bottom:20px;font-size:13px;color:var(--text-muted);">
          <span>üçÖ Pomodoro <strong style="color:#fb923c;" id="pomodoro-count">1</strong> de 4</span>
          <span>|</span>
          <span>üíé Bloque: <strong id="interruption-count" style="color:var(--accent3);">0 interrupciones</strong></span>
        </div>
        <div class="timer-controls">
          <button class="btn btn-ghost" onclick="resetTimer()">‚Ü∫ Reset</button>
          <button class="btn btn-primary" onclick="toggleTimer()" id="timer-btn">‚ñ∂ Iniciar</button>
        </div>
      </div>

      <!-- Session config & interruptions -->
      <div style="display:flex;flex-direction:column;gap:16px;">
        <div class="card">
          <div class="card-title">Configurar sesi√≥n</div>
          <div style="margin-bottom:12px;">
            <div style="font-size:12px;color:var(--text-muted);margin-bottom:6px;font-weight:600;">MATERIA</div>
            <select id="subject-select" style="width:100%;padding:10px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:14px;font-family:inherit;cursor:pointer;" onchange="updateSubject()">
              <option>üìê Matem√°ticas - Derivadas</option>
              <option>üî¨ F√≠sica - Cinem√°tica</option>
              <option>üìñ Historia - Revoluci√≥n Industrial</option>
              <option>üá¨üáß Ingl√©s - Grammar</option>
              <option>üé® Lengua - An√°lisis sint√°ctico</option>
            </select>
          </div>
          <div>
            <div style="font-size:12px;color:var(--text-muted);margin-bottom:6px;font-weight:600;">APPS PERMITIDAS</div>
            <div style="display:flex;flex-direction:column;gap:6px;">
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:13px;">
                <input type="checkbox" checked style="accent-color:var(--accent);">üßÆ Calculadora
              </label>
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:13px;">
                <input type="checkbox" checked style="accent-color:var(--accent);">üìñ Diccionario
              </label>
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:13px;">
                <input type="checkbox" style="accent-color:var(--accent);">üì∑ C√°mara
              </label>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-title">Registro de sesi√≥n</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px;">
            <div style="background:rgba(16,185,129,0.1);border-radius:10px;padding:12px;text-align:center;">
              <div style="font-size:24px;font-weight:900;font-family:'Space Mono',monospace;color:var(--accent3);" id="completed-count">0</div>
              <div style="font-size:11px;color:var(--text-muted);margin-top:2px;font-weight:600;">Pomodoros hoy</div>
            </div>
            <div style="background:rgba(245,158,11,0.1);border-radius:10px;padding:12px;text-align:center;">
              <div style="font-size:24px;font-weight:900;font-family:'Space Mono',monospace;color:var(--focos);" id="session-focos">0</div>
              <div style="font-size:11px;color:var(--text-muted);margin-top:2px;font-weight:600;">Focos ganados</div>
            </div>
          </div>
          <div style="background:rgba(244,63,94,0.08);border:1px solid rgba(244,63,94,0.15);border-radius:10px;padding:12px;">
            <div style="font-size:12px;font-weight:700;color:#fb7185;margin-bottom:6px;">‚ö†Ô∏è Interrupciones detectadas</div>
            <div id="interruption-log" style="font-size:12px;color:var(--text-muted);">Sin interrupciones üíé</div>
          </div>
        </div>

        <div class="card">
          <div class="card-title">Emoci√≥n al terminar</div>
          <div class="emotion-grid" style="grid-template-columns:repeat(3,1fr);">
            <div class="emotion-btn" onclick="selectEmotion(this,'genial')">üòä<span class="emotion-label">Genial</span></div>
            <div class="emotion-btn" onclick="selectEmotion(this,'regular')">üòê<span class="emotion-label">Regular</span></div>
            <div class="emotion-btn" onclick="selectEmotion(this,'costado')">üò´<span class="emotion-label">Cost√≥</span></div>
            <div class="emotion-btn" onclick="selectEmotion(this,'cansado')">üò¥<span class="emotion-label">Cansado</span></div>
            <div class="emotion-btn" onclick="selectEmotion(this,'frustrado')">üò§<span class="emotion-label">Frustrado</span></div>
            <div class="emotion-btn" onclick="selectEmotion(this,'enfocado')">üß†<span class="emotion-label">Enfocado</span></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- ===================== INSIGNIAS ===================== -->
  <main class="main" id="page-badges">
    <div class="page-header">
      <div>
        <div class="page-title">üèÜ Insignias</div>
        <div class="page-subtitle">12 ganadas ¬∑ 18 por desbloquear</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        <span class="pill pill-amber">üîÜ +5 XP al ganar</span>
      </div>
    </div>

    <div class="tab-bar">
      <div class="tab active" onclick="filterBadges('todas',this)">Todas</div>
      <div class="tab" onclick="filterBadges('esfuerzo',this)">Esfuerzo</div>
      <div class="tab" onclick="filterBadges('enfoque',this)">Enfoque</div>
      <div class="tab" onclick="filterBadges('constancia',this)">Constancia</div>
      <div class="tab" onclick="filterBadges('familia',this)">Familia</div>
    </div>

    <div class="badges-grid" id="badges-grid">
      <!-- Ganadas -->
      <div class="badge-item earned" data-cat="esfuerzo">
        <span class="badge-emoji">ü•á</span>
        <div class="badge-name">Primer Paso</div>
        <div class="badge-desc">Primera sesi√≥n</div>
      </div>
      <div class="badge-item earned" data-cat="esfuerzo">
        <span class="badge-emoji">üìÖ</span>
        <div class="badge-name">Semana Completa</div>
        <div class="badge-desc">7 d√≠as planificados</div>
      </div>
      <div class="badge-item earned" data-cat="enfoque">
        <span class="badge-emoji">üíé</span>
        <div class="badge-name">Primer Diamante</div>
        <div class="badge-desc">1 bloque perfecto</div>
      </div>
      <div class="badge-item earned" data-cat="constancia">
        <span class="badge-emoji">üî•</span>
        <div class="badge-name">Llama Inicial</div>
        <div class="badge-desc">Racha de 3 d√≠as</div>
      </div>
      <div class="badge-item earned" data-cat="familia">
        <span class="badge-emoji">ü§ù</span>
        <div class="badge-name">Primer Pacto</div>
        <div class="badge-desc">Pacto cumplido</div>
      </div>
      <div class="badge-item earned" data-cat="enfoque">
        <span class="badge-emoji">üß±</span>
        <div class="badge-name">Muro de Acero</div>
        <div class="badge-desc">5 bloques perfectos</div>
      </div>
      <div class="badge-item earned" data-cat="esfuerzo">
        <span class="badge-emoji">üìê</span>
        <div class="badge-name">Matem√°tico</div>
        <div class="badge-desc">10h de mates</div>
      </div>
      <div class="badge-item earned" data-cat="constancia">
        <span class="badge-emoji">üìÜ</span>
        <div class="badge-name">1 Semana</div>
        <div class="badge-desc">Racha 7 d√≠as</div>
      </div>
      <div class="badge-item earned" data-cat="familia">
        <span class="badge-emoji">üè°</span>
        <div class="badge-name">Familia Unida</div>
        <div class="badge-desc">3 pactos cumplidos</div>
      </div>
      <div class="badge-item earned" data-cat="esfuerzo">
        <span class="badge-emoji">‚≠ê</span>
        <div class="badge-name">Explorador</div>
        <div class="badge-desc">Nivel 2 alcanzado</div>
      </div>
      <div class="badge-item earned" data-cat="enfoque">
        <span class="badge-emoji">üè∞</span>
        <div class="badge-name">Fortaleza</div>
        <div class="badge-desc">10 bloques perfectos</div>
      </div>
      <div class="badge-item earned" data-cat="esfuerzo">
        <span class="badge-emoji">üìñ</span>
        <div class="badge-name">Curioso</div>
        <div class="badge-desc">5 t√©cnicas vistas</div>
      </div>
      <!-- Bloqueadas -->
      <div class="badge-item locked" data-cat="constancia">
        <span class="badge-emoji">üåô</span>
        <div class="badge-name">1 Mes</div>
        <div class="badge-desc">Racha 30 d√≠as</div>
      </div>
      <div class="badge-item locked" data-cat="enfoque">
        <span class="badge-emoji">‚öîÔ∏è</span>
        <div class="badge-name">Invencible</div>
        <div class="badge-desc">20 bloques perfectos</div>
      </div>
      <div class="badge-item locked" data-cat="familia">
        <span class="badge-emoji">üèÖ</span>
        <div class="badge-name">Negociador</div>
        <div class="badge-desc">5 pactos cumplidos</div>
      </div>
      <div class="badge-item locked" data-cat="esfuerzo">
        <span class="badge-emoji">üöÄ</span>
        <div class="badge-name">Maestro</div>
        <div class="badge-desc">Nivel 5 alcanzado</div>
      </div>
      <div class="badge-item locked" data-cat="constancia">
        <span class="badge-emoji">üí´</span>
        <div class="badge-name">Trimestre</div>
        <div class="badge-desc">90 d√≠as de racha</div>
      </div>
      <div class="badge-item locked" data-cat="enfoque">
        <span class="badge-emoji">üëë</span>
        <div class="badge-name">Leyenda</div>
        <div class="badge-desc">50 bloques perfectos</div>
      </div>
    </div>
  </main>

  <!-- ===================== ECONOM√çA ===================== -->
  <main class="main" id="page-economia">
    <div class="page-header">
      <div>
        <div class="page-title">ü™ô Econom√≠a de Focos</div>
        <div class="page-subtitle">Tu moneda de esfuerzo real</div>
      </div>
    </div>

    <div class="economy-header">
      <div class="wallet-icon">üëõ</div>
      <div>
        <div class="wallet-balance" id="wallet-balance">347</div>
        <div class="wallet-label">üîÜ Focos disponibles</div>
      </div>
      <div style="margin-left:32px;">
        <div style="font-size:14px;color:var(--text-muted);font-weight:600;">Cuenta de ahorro</div>
        <div style="font-family:'Space Mono',monospace;font-size:24px;font-weight:700;color:#a78bfa;">125 <span style="font-size:14px;color:var(--text-muted);">/ 500 m√°x.</span></div>
        <div style="font-size:12px;color:var(--accent3);">+1% inter√©s mensual</div>
      </div>
      <div class="wallet-actions">
        <button class="btn btn-ghost">üíæ Ahorrar</button>
        <button class="btn btn-ghost">ü§≤ Pr√©stamo</button>
      </div>
    </div>

    <div class="tab-bar">
      <div class="tab active" onclick="switchEcoTab('catalogo',this)">üõçÔ∏è Cat√°logo</div>
      <div class="tab" onclick="switchEcoTab('historial',this)">üìä Historial</div>
    </div>

    <div id="eco-catalogo">
      <div class="section-title">üéÅ Recompensas disponibles</div>
      <div id="rewards-list">
        <div class="reward-item">
          <div class="reward-emoji">üçï</div>
          <div class="reward-info">
            <div class="reward-name">Elegir la cena</div>
            <div class="reward-desc">T√∫ decides qu√© cena la familia esta noche</div>
          </div>
          <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;">
            <span class="reward-cat small">Peque√±a</span>
            <div class="reward-cost">üîÜ 30</div>
          </div>
          <button class="btn btn-primary" style="padding:8px 16px;font-size:13px;" onclick="canjear('Elegir la cena',30)">Canjear</button>
        </div>
        <div class="reward-item">
          <div class="reward-emoji">üéÆ</div>
          <div class="reward-info">
            <div class="reward-name">+30 min extra de juego</div>
            <div class="reward-desc">Media hora m√°s de gaming o redes sociales</div>
          </div>
          <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;">
            <span class="reward-cat small">Peque√±a</span>
            <div class="reward-cost">üîÜ 50</div>
          </div>
          <button class="btn btn-primary" style="padding:8px 16px;font-size:13px;" onclick="canjear('+30 min juego',50)">Canjear</button>
        </div>
        <div class="reward-item">
          <div class="reward-emoji">üé¨</div>
          <div class="reward-info">
            <div class="reward-name">Noche de cine en casa</div>
            <div class="reward-desc">Eliges la pel√≠cula y los snacks</div>
          </div>
          <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;">
            <span class="reward-cat medium">Mediana</span>
            <div class="reward-cost">üîÜ 100</div>
          </div>
          <button class="btn btn-primary" style="padding:8px 16px;font-size:13px;" onclick="canjear('Noche de cine',100)">Canjear</button>
        </div>
        <div class="reward-item">
          <div class="reward-emoji">üëü</div>
          <div class="reward-info">
            <div class="reward-name">Ropa o accesorio</div>
            <div class="reward-desc">Una prenda o accesorio a elegir</div>
          </div>
          <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;">
            <span class="reward-cat big">Grande</span>
            <div class="reward-cost">üîÜ 300</div>
          </div>
          <button class="btn btn-ghost" style="padding:8px 16px;font-size:13px;opacity:0.5;cursor:not-allowed;">No alcanza</button>
        </div>
        <div class="reward-item">
          <div class="reward-emoji">üèïÔ∏è</div>
          <div class="reward-info">
            <div class="reward-name">Excursi√≥n con amigos</div>
            <div class="reward-desc">Un d√≠a de excursi√≥n o escapada</div>
          </div>
          <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;">
            <span class="reward-cat big">Grande</span>
            <div class="reward-cost">üîÜ 500</div>
          </div>
          <button class="btn btn-ghost" style="padding:8px 16px;font-size:13px;opacity:0.5;cursor:not-allowed;">No alcanza</button>
        </div>
      </div>
    </div>

    <div id="eco-historial" style="display:none;">
      <div class="section-title">üìä Movimientos</div>
      <div style="display:flex;flex-direction:column;gap:8px;">
        <div style="display:flex;align-items:center;gap:12px;padding:14px;background:rgba(16,185,129,0.08);border:1px solid rgba(16,185,129,0.15);border-radius:12px;">
          <span style="font-size:20px;">üíé</span>
          <div style="flex:1;"><div style="font-size:14px;font-weight:700;">Bloque perfecto - Matem√°ticas</div><div style="font-size:12px;color:var(--text-muted);">Hoy ¬∑ 16:30</div></div>
          <div style="font-family:'Space Mono',monospace;font-weight:700;color:var(--accent3);">+15 üîÜ</div>
        </div>
        <div style="display:flex;align-items:center;gap:12px;padding:14px;background:rgba(16,185,129,0.08);border:1px solid rgba(16,185,129,0.15);border-radius:12px;">
          <span style="font-size:20px;">üìÖ</span>
          <div style="flex:1;"><div style="font-size:14px;font-weight:700;">Planificaci√≥n semanal</div><div style="font-size:12px;color:var(--text-muted);">Lun 17 Feb</div></div>
          <div style="font-family:'Space Mono',monospace;font-weight:700;color:var(--accent3);">+10 üîÜ</div>
        </div>
        <div style="display:flex;align-items:center;gap:12px;padding:14px;background:rgba(16,185,129,0.08);border:1px solid rgba(16,185,129,0.15);border-radius:12px;">
          <span style="font-size:20px;">ü§ù</span>
          <div style="flex:1;"><div style="font-size:14px;font-weight:700;">Pacto semanal cumplido</div><div style="font-size:12px;color:var(--text-muted);">Dom 16 Feb</div></div>
          <div style="font-family:'Space Mono',monospace;font-weight:700;color:var(--accent3);">+20 üîÜ</div>
        </div>
        <div style="display:flex;align-items:center;gap:12px;padding:14px;background:rgba(244,63,94,0.06);border:1px solid rgba(244,63,94,0.12);border-radius:12px;">
          <span style="font-size:20px;">üé¨</span>
          <div style="flex:1;"><div style="font-size:14px;font-weight:700;">Noche de cine canjeada</div><div style="font-size:12px;color:var(--text-muted);">S√°b 15 Feb</div></div>
          <div style="font-family:'Space Mono',monospace;font-weight:700;color:#fb7185;">-100 üîÜ</div>
        </div>
      </div>
    </div>
  </main>

  <!-- ===================== PACTOS ===================== -->
  <main class="main" id="page-pactos">
    <div class="page-header">
      <div>
        <div class="page-title">ü§ù Rinc√≥n de Pactos</div>
        <div class="page-subtitle">Acuerdos entre el alumno y la familia</div>
      </div>
      <button class="btn btn-primary" style="display:flex;align-items:center;gap:8px;" onclick="openPactoModal()">
        + Proponer pacto
      </button>
    </div>

    <!-- TABS -->
    <div class="tab-bar">
      <div class="tab active" onclick="switchPactoTab('activos',this)">üü¢ En curso <span id="tab-badge-activos" style="background:var(--accent);color:white;font-size:10px;padding:2px 7px;border-radius:20px;margin-left:4px;">2</span></div>
      <div class="tab" onclick="switchPactoTab('propuestos',this)">üÜï Propuestos <span id="tab-badge-propuestos" style="background:var(--focos);color:#0a0a0f;font-size:10px;padding:2px 7px;border-radius:20px;margin-left:4px;">1</span></div>
      <div class="tab" onclick="switchPactoTab('completados',this)">‚úÖ Completados</div>
    </div>

    <!-- EN CURSO -->
    <div id="pt-activos">
      <div style="display:flex;flex-direction:column;gap:12px;" id="pactos-activos-list"></div>
    </div>

    <!-- PROPUESTOS -->
    <div id="pt-propuestos" style="display:none;">
      <div style="font-size:13px;color:var(--text-muted);margin-bottom:16px;line-height:1.6;">
        Pactos esperando respuesta del alumno. Puedes editarlos antes de que los acepte.
      </div>
      <div style="display:flex;flex-direction:column;gap:12px;" id="pactos-propuestos-list"></div>
    </div>

    <!-- COMPLETADOS -->
    <div id="pt-completados" style="display:none;">
      <div style="display:flex;flex-direction:column;gap:10px;" id="pactos-completados-list"></div>
    </div>
  </main>

  <!-- PACTO MODAL -->
  <div id="pacto-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:600;align-items:center;justify-content:center;" onclick="if(event.target===this)closePactoModal()">
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:28px;max-width:500px;width:92%;max-height:90vh;overflow-y:auto;position:relative;animation:fadeIn 0.2s ease;" onclick="event.stopPropagation()">

      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:22px;">
        <div style="font-size:18px;font-weight:900;" id="pacto-modal-title">Nuevo pacto</div>
        <div style="display:flex;gap:8px;align-items:center;">
          <button id="btn-delete-pacto" style="display:none;background:rgba(244,63,94,0.12);border:1px solid rgba(244,63,94,0.3);color:#fb7185;border-radius:8px;padding:6px 12px;font-size:12px;font-weight:700;cursor:pointer;" onclick="deletePacto()">üóëÔ∏è Eliminar</button>
          <span style="cursor:pointer;font-size:20px;color:var(--text-muted);padding:4px 8px;" onclick="closePactoModal()">‚úï</span>
        </div>
      </div>

      <!-- T√≠tulo del pacto -->
      <div style="font-size:12px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">T√≠tulo del pacto</div>
      <input id="pacto-title-input" class="ob-input" type="text" placeholder="ej: Semana de Matem√°ticas" style="margin-bottom:16px;" />

      <!-- Objetivo / condici√≥n -->
      <div style="font-size:12px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">Objetivo (qu√© tiene que hacer el alumno)</div>
      <input id="pacto-goal-input" class="ob-input" type="text" placeholder="ej: 4 bloques de mates sin interrupciones" style="margin-bottom:16px;" />

      <!-- Tipo de objetivo -->
      <div style="font-size:12px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;">Tipo de reto</div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px;" id="pacto-type-selector">
        <div onclick="selectPactoType('bloques',this)" class="pacto-type-opt" data-ptype="bloques"
          style="padding:12px 6px;border-radius:10px;border:2px solid rgba(124,58,237,0.3);background:rgba(124,58,237,0.1);text-align:center;cursor:pointer;transition:all 0.15s;">
          <div style="font-size:20px;">üì¶</div>
          <div style="font-size:11px;font-weight:700;color:#a78bfa;margin-top:4px;">Bloques</div>
          <div style="font-size:10px;color:var(--text-muted);">N bloques de estudio</div>
        </div>
        <div onclick="selectPactoType('dias',this)" class="pacto-type-opt" data-ptype="dias"
          style="padding:12px 6px;border-radius:10px;border:2px solid rgba(16,185,129,0.3);background:rgba(16,185,129,0.1);text-align:center;cursor:pointer;transition:all 0.15s;">
          <div style="font-size:20px;">üìÖ</div>
          <div style="font-size:11px;font-weight:700;color:var(--accent3);margin-top:4px;">D√≠as seguidos</div>
          <div style="font-size:10px;color:var(--text-muted);">Racha de N d√≠as</div>
        </div>
        <div onclick="selectPactoType('libre',this)" class="pacto-type-opt" data-ptype="libre"
          style="padding:12px 6px;border-radius:10px;border:2px solid rgba(245,158,11,0.3);background:rgba(245,158,11,0.1);text-align:center;cursor:pointer;transition:all 0.15s;">
          <div style="font-size:20px;">‚ú®</div>
          <div style="font-size:11px;font-weight:700;color:var(--focos);margin-top:4px;">Libre</div>
          <div style="font-size:10px;color:var(--text-muted);">Objetivo personalizado</div>
        </div>
      </div>

      <!-- Meta num√©rica -->
      <div id="pacto-target-row" style="display:flex;gap:16px;align-items:center;margin-bottom:16px;">
        <div style="flex:1;">
          <div style="font-size:12px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">Meta</div>
          <input id="pacto-target-input" class="ob-input" type="number" min="1" max="60" placeholder="ej: 4" style="margin:0;" />
        </div>
        <div style="flex:1;">
          <div style="font-size:12px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">Plazo</div>
          <select id="pacto-deadline-input" class="ob-input" style="margin:0;cursor:pointer;">
            <option>Esta semana</option>
            <option>2 semanas</option>
            <option>Este mes</option>
            <option>Este trimestre</option>
          </select>
        </div>
      </div>

      <!-- Recompensa -->
      <div style="font-size:12px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">Recompensa para el alumno</div>
      <input id="pacto-reward-input" class="ob-input" type="text" placeholder="ej: Noche de cine en casa" style="margin-bottom:10px;" />

      <!-- Focos bonus -->
      <div style="display:flex;align-items:center;gap:16px;margin-bottom:20px;">
        <div style="flex:1;">
          <div style="font-size:12px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">Focos extra al completar</div>
          <input type="range" min="0" max="500" step="10" value="100" id="pacto-focos-slider"
            style="width:100%;accent-color:var(--accent);cursor:pointer;"
            oninput="document.getElementById('pacto-focos-display').textContent=this.value" />
        </div>
        <div style="font-family:Space Mono,monospace;font-size:28px;font-weight:700;color:var(--focos);text-align:center;min-width:80px;">
          <span id="pacto-focos-display">100</span><br>
          <span style="font-size:14px;">üîÜ</span>
        </div>
      </div>

      <!-- Nota opcional -->
      <div style="font-size:12px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">Mensaje para el alumno (opcional)</div>
      <input id="pacto-note-input" class="ob-input" type="text" placeholder="ej: Sabemos que puedes, √°nimo!" style="margin-bottom:24px;" />

      <div style="display:flex;gap:10px;">
        <button class="btn btn-ghost" style="flex:1;" onclick="closePactoModal()">Cancelar</button>
        <button class="btn btn-primary" style="flex:2;padding:14px;" onclick="savePacto()">
          <span id="save-pacto-label">Enviar pacto al alumno</span>
        </button>
      </div>
    </div>
  </div>


  <!-- ===================== T√âCNICAS ===================== -->
  <main class="main" id="page-tecnicas">
    <div class="page-header">
      <div>
        <div class="page-title">üìö Biblioteca de T√©cnicas</div>
        <div class="page-subtitle">Aprende a estudiar mejor</div>
      </div>
    </div>
    <div class="grid-2">
      <div class="card" style="cursor:pointer;transition:all 0.2s;" onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform=''" onclick="showToast('üçÖ','T√©cnica Pomodoro','¬°Abierta! Trabaja 25min, descansa 5min.')">
        <div style="font-size:40px;margin-bottom:12px;">üçÖ</div>
        <div style="font-size:17px;font-weight:800;margin-bottom:6px;">T√©cnica Pomodoro</div>
        <div style="font-size:13px;color:var(--text-muted);line-height:1.6;">Bloques de 25 minutos de concentraci√≥n intensa seguidos de descansos de 5 minutos. La t√©cnica m√°s efectiva para mantener el foco.</div>
        <div style="margin-top:16px;display:flex;align-items:center;justify-content:space-between;">
          <span class="pill pill-green">‚è±Ô∏è 5 min leer</span>
          <span class="pill pill-purple">Integrada en la app</span>
        </div>
      </div>
      <div class="card" style="cursor:pointer;transition:all 0.2s;" onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform=''" onclick="showToast('üó∫Ô∏è','Mapas Mentales','Conecta ideas visualmente para recordar mejor.')">
        <div style="font-size:40px;margin-bottom:12px;">üó∫Ô∏è</div>
        <div style="font-size:17px;font-weight:800;margin-bottom:6px;">Mapas Mentales</div>
        <div style="font-size:13px;color:var(--text-muted);line-height:1.6;">Organiza visualmente las ideas conectando conceptos con ramas. Perfecto para memorizar temas complejos de Historia o Lengua.</div>
        <div style="margin-top:16px;display:flex;align-items:center;justify-content:space-between;">
          <span class="pill pill-green">‚è±Ô∏è 8 min leer</span>
          <span class="pill pill-amber">Muy recomendada</span>
        </div>
      </div>
      <div class="card" style="cursor:pointer;transition:all 0.2s;" onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform=''">
        <div style="font-size:40px;margin-bottom:12px;">üÉè</div>
        <div style="font-size:17px;font-weight:800;margin-bottom:6px;">Flashcards</div>
        <div style="font-size:13px;color:var(--text-muted);line-height:1.6;">Tarjetas de pregunta-respuesta para memorizar conceptos, vocabulario o f√≥rmulas. El sistema de repetici√≥n espaciada multiplica la retenci√≥n.</div>
        <div style="margin-top:16px;"><span class="pill pill-green">‚è±Ô∏è 6 min leer</span></div>
      </div>
      <div class="card" style="cursor:pointer;transition:all 0.2s;" onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform=''">
        <div style="font-size:40px;margin-bottom:12px;">‚úèÔ∏è</div>
        <div style="font-size:17px;font-weight:800;margin-bottom:6px;">Subrayado activo</div>
        <div style="font-size:13px;color:var(--text-muted);line-height:1.6;">No subrayar todo: solo lo esencial. Usa colores para diferenciar ideas principales, secundarias y ejemplos. Transforma el texto en un esquema visual.</div>
        <div style="margin-top:16px;"><span class="pill pill-green">‚è±Ô∏è 5 min leer</span></div>
      </div>
      <div class="card" style="cursor:pointer;transition:all 0.2s;" onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform=''">
        <div style="font-size:40px;margin-bottom:12px;">üß†</div>
        <div style="font-size:17px;font-weight:800;margin-bottom:6px;">Reglas mnemot√©cnicas</div>
        <div style="font-size:13px;color:var(--text-muted);line-height:1.6;">Trucos y rimas para recordar listas, fechas y f√≥rmulas. "Mi Vieja T√≠a Marta Jam√°s Supo Una Nota" para los planetas.</div>
        <div style="margin-top:16px;"><span class="pill pill-green">‚è±Ô∏è 7 min leer</span></div>
      </div>
      <div class="card" style="cursor:pointer;transition:all 0.2s;" onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform=''">
        <div style="font-size:40px;margin-bottom:12px;">üìä</div>
        <div style="font-size:17px;font-weight:800;margin-bottom:6px;">M√©todo Cornell</div>
        <div style="font-size:13px;color:var(--text-muted);line-height:1.6;">Sistema de toma de apuntes en 3 columnas: notas, preguntas clave y resumen. Muy efectivo para clases con mucha informaci√≥n nueva.</div>
        <div style="margin-top:16px;"><span class="pill pill-green">‚è±Ô∏è 9 min leer</span></div>
      </div>
    </div>
  </main>

  <!-- ===================== PADRES VIEW ===================== -->
  <main class="main" id="page-padres">
    <div class="page-header">
      <div>
        <div class="page-title">üë®‚Äçüë©‚Äçüë¶ Panel Familiar</div>
        <div class="page-subtitle">Resumen de la semana ¬∑ Vista de acompa√±amiento</div>
      </div>
      <div style="background:rgba(16,185,129,0.15);border:1px solid rgba(16,185,129,0.3);border-radius:10px;padding:8px 16px;font-size:12px;font-weight:700;color:var(--accent3);">
        üîí Privacidad activada
      </div>
    </div>

    <div class="parent-header">
      <div class="child-avatar">üë¶</div>
      <div>
        <div style="font-size:20px;font-weight:800;">Alejandro, 15 a√±os</div>
        <div style="font-size:13px;color:var(--text-muted);margin-top:2px;">1¬∫ Bachillerato ¬∑ Semana del 17-23 Feb</div>
      </div>
      <div style="margin-left:auto;">
        <div class="pill pill-green">üî• Racha 5 d√≠as</div>
      </div>
    </div>

    <div style="font-size:11px;color:var(--text-muted);font-weight:700;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:12px;">Resumen semanal</div>
    <div class="weekly-summary">
      <div class="summary-mini">
        <div class="summary-mini-val" style="color:#a78bfa;">12</div>
        <div class="summary-mini-label">Bloques realizados</div>
      </div>
      <div class="summary-mini">
        <div class="summary-mini-val" style="color:var(--accent3);">8</div>
        <div class="summary-mini-label">Sin interrupciones</div>
      </div>
      <div class="summary-mini">
        <div class="summary-mini-val" style="color:var(--focos);">347</div>
        <div class="summary-mini-label">Focos ganados</div>
      </div>
      <div class="summary-mini">
        <div class="summary-mini-val" style="color:#fb7185;">3</div>
        <div class="summary-mini-label">Pactos activos</div>
      </div>
    </div>

    <!-- Tendencia emocional -->
    <div class="card" style="margin-bottom:24px;">
      <div class="card-title">Tendencia emocional de la semana</div>
      <div style="display:flex;gap:16px;align-items:center;">
        <div style="display:flex;gap:8px;">
          <span style="font-size:24px;" title="Lunes">üòä</span>
          <span style="font-size:24px;" title="Martes">üòê</span>
          <span style="font-size:24px;" title="Mi√©rcoles">üòä</span>
          <span style="font-size:24px;" title="Jueves">üò´</span>
          <span style="font-size:24px;" title="Viernes">üß†</span>
        </div>
        <div style="font-size:13px;color:var(--text-muted);line-height:1.6;">
          Semana mayoritariamente positiva. El jueves tuvo m√°s dificultades ‚Äî podr√≠a ser un buen momento para preguntar c√≥mo fue ese d√≠a.
        </div>
      </div>
    </div>

    <!-- Sugerencias de di√°logo -->
    <div class="section-title">üí¨ Sugerencias de di√°logo</div>
    <div class="dialog-suggestion">
      <div class="dialog-icon">üí°</div>
      <div class="dialog-text">"Veo que has tenido una semana intensa de Matem√°ticas, ¬øc√≥mo te ha ido con las derivadas?"</div>
    </div>
    <div class="dialog-suggestion">
      <div class="dialog-icon">üî•</div>
      <div class="dialog-text">"¬°Llevas 5 d√≠as seguidos estudiando! ¬øC√≥mo lo est√°s llevando? ¬øNecesitas algo?"</div>
    </div>
    <div class="dialog-suggestion">
      <div class="dialog-icon">üò´</div>
      <div class="dialog-text">"El jueves parece que fue un d√≠a dif√≠cil. ¬øQuieres contarme algo?"</div>
    </div>

    <div style="margin-top:24px;padding:16px;background:rgba(124,58,237,0.08);border:1px solid rgba(124,58,237,0.15);border-radius:12px;font-size:13px;color:var(--text-muted);line-height:1.6;">
      <strong style="color:#a78bfa;">üîí Privacidad:</strong> No ves qu√© apps usa, ni el contenido de sus estudios, ni sus conversaciones. Solo res√∫menes semanales agregados para poder acompa√±arle mejor.
    </div>
  </main>

  <!-- ===================== GESTOR DE RECOMPENSAS (PADRES) ===================== -->
  <main class="main" id="page-recompensas">
    <div class="page-header">
      <div>
        <div class="page-title">üéÅ Gestor de Recompensas</div>
        <div class="page-subtitle">Define el cat√°logo de recompensas y su coste en Focos</div>
      </div>
      <button class="btn btn-primary" style="display:flex;align-items:center;gap:8px;" onclick="openRewardModal()">
        + Nueva recompensa
      </button>
    </div>

    <!-- BALANCE HIJO -->
    <div style="background:linear-gradient(135deg,rgba(245,158,11,0.12),rgba(245,158,11,0.04));border:1px solid rgba(245,158,11,0.25);border-radius:16px;padding:20px;margin-bottom:24px;display:flex;align-items:center;gap:20px;">
      <div style="font-size:40px;">üë¶</div>
      <div>
        <div style="font-size:14px;color:var(--text-muted);font-weight:600;">Saldo actual de Alejandro</div>
        <div style="font-size:36px;font-weight:900;color:var(--focos);font-family:Space Mono,monospace;">347 <span style="font-size:18px;">üîÜ</span></div>
      </div>
      <div style="margin-left:auto;text-align:right;">
        <div style="font-size:13px;color:var(--text-muted);">Gastado este mes</div>
        <div style="font-size:22px;font-weight:800;color:#fb7185;font-family:Space Mono,monospace;">-100 üîÜ</div>
      </div>
    </div>

    <!-- TABS -->
    <div class="tab-bar">
      <div class="tab active" onclick="switchRewardTab('catalogo',this)">üìã Cat√°logo activo</div>
      <div class="tab" onclick="switchRewardTab('solicitudes',this)">üîî Solicitudes <span style="background:var(--accent4);color:white;font-size:10px;padding:2px 6px;border-radius:20px;margin-left:4px;">2</span></div>
      <div class="tab" onclick="switchRewardTab('historial',this)">üìä Historial</div>
    </div>

    <!-- CAT√ÅLOGO -->
    <div id="rw-catalogo">
      <div style="font-size:13px;color:var(--text-muted);margin-bottom:16px;line-height:1.6;">
        Estas son las recompensas que Alejandro puede canjear. Puedes editarlas, desactivarlas o a√±adir nuevas en cualquier momento.
      </div>
      <div style="display:flex;flex-direction:column;gap:10px;" id="rewards-catalog-list"></div>
    </div>

    <!-- SOLICITUDES -->
    <div id="rw-solicitudes" style="display:none;">
      <div style="font-size:13px;color:var(--text-muted);margin-bottom:16px;">Alejandro ha solicitado estas recompensas. Apru√©balas o rech√°zalas.</div>
      <div style="display:flex;flex-direction:column;gap:12px;" id="reward-requests-list"></div>
    </div>

    <!-- HISTORIAL -->
    <div id="rw-historial" style="display:none;">
      <div style="display:flex;flex-direction:column;gap:8px;" id="reward-history-list"></div>
    </div>

    <!-- MODAL CREAR/EDITAR RECOMPENSA -->
    <div id="reward-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:500;align-items:center;justify-content:center;" onclick="if(event.target===this)closeRewardModal()">
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:32px;max-width:460px;width:90%;position:relative;" onclick="event.stopPropagation()">
        <div style="font-size:20px;font-weight:900;margin-bottom:24px;" id="modal-title">Nueva recompensa</div>

        <!-- Emoji picker -->
        <div style="font-size:13px;font-weight:700;color:var(--text-muted);margin-bottom:8px;text-transform:uppercase;letter-spacing:1px;">Icono</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px;" id="emoji-picker">
          <span onclick="selectEmoji(this)" style="font-size:28px;cursor:pointer;padding:8px;border-radius:10px;border:2px solid transparent;transition:all 0.15s;" class="emoji-opt">üçï</span>
          <span onclick="selectEmoji(this)" style="font-size:28px;cursor:pointer;padding:8px;border-radius:10px;border:2px solid transparent;transition:all 0.15s;" class="emoji-opt">üéÆ</span>
          <span onclick="selectEmoji(this)" style="font-size:28px;cursor:pointer;padding:8px;border-radius:10px;border:2px solid transparent;transition:all 0.15s;" class="emoji-opt">üé¨</span>
          <span onclick="selectEmoji(this)" style="font-size:28px;cursor:pointer;padding:8px;border-radius:10px;border:2px solid transparent;transition:all 0.15s;" class="emoji-opt">üõçÔ∏è</span>
          <span onclick="selectEmoji(this)" style="font-size:28px;cursor:pointer;padding:8px;border-radius:10px;border:2px solid transparent;transition:all 0.15s;" class="emoji-opt">üëü</span>
          <span onclick="selectEmoji(this)" style="font-size:28px;cursor:pointer;padding:8px;border-radius:10px;border:2px solid transparent;transition:all 0.15s;" class="emoji-opt">üèïÔ∏è</span>
          <span onclick="selectEmoji(this)" style="font-size:28px;cursor:pointer;padding:8px;border-radius:10px;border:2px solid transparent;transition:all 0.15s;" class="emoji-opt">üéµ</span>
          <span onclick="selectEmoji(this)" style="font-size:28px;cursor:pointer;padding:8px;border-radius:10px;border:2px solid transparent;transition:all 0.15s;" class="emoji-opt">üìö</span>
          <span onclick="selectEmoji(this)" style="font-size:28px;cursor:pointer;padding:8px;border-radius:10px;border:2px solid transparent;transition:all 0.15s;" class="emoji-opt">üç¶</span>
          <span onclick="selectEmoji(this)" style="font-size:28px;cursor:pointer;padding:8px;border-radius:10px;border:2px solid transparent;transition:all 0.15s;" class="emoji-opt">üéâ</span>
          <span onclick="selectEmoji(this)" style="font-size:28px;cursor:pointer;padding:8px;border-radius:10px;border:2px solid transparent;transition:all 0.15s;" class="emoji-opt">üö¥</span>
          <span onclick="selectEmoji(this)" style="font-size:28px;cursor:pointer;padding:8px;border-radius:10px;border:2px solid transparent;transition:all 0.15s;" class="emoji-opt">üíÜ</span>
        </div>

        <!-- Name -->
        <div style="font-size:13px;font-weight:700;color:var(--text-muted);margin-bottom:8px;text-transform:uppercase;letter-spacing:1px;">Nombre</div>
        <input class="ob-input" type="text" placeholder="ej: Noche de cine en casa" id="rw-name" style="margin-bottom:16px;" />

        <!-- Description -->
        <div style="font-size:13px;font-weight:700;color:var(--text-muted);margin-bottom:8px;text-transform:uppercase;letter-spacing:1px;">Descripci√≥n (opcional)</div>
        <input class="ob-input" type="text" placeholder="ej: Eliges la pel√≠cula y los snacks" id="rw-desc" style="margin-bottom:16px;" />

        <!-- Cost slider -->
        <div style="font-size:13px;font-weight:700;color:var(--text-muted);margin-bottom:8px;text-transform:uppercase;letter-spacing:1px;">Coste en Focos</div>
        <div style="display:flex;align-items:center;gap:16px;margin-bottom:8px;">
          <input type="range" min="10" max="500" step="5" value="100" id="rw-cost-slider"
            style="flex:1;accent-color:var(--accent);cursor:pointer;"
            oninput="document.getElementById('rw-cost-display').textContent=this.value" />
          <div style="font-family:Space Mono,monospace;font-size:28px;font-weight:700;color:var(--focos);min-width:80px;text-align:right;">
            <span id="rw-cost-display">100</span> <span style="font-size:16px;">üîÜ</span>
          </div>
        </div>
        <!-- Cost presets -->
        <div style="display:flex;gap:6px;margin-bottom:20px;">
          <button class="btn btn-ghost" style="font-size:11px;padding:4px 10px;" onclick="setCost(30)">30 Peque√±a</button>
          <button class="btn btn-ghost" style="font-size:11px;padding:4px 10px;" onclick="setCost(100)">100 Mediana</button>
          <button class="btn btn-ghost" style="font-size:11px;padding:4px 10px;" onclick="setCost(300)">300 Grande</button>
          <button class="btn btn-ghost" style="font-size:11px;padding:4px 10px;" onclick="setCost(500)">500 Extra</button>
        </div>

        <!-- Category -->
        <div style="font-size:13px;font-weight:700;color:var(--text-muted);margin-bottom:8px;text-transform:uppercase;letter-spacing:1px;">Categor√≠a</div>
        <div style="display:flex;gap:8px;margin-bottom:24px;" id="cat-picker">
          <div onclick="selectCat(this,'small')" style="flex:1;padding:10px;border-radius:10px;border:2px solid rgba(16,185,129,0.3);background:rgba(16,185,129,0.08);text-align:center;cursor:pointer;font-size:12px;font-weight:700;color:var(--accent3);transition:all 0.2s;" class="cat-opt">üü¢ Peque√±a</div>
          <div onclick="selectCat(this,'medium')" style="flex:1;padding:10px;border-radius:10px;border:2px solid rgba(124,58,237,0.3);background:rgba(124,58,237,0.08);text-align:center;cursor:pointer;font-size:12px;font-weight:700;color:#a78bfa;transition:all 0.2s;" class="cat-opt">üü£ Mediana</div>
          <div onclick="selectCat(this,'big')" style="flex:1;padding:10px;border-radius:10px;border:2px solid rgba(244,63,94,0.3);background:rgba(244,63,94,0.08);text-align:center;cursor:pointer;font-size:12px;font-weight:700;color:#fb7185;transition:all 0.2s;" class="cat-opt">üî¥ Grande</div>
        </div>

        <div style="display:flex;gap:10px;">
          <button class="btn btn-ghost" style="flex:1;" onclick="closeRewardModal()">Cancelar</button>
          <button class="btn btn-primary" style="flex:2;" onclick="saveReward()">Guardar recompensa</button>
        </div>

        <div style="position:absolute;top:16px;right:16px;cursor:pointer;font-size:20px;color:var(--text-muted);" onclick="closeRewardModal()">‚úï</div>
      </div>
    </div>
  </main>
</div>

  <!-- ===================== IA PERSONAL ===================== -->
  <main class="main" id="page-ia">
    <div class="page-header">
      <div>
        <div class="page-title">üß† IA Personal</div>
        <div class="page-subtitle">Consejos del dia basados en como estudias</div>
      </div>
      <div style="background:linear-gradient(135deg,rgba(124,58,237,0.2),rgba(245,158,11,0.1));border:1px solid rgba(124,58,237,0.3);border-radius:10px;padding:10px 16px;font-size:12px;font-weight:700;color:#a78bfa;">38 sesiones analizadas</div>
    </div>

    <!-- NOTIFICACION DEL DIA - PRINCIPAL -->
    <div style="background:linear-gradient(135deg,rgba(124,58,237,0.18),rgba(245,158,11,0.1));border:1px solid rgba(124,58,237,0.4);border-radius:20px;padding:28px;margin-bottom:24px;position:relative;overflow:hidden;">
      <div style="position:absolute;top:-30px;right:-30px;font-size:120px;opacity:0.05;">üí°</div>
      <div style="display:flex;align-items:flex-start;gap:16px;">
        <div style="width:52px;height:52px;background:linear-gradient(135deg,#7c3aed,#f59e0b);border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:26px;flex-shrink:0;box-shadow:0 0 20px rgba(124,58,237,0.4);">üí°</div>
        <div style="flex:1;">
          <div style="font-size:11px;font-weight:700;color:#a78bfa;text-transform:uppercase;letter-spacing:2px;margin-bottom:8px;">Consejo de hoy - Viernes 21 Feb</div>
          <div style="font-size:20px;font-weight:900;margin-bottom:10px;line-height:1.3;">Hoy es tu mejor dia para Matematicas ‚Äî empieza a las 16:30</div>
          <div style="font-size:14px;color:var(--text-muted);line-height:1.7;margin-bottom:16px;">Los viernes de tarde son tu franja con menos interrupciones historicamente. Tienes el examen en 3 dias, es el momento ideal para el repaso final de derivadas.</div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <button class="btn btn-primary" style="font-size:13px;padding:10px 20px;" onclick="addSuggestedBlock()">Anadir bloque al planificador</button>
            <button class="btn btn-ghost" style="font-size:13px;padding:10px 20px;" onclick="showToast('üí°','Consejo descartado','Te llegara otro manana')">Descartar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- FEED DE NOTIFICACIONES -->
    <div class="section-title">Notificaciones de hoy</div>
    <div style="display:flex;flex-direction:column;gap:10px;margin-bottom:28px;" id="notif-feed">
      <!-- generado por JS -->
    </div>

    <!-- HISTORIAL DE CONSEJOS -->
    <div class="section-title">Consejos de esta semana</div>
    <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:28px;" id="advice-history">
      <!-- generado por JS -->
    </div>

    <!-- PREFERENCIAS -->
    <div class="section-title">Configurar notificaciones</div>
    <div class="card">
      <div style="display:flex;flex-direction:column;gap:18px;">
        <div style="display:flex;justify-content:space-between;align-items:center;padding-bottom:16px;border-bottom:1px solid var(--border);">
          <div><div style="font-size:14px;font-weight:700;">Consejo del dia</div><div style="font-size:12px;color:var(--text-muted);margin-top:2px;">Un insight personalizado cada manana</div></div>
          <div class="toggle-switch on" onclick="toggleSwitch(this)"><div class="toggle-knob"></div></div>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;padding-bottom:16px;border-bottom:1px solid var(--border);">
          <div><div style="font-size:14px;font-weight:700;">Alerta de franja optima</div><div style="font-size:12px;color:var(--text-muted);margin-top:2px;">Aviso cuando empieza tu mejor hora para estudiar</div></div>
          <div class="toggle-switch on" onclick="toggleSwitch(this)"><div class="toggle-knob"></div></div>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;padding-bottom:16px;border-bottom:1px solid var(--border);">
          <div><div style="font-size:14px;font-weight:700;">Patron detectado</div><div style="font-size:12px;color:var(--text-muted);margin-top:2px;">Cuando la IA detecta algo relevante en tu comportamiento</div></div>
          <div class="toggle-switch on" onclick="toggleSwitch(this)"><div class="toggle-knob"></div></div>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;padding-bottom:16px;border-bottom:1px solid var(--border);">
          <div><div style="font-size:14px;font-weight:700;">Celebracion de mejora</div><div style="font-size:12px;color:var(--text-muted);margin-top:2px;">Cuando superas una de tus marcas personales</div></div>
          <div class="toggle-switch on" onclick="toggleSwitch(this)"><div class="toggle-knob"></div></div>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div><div style="font-size:14px;font-weight:700;">Hora de envio</div><div style="font-size:12px;color:var(--text-muted);margin-top:2px;">Cuando recibir el consejo del dia</div></div>
          <select style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;padding:8px 12px;font-family:inherit;cursor:pointer;">
            <option>07:30 (al levantarse)</option>
            <option>08:00</option>
            <option selected>15:30 (al salir del cole)</option>
            <option>16:00</option>
          </select>
        </div>
      </div>
    </div>
  </main>

    <!-- ===================== EXAMENES ===================== -->
  <main class="main" id="page-examenes">
    <div class="page-header">
      <div><div class="page-title">Examenes</div><div class="page-subtitle">Modo examen y predictor de rendimiento</div></div>
    </div>
    <div class="section-title">Proximos examenes</div>
    <div style="display:flex;flex-direction:column;gap:12px;margin-bottom:28px;" id="exams-list"></div>
    <div class="section-title">Predictor de rendimiento</div>
    <div style="background:linear-gradient(135deg,rgba(124,58,237,0.1),rgba(16,185,129,0.05));border:1px solid var(--border);border-radius:20px;padding:24px;margin-bottom:24px;">
      <div style="font-size:13px;color:var(--text-muted);margin-bottom:16px;line-height:1.6;">Basado en horas de estudio y bloques perfectos antes de cada examen anterior:</div>
      <div style="display:flex;flex-direction:column;gap:12px;" id="predictor-list"></div>
      <div style="margin-top:16px;padding:12px;background:rgba(255,255,255,0.03);border-radius:10px;font-size:12px;color:var(--text-muted);">No predice tu nota, solo mide tu esfuerzo relativo.</div>
    </div>
    <div class="section-title">Activar Modo Examen</div>
    <div style="background:linear-gradient(135deg,rgba(244,63,94,0.1),rgba(244,63,94,0.03));border:1px solid rgba(244,63,94,0.25);border-radius:16px;padding:20px;">
      <div style="display:flex;align-items:center;gap:16px;margin-bottom:16px;"><div style="font-size:36px;">üö®</div><div><div style="font-size:17px;font-weight:800;">Modo Examen - Matematicas</div><div style="font-size:13px;color:var(--text-muted);">Examen en <strong style="color:#fb7185;">3 dias</strong> - Plan basado en curva del olvido</div></div><button class="btn btn-primary" style="margin-left:auto;" onclick="activateExamMode()">Activar</button></div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;">
        <div style="background:rgba(244,63,94,0.1);border:1px solid rgba(244,63,94,0.2);border-radius:10px;padding:12px;text-align:center;"><div style="font-size:18px;margin-bottom:4px;">Hoy</div><div style="font-size:12px;font-weight:700;color:#fb7185;">Derivadas e integrales</div><div style="font-size:11px;color:var(--text-muted);">1a revision</div></div>
        <div style="background:rgba(245,158,11,0.08);border:1px solid rgba(245,158,11,0.2);border-radius:10px;padding:12px;text-align:center;"><div style="font-size:18px;margin-bottom:4px;">Manana</div><div style="font-size:12px;font-weight:700;color:var(--focos);">Problemas aplicados</div><div style="font-size:11px;color:var(--text-muted);">Practica intensiva</div></div>
        <div style="background:rgba(16,185,129,0.08);border:1px solid rgba(16,185,129,0.2);border-radius:10px;padding:12px;text-align:center;"><div style="font-size:18px;margin-bottom:4px;">Pasado</div><div style="font-size:12px;font-weight:700;color:var(--accent3);">Repaso general</div><div style="font-size:11px;color:var(--text-muted);">Consolidar memoria</div></div>
      </div>
    </div>
  </main>

  <!-- ===================== MAPA ANUAL ===================== -->
  <main class="main" id="page-heatmap">
    <div class="page-header">
      <div><div class="page-title">Mapa Anual</div><div class="page-subtitle">Curso 2024-2025 - Tu huella de esfuerzo</div></div>
      <div style="display:flex;gap:12px;">
        <div style="text-align:center;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:10px 20px;"><div style="font-family:Space Mono,monospace;font-size:24px;font-weight:700;color:#a78bfa;">89</div><div style="font-size:11px;color:var(--text-muted);">Dias estudiados</div></div>
        <div style="text-align:center;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:10px 20px;"><div style="font-family:Space Mono,monospace;font-size:24px;font-weight:700;color:var(--focos);">847</div><div style="font-size:11px;color:var(--text-muted);">Focos ganados</div></div>
        <div style="text-align:center;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:10px 20px;"><div style="font-family:Space Mono,monospace;font-size:24px;font-weight:700;color:var(--accent3);">62%</div><div style="font-size:11px;color:var(--text-muted);">Bloques perfectos</div></div>
      </div>
    </div>
    <div class="card" style="margin-bottom:24px;">
      <div class="card-title">Dias de estudio - Sep 2024 a Jun 2025</div>
      <div style="display:flex;gap:4px;margin-top:8px;flex-wrap:wrap;" id="annual-heatmap"></div>
      <div style="display:flex;gap:8px;align-items:center;margin-top:16px;font-size:12px;color:var(--text-muted);">
        Sin estudio
        <div style="display:flex;gap:3px;"><div style="width:14px;height:14px;border-radius:3px;background:rgba(124,58,237,0.08);"></div><div style="width:14px;height:14px;border-radius:3px;background:rgba(124,58,237,0.3);"></div><div style="width:14px;height:14px;border-radius:3px;background:rgba(124,58,237,0.55);"></div><div style="width:14px;height:14px;border-radius:3px;background:rgba(124,58,237,0.8);"></div><div style="width:14px;height:14px;border-radius:3px;background:#a78bfa;"></div></div>
        Maximo
        <div style="width:14px;height:14px;border-radius:3px;background:rgba(245,158,11,0.6);margin-left:12px;"></div>Examen
        <div style="width:14px;height:14px;border-radius:3px;background:rgba(244,63,94,0.3);"></div>Festivo
      </div>
    </div>
    <div class="section-title">Records personales</div>
    <div class="grid-3" style="margin-bottom:24px;">
      <div class="stat-card purple"><div class="stat-icon">üî•</div><div class="stat-value">14</div><div class="stat-label">Racha mas larga (dias)</div><div class="stat-change up">Nov 2024</div></div>
      <div class="stat-card amber"><div class="stat-icon">üíé</div><div class="stat-value">9</div><div class="stat-label">Mejor semana</div><div class="stat-change up">Feb 2025</div></div>
      <div class="stat-card green"><div class="stat-icon">‚è±Ô∏è</div><div class="stat-value">6.2h</div><div class="stat-label">Maximo en un dia</div><div class="stat-change up">Ene 2025</div></div>
    </div>
    <div class="section-title">Comparativa por trimestres</div>
    <div class="grid-3">
      <div class="card"><div style="font-size:12px;font-weight:700;color:var(--text-muted);margin-bottom:12px;">1ER TRIMESTRE</div><div style="font-size:28px;font-weight:900;color:#a78bfa;font-family:Space Mono,monospace;">28</div><div style="font-size:12px;color:var(--text-muted);">dias estudiados</div><div style="margin-top:8px;background:rgba(255,255,255,0.05);border-radius:100px;height:6px;"><div style="width:46%;height:100%;background:#7c3aed;border-radius:100px;"></div></div></div>
      <div class="card"><div style="font-size:12px;font-weight:700;color:var(--text-muted);margin-bottom:12px;">2 TRIMESTRE</div><div style="font-size:28px;font-weight:900;color:var(--focos);font-family:Space Mono,monospace;">38</div><div style="font-size:12px;color:var(--text-muted);">dias estudiados</div><div style="margin-top:8px;background:rgba(255,255,255,0.05);border-radius:100px;height:6px;"><div style="width:62%;height:100%;background:var(--focos);border-radius:100px;"></div></div></div>
      <div class="card" style="border-color:rgba(16,185,129,0.2);"><div style="font-size:12px;font-weight:700;color:var(--accent3);margin-bottom:12px;">3ER TRIMESTRE - ACTIVO</div><div style="font-size:28px;font-weight:900;color:var(--accent3);font-family:Space Mono,monospace;">23</div><div style="font-size:12px;color:var(--text-muted);">dias estudiados</div><div style="margin-top:8px;background:rgba(255,255,255,0.05);border-radius:100px;height:6px;"><div style="width:38%;height:100%;background:var(--accent3);border-radius:100px;"></div></div></div>
    </div>
  </main>

  <!-- ===================== FOCOS SOLIDARIOS ===================== -->
  <main class="main" id="page-focos-solidarios">
    <div class="page-header">
      <div><div class="page-title">Focos Solidarios</div><div class="page-subtitle">Dona Focos a un objetivo familiar compartido</div></div>
    </div>
    <div style="background:linear-gradient(135deg,rgba(244,63,94,0.1),rgba(245,158,11,0.08));border:1px solid rgba(244,63,94,0.25);border-radius:20px;padding:28px;margin-bottom:24px;">
      <div style="font-size:12px;font-weight:700;color:#fb7185;margin-bottom:10px;">OBJETIVO FAMILIAR ACTIVO</div>
      <div style="display:flex;align-items:center;gap:16px;margin-bottom:16px;"><div style="font-size:48px;">üèñÔ∏è</div><div><div style="font-size:22px;font-weight:900;">Escapada de verano en familia</div><div style="font-size:14px;color:var(--text-muted);margin-top:4px;">Propuesto por mama y papa - Todos contribuyen</div></div></div>
      <div style="background:rgba(255,255,255,0.05);border-radius:100px;height:12px;overflow:hidden;margin-bottom:10px;"><div style="width:58%;height:100%;background:linear-gradient(90deg,#f43f5e,#f59e0b);border-radius:100px;"></div></div>
      <div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:20px;"><span style="color:var(--text-muted);">Acumulado: <strong style="color:var(--focos);">1.160 / 2.000</strong></span><span style="color:var(--text-muted);">Faltan: <strong style="color:#fb7185;">840</strong></span></div>
      <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:20px;">
        <div style="display:flex;align-items:center;gap:10px;padding:10px;background:rgba(255,255,255,0.04);border-radius:10px;"><span style="font-size:20px;">üë¶</span><span style="font-size:14px;font-weight:700;flex:1;">Alejandro</span><div style="background:rgba(255,255,255,0.06);border-radius:100px;height:6px;flex:1;overflow:hidden;"><div style="width:45%;height:100%;background:#a78bfa;border-radius:100px;"></div></div><span style="font-family:Space Mono,monospace;font-size:13px;font-weight:700;color:#a78bfa;">520</span></div>
        <div style="display:flex;align-items:center;gap:10px;padding:10px;background:rgba(255,255,255,0.04);border-radius:10px;"><span style="font-size:20px;">üëß</span><span style="font-size:14px;font-weight:700;flex:1;">Sofia (hermana)</span><div style="background:rgba(255,255,255,0.06);border-radius:100px;height:6px;flex:1;overflow:hidden;"><div style="width:55%;height:100%;background:#f43f5e;border-radius:100px;"></div></div><span style="font-family:Space Mono,monospace;font-size:13px;font-weight:700;color:#fb7185;">640</span></div>
      </div>
      <div style="background:rgba(255,255,255,0.04);border-radius:14px;padding:16px;">
        <div style="font-size:13px;font-weight:700;margin-bottom:10px;">Donar Focos al objetivo</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;">
          <button class="btn btn-ghost" style="font-size:13px;padding:8px 14px;" onclick="donateToFund(10)">+10</button>
          <button class="btn btn-ghost" style="font-size:13px;padding:8px 14px;" onclick="donateToFund(25)">+25</button>
          <button class="btn btn-ghost" style="font-size:13px;padding:8px 14px;" onclick="donateToFund(50)">+50</button>
          <button class="btn btn-ghost" style="font-size:13px;padding:8px 14px;" onclick="donateToFund(100)">+100</button>
        </div>
        <div style="font-size:12px;color:var(--text-muted);">Tu saldo: <span id="solidario-focos" style="color:var(--focos);font-weight:700;font-family:Space Mono,monospace;">347</span> Focos</div>
      </div>
    </div>
    <div class="section-title">Ultimas aportaciones</div>
    <div id="fund-history" style="display:flex;flex-direction:column;gap:8px;">
      <div style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--surface2);border-radius:12px;border:1px solid var(--border);"><span style="font-size:18px;">üë¶</span><div style="flex:1;"><div style="font-size:13px;font-weight:700;">Alejandro dono</div><div style="font-size:11px;color:var(--text-muted);">Hace 2 dias</div></div><span style="font-family:Space Mono,monospace;font-weight:700;color:var(--focos);">+50</span></div>
      <div style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--surface2);border-radius:12px;border:1px solid var(--border);"><span style="font-size:18px;">üëß</span><div style="flex:1;"><div style="font-size:13px;font-weight:700;">Sofia dono</div><div style="font-size:11px;color:var(--text-muted);">Hace 3 dias</div></div><span style="font-family:Space Mono,monospace;font-weight:700;color:var(--focos);">+100</span></div>
    </div>
  </main>

  <!-- ===================== TEMPORADA ===================== -->
  <main class="main" id="page-temporada">
    <div class="page-header">
      <div><div class="page-title">Temporada</div><div class="page-subtitle">2 Trimestre - 3 Feb a 28 Mar 2025</div></div>
      <div style="background:linear-gradient(135deg,rgba(245,158,11,0.15),rgba(245,158,11,0.05));border:1px solid rgba(245,158,11,0.3);border-radius:12px;padding:10px 18px;text-align:center;"><div style="font-size:11px;color:var(--text-muted);font-weight:700;">TU POSICION</div><div style="font-size:32px;font-weight:900;color:var(--focos);font-family:Space Mono,monospace;">#2</div></div>
    </div>
    <div style="background:linear-gradient(135deg,rgba(245,158,11,0.12),rgba(124,58,237,0.08));border:1px solid rgba(245,158,11,0.25);border-radius:16px;padding:20px;margin-bottom:24px;display:flex;gap:20px;align-items:center;">
      <div style="font-size:48px;">üèÜ</div>
      <div style="flex:1;"><div style="font-size:18px;font-weight:900;margin-bottom:6px;">Temporada 2 - El Gran Repaso</div><div style="font-size:13px;color:var(--text-muted);line-height:1.6;">Cada trimestre es una temporada nueva. Al final se reinicia el ranking. Los premios son especiales y unicos.</div></div>
      <div style="text-align:center;flex-shrink:0;"><div style="font-size:11px;color:var(--text-muted);margin-bottom:4px;">Premio 1er puesto</div><div style="font-size:24px;">üéÅ</div><div style="font-size:12px;font-weight:700;color:var(--focos);">Recompensa especial</div></div>
    </div>
    <div class="section-title">Ranking familiar</div>
    <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:24px;" id="ranking-list"></div>
    <div class="section-title">Logros exclusivos de temporada</div>
    <div class="badges-grid">
      <div class="badge-item earned"><span class="badge-emoji">‚ùÑÔ∏è</span><div class="badge-name">Arranque en frio</div><div class="badge-desc">Primera semana</div></div>
      <div class="badge-item earned"><span class="badge-emoji">üìà</span><div class="badge-name">En forma</div><div class="badge-desc">3 semanas seguidas</div></div>
      <div class="badge-item locked"><span class="badge-emoji">üåä</span><div class="badge-name">Marea alta</div><div class="badge-desc">Top 1 durante 2 semanas</div></div>
      <div class="badge-item locked"><span class="badge-emoji">üëë</span><div class="badge-name">Campeon T2</div><div class="badge-desc">1er puesto al final</div></div>
      <div class="badge-item locked"><span class="badge-emoji">üéØ</span><div class="badge-name">Sin fallar</div><div class="badge-desc">0 semanas perdidas</div></div>
    </div>
  </main>

  <!-- ===================== MI CLASE ===================== -->
  <main class="main" id="page-clase">
    <div class="page-header">
      <div><div class="page-title">Mi Clase</div><div class="page-subtitle">1 Bach-A - Desafio semanal anonimo - AMPA</div></div>
      <span class="pill pill-green">Desafio activo</span>
    </div>
    <div style="background:linear-gradient(135deg,rgba(16,185,129,0.12),rgba(16,185,129,0.03));border:1px solid rgba(16,185,129,0.3);border-radius:20px;padding:24px;margin-bottom:24px;">
      <div style="font-size:11px;font-weight:700;color:var(--accent3);margin-bottom:10px;">DESAFIO DE CLASE - Semana 17 Feb</div>
      <div style="font-size:22px;font-weight:900;margin-bottom:8px;">Quien acumula mas bloques perfectos esta semana?</div>
      <div style="font-size:14px;color:var(--text-muted);margin-bottom:16px;">Anonimo - Solo se ven totales del grupo, nunca datos individuales</div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px;">
        <div style="background:rgba(255,255,255,0.04);border-radius:12px;padding:14px;text-align:center;border:2px solid rgba(16,185,129,0.3);"><div style="font-size:11px;color:var(--text-muted);margin-bottom:4px;font-weight:700;">TU APORTACION</div><div style="font-size:36px;font-weight:900;color:var(--accent3);font-family:Space Mono,monospace;">8</div><div style="font-size:12px;color:var(--text-muted);">bloques perfectos</div></div>
        <div style="background:rgba(255,255,255,0.04);border-radius:12px;padding:14px;text-align:center;"><div style="font-size:11px;color:var(--text-muted);margin-bottom:4px;font-weight:700;">TOTAL CLASE</div><div style="font-size:36px;font-weight:900;color:#a78bfa;font-family:Space Mono,monospace;">247</div><div style="font-size:12px;color:var(--text-muted);">bloques perfectos</div></div>
        <div style="background:rgba(255,255,255,0.04);border-radius:12px;padding:14px;text-align:center;"><div style="font-size:11px;color:var(--text-muted);margin-bottom:4px;font-weight:700;">PARTICIPACION</div><div style="font-size:36px;font-weight:900;color:var(--focos);font-family:Space Mono,monospace;">84%</div><div style="font-size:12px;color:var(--text-muted);">de la clase</div></div>
      </div>
      <div style="background:rgba(255,255,255,0.04);border-radius:10px;padding:12px;font-size:13px;color:var(--text-muted);">Premio: <strong style="color:var(--focos);">+30 Focos para cada participante</strong> si la clase supera los 300 bloques perfectos.</div>
    </div>
    <div class="section-title">Desafios anteriores</div>
    <div style="display:flex;flex-direction:column;gap:10px;margin-bottom:24px;">
      <div style="display:flex;align-items:center;gap:14px;padding:16px;background:var(--surface2);border-radius:14px;border:1px solid rgba(16,185,129,0.2);"><span style="font-size:24px;">üèÜ</span><div style="flex:1;"><div style="font-size:14px;font-weight:700;">Semana 10 Feb - Mayor racha de clase</div><div style="font-size:12px;color:var(--text-muted);">312 dias acumulados</div></div><span style="font-size:12px;font-weight:700;color:var(--accent3);">Superado +30</span></div>
      <div style="display:flex;align-items:center;gap:14px;padding:16px;background:var(--surface2);border-radius:14px;border:1px solid rgba(244,63,94,0.15);"><span style="font-size:24px;">üòî</span><div style="flex:1;"><div style="font-size:14px;font-weight:700;">Semana 3 Feb - Sin interrupciones</div><div style="font-size:12px;color:var(--text-muted);">189/250 sesiones sin interrupciones</div></div><span style="font-size:12px;font-weight:700;color:#fb7185;">No superado</span></div>
    </div>
    <div style="padding:16px;background:rgba(16,185,129,0.06);border:1px solid rgba(16,185,129,0.15);border-radius:12px;font-size:13px;color:var(--text-muted);">Privacidad: El profe y la AMPA solo ven totales de grupo. Nadie sabe cuanto estudia cada alumno individualmente.</div>
  </main>


  <!-- ===================== PERFIL ===================== -->
  <main class="main" id="page-perfil">
    <div class="page-header">
      <div><div class="page-title">‚öôÔ∏è Mi Perfil</div><div class="page-subtitle">Cuenta y vinculaci√≥n familiar</div></div>
    </div>

    <!-- ACCOUNT CARD -->
    <div style="background:linear-gradient(135deg,rgba(124,58,237,0.12),rgba(124,58,237,0.04));border:1px solid rgba(124,58,237,0.3);border-radius:20px;padding:28px;margin-bottom:24px;display:flex;gap:20px;align-items:center;">
      <div id="profile-avatar-big" style="width:72px;height:72px;background:linear-gradient(135deg,#7c3aed,#f59e0b);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:36px;flex-shrink:0;box-shadow:0 0 24px rgba(124,58,237,0.3);">üë¶</div>
      <div style="flex:1;">
        <div id="profile-name-big" style="font-size:24px;font-weight:900;">Alejandro Garc√≠a</div>
        <div id="profile-email-big" style="font-size:13px;color:var(--text-muted);margin-top:2px;"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="32535e5758535c56405d72555f535b5e1c515d5f">[email&#160;protected]</a></div>
        <div id="profile-role-badge" style="display:inline-flex;align-items:center;gap:6px;margin-top:8px;background:rgba(16,185,129,0.15);border:1px solid rgba(16,185,129,0.3);border-radius:8px;padding:4px 12px;font-size:12px;font-weight:700;color:var(--accent3);">üéí Alumno ¬∑ 1¬∫ Bachillerato</div>
      </div>
      <button class="btn btn-ghost" style="font-size:13px;" onclick="showToast('‚úèÔ∏è','Editar perfil','Funci√≥n disponible en la versi√≥n final')">Editar</button>
    </div>

    <!-- FAMILY LINK STATUS -->
    <div class="section-title">üîó Vinculaci√≥n familiar</div>
    <div id="family-linked-card" style="background:linear-gradient(135deg,rgba(16,185,129,0.1),rgba(16,185,129,0.03));border:1px solid rgba(16,185,129,0.3);border-radius:16px;padding:20px;margin-bottom:24px;">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
        <div style="width:10px;height:10px;border-radius:50%;background:var(--accent3);box-shadow:0 0 8px var(--accent3);"></div>
        <span style="font-size:14px;font-weight:700;color:var(--accent3);">Vinculado a tu familia</span>
        <span style="margin-left:auto;font-size:12px;color:var(--text-muted);">C√≥digo: <strong style="font-family:Space Mono,monospace;color:var(--accent);">FAM-4X92K</strong></span>
      </div>
      <!-- Family members -->
      <div style="display:flex;flex-direction:column;gap:10px;margin-bottom:16px;">
        <div style="display:flex;align-items:center;gap:12px;padding:12px;background:rgba(255,255,255,0.04);border-radius:12px;">
          <span style="font-size:24px;">üë®</span>
          <div style="flex:1;"><div style="font-size:14px;font-weight:700;">Carlos Garc√≠a</div><div style="font-size:12px;color:var(--text-muted);">Padre ¬∑ <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="a7c4c6d5cbc8d4e7c0cac6cecb89c4c8ca">[email&#160;protected]</a></div></div>
          <span style="font-size:11px;font-weight:700;color:var(--accent3);background:rgba(16,185,129,0.1);padding:3px 8px;border-radius:20px;">Conectado</span>
        </div>
        <div style="display:flex;align-items:center;gap:12px;padding:12px;background:rgba(255,255,255,0.04);border-radius:12px;">
          <span style="font-size:24px;">üë©</span>
          <div style="flex:1;"><div style="font-size:14px;font-weight:700;">Mar√≠a Garc√≠a</div><div style="font-size:12px;color:var(--text-muted);">Madre ¬∑ <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="234e42514a4263444e424a4f0d404c4e">[email&#160;protected]</a></div></div>
          <span style="font-size:11px;font-weight:700;color:var(--accent3);background:rgba(16,185,129,0.1);padding:3px 8px;border-radius:20px;">Conectada</span>
        </div>
        <div style="display:flex;align-items:center;gap:12px;padding:12px;background:rgba(255,255,255,0.04);border-radius:12px;">
          <span style="font-size:24px;">üëß</span>
          <div style="flex:1;"><div style="font-size:14px;font-weight:700;">Sof√≠a Garc√≠a</div><div style="font-size:12px;color:var(--text-muted);">Hermana ¬∑ Alumna</div></div>
          <span style="font-size:11px;font-weight:700;color:var(--accent3);background:rgba(16,185,129,0.1);padding:3px 8px;border-radius:20px;">Conectada</span>
        </div>
      </div>
      <div style="display:flex;gap:10px;">
        <button class="btn btn-ghost" style="font-size:13px;" onclick="showQRAgain()">üì± Mostrar mi QR</button>
        <button class="btn btn-ghost" style="font-size:13px;color:#fb7185;" onclick="showToast('‚ö†Ô∏è','Desvincular','Esta acci√≥n requiere confirmaci√≥n del padre')">Desvincular</button>
      </div>
    </div>

    <!-- QR MODAL (para mostrar QR propio o a√±adir miembro) -->
    <div id="qr-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:500;display:none;align-items:center;justify-content:center;" onclick="this.style.display='none'">
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:32px;text-align:center;max-width:340px;width:90%;" onclick="event.stopPropagation()">
        <div style="font-size:18px;font-weight:800;margin-bottom:8px;">Tu QR familiar</div>
        <div style="font-size:13px;color:var(--text-muted);margin-bottom:20px;">Mu√©straselo a otro familiar para que se una</div>
        <div class="qr-container" style="width:180px;height:180px;"><canvas id="qr-modal-canvas" width="160" height="160"></canvas></div>
        <div class="family-code" style="font-size:22px;letter-spacing:4px;margin:16px 0;">FAM-4X92K</div>
        <button class="btn btn-ghost" style="width:100%;" onclick="document.getElementById('qr-modal').style.display='none'">Cerrar</button>
      </div>
    </div>

    <!-- SETTINGS -->
    <div class="section-title">Ajustes de la cuenta</div>
    <div class="card">
      <div style="display:flex;flex-direction:column;gap:16px;">
        <div style="display:flex;justify-content:space-between;align-items:center;padding-bottom:14px;border-bottom:1px solid var(--border);">
          <div><div style="font-size:14px;font-weight:700;">Notificaciones push</div><div style="font-size:12px;color:var(--text-muted);">Recordatorios y logros</div></div>
          <div class="toggle-switch on" onclick="toggleSwitch(this)"><div class="toggle-knob"></div></div>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;padding-bottom:14px;border-bottom:1px solid var(--border);">
          <div><div style="font-size:14px;font-weight:700;">Resumen semanal visible para padres</div><div style="font-size:12px;color:var(--text-muted);">Tus padres reciben el informe cada domingo</div></div>
          <div class="toggle-switch on" onclick="toggleSwitch(this)"><div class="toggle-knob"></div></div>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div><div style="font-size:14px;font-weight:700;">Modo oscuro</div><div style="font-size:12px;color:var(--text-muted);">Siempre activado en esta versi√≥n</div></div>
          <div class="toggle-switch on" style="opacity:0.5;cursor:default;"><div class="toggle-knob"></div></div>
        </div>
      </div>
    </div>

    <button class="btn btn-ghost" style="width:100%;margin-top:16px;color:#fb7185;padding:14px;" onclick="logOut()">Cerrar sesi√≥n</button>
  </main>


<!-- ===================== CLASSROOM ===================== -->
  <main class="main" id="page-classroom">
    <div class="page-header">
      <div>
        <div class="page-title">üéì Google Classroom</div>
        <div class="page-subtitle">Sincroniza tus tareas y clases autom√°ticamente</div>
      </div>
      <div id="classroom-status-badge" style="display:flex;align-items:center;gap:8px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:10px;padding:10px 16px;font-size:13px;font-weight:700;color:var(--text-muted);">
        <span id="status-dot" style="width:8px;height:8px;border-radius:50%;background:var(--text-muted);display:inline-block;"></span>
        <span id="status-label">Sin conectar</span>
      </div>
    </div>

    <!-- DESCONECTADO -->
    <div id="classroom-disconnected">
      <div style="background:linear-gradient(135deg,rgba(66,133,244,0.12),rgba(66,133,244,0.04));border:1px solid rgba(66,133,244,0.3);border-radius:20px;padding:40px;text-align:center;margin-bottom:24px;">
        <div style="font-size:64px;margin-bottom:16px;">üéì</div>
        <div style="font-size:24px;font-weight:900;margin-bottom:8px;">Conecta con Google Classroom</div>
        <div style="font-size:14px;color:var(--text-muted);max-width:480px;margin:0 auto 28px;line-height:1.7;">Importa tus asignaturas, tareas y fechas de entrega autom√°ticamente. Tu planificador se rellenar√° solo y no te olvidar√°s de nada.</div>
        <button class="btn" style="background:white;color:#1a1a26;font-size:15px;padding:14px 32px;display:inline-flex;align-items:center;gap:12px;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.3);" onclick="connectClassroom()">
          <svg width="20" height="20" viewBox="0 0 48 48"><path fill="#4285F4" d="M44.5 20H24v8.5h11.8C34.7 33.9 30.1 37 24 37c-7.2 0-13-5.8-13-13s5.8-13 13-13c3.1 0 5.9 1.1 8.1 2.9l6.4-6.4C34.6 4.1 29.6 2 24 2 11.8 2 2 11.8 2 24s9.8 22 22 22c11 0 21-8 21-22 0-1.3-.2-2.7-.5-4z"/></svg>
          Conectar con Google
        </button>
        <div style="margin-top:20px;font-size:12px;color:var(--text-muted);">üîí Solo lectura ¬∑ No se modifica nada en Classroom ¬∑ Permisos revocables</div>
      </div>
      <div class="section-title">¬øQu√© se importa?</div>
      <div class="grid-3">
        <div class="card" style="text-align:center;">
          <div style="font-size:36px;margin-bottom:12px;">üìö</div>
          <div style="font-size:15px;font-weight:800;margin-bottom:6px;">Asignaturas</div>
          <div style="font-size:13px;color:var(--text-muted);">Todas tus clases con su color y profe autom√°ticamente</div>
        </div>
        <div class="card" style="text-align:center;">
          <div style="font-size:36px;margin-bottom:12px;">üìù</div>
          <div style="font-size:15px;font-weight:800;margin-bottom:6px;">Tareas pendientes</div>
          <div style="font-size:13px;color:var(--text-muted);">Se crean bloques de estudio sugeridos seg√∫n la fecha de entrega</div>
        </div>
        <div class="card" style="text-align:center;">
          <div style="font-size:36px;margin-bottom:12px;">üìÖ</div>
          <div style="font-size:15px;font-weight:800;margin-bottom:6px;">Fechas l√≠mite</div>
          <div style="font-size:13px;color:var(--text-muted);">Entregas marcadas en tu planificador con cuenta atr√°s</div>
        </div>
      </div>
    </div>

    <!-- CONECTANDO -->
    <div id="classroom-connecting" style="display:none;text-align:center;padding:60px 0;">
      <div style="font-size:48px;margin-bottom:20px;">‚è≥</div>
      <div style="font-size:20px;font-weight:800;margin-bottom:8px;">Conectando con Google Classroom...</div>
      <div style="font-size:14px;color:var(--text-muted);margin-bottom:28px;">Importando tus asignaturas y tareas</div>
      <div style="width:280px;margin:0 auto;background:rgba(255,255,255,0.06);border-radius:100px;height:8px;overflow:hidden;">
        <div id="sync-bar" style="height:100%;background:linear-gradient(90deg,#4285F4,#a78bfa);border-radius:100px;width:0%;transition:width 0.5s ease;"></div>
      </div>
      <div id="sync-step" style="margin-top:12px;font-size:13px;color:var(--text-muted);">Autenticando...</div>
    </div>

    <!-- CONECTADO -->
    <div id="classroom-connected" style="display:none;">
      <div style="background:linear-gradient(135deg,rgba(66,133,244,0.12),rgba(66,133,244,0.03));border:1px solid rgba(66,133,244,0.25);border-radius:16px;padding:20px;margin-bottom:24px;display:flex;align-items:center;gap:16px;">
        <div style="width:48px;height:48px;background:linear-gradient(135deg,#4285F4,#34A853);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:22px;">üë¶</div>
        <div>
          <div style="font-size:16px;font-weight:800;"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="aacbc6cfc0cbc4ced8c584cdcbd8c9c3cbeacbc6dfc7c4cfd984cfd9c9c5c6cb84c9cbde">[email&#160;protected]</a></div>
          <div style="font-size:13px;color:var(--text-muted);">Institut Escola ¬∑ 1¬∫ Bachillerato</div>
        </div>
        <div style="margin-left:auto;display:flex;gap:10px;align-items:center;">
          <span style="font-size:12px;color:var(--accent3);font-weight:700;">üü¢ √öltima sync: hace 2 min</span>
          <button class="btn btn-ghost" style="font-size:12px;padding:6px 14px;" onclick="resync()">‚Ü∫ Sincronizar</button>
          <button class="btn btn-ghost" style="font-size:12px;padding:6px 14px;color:#fb7185;" onclick="disconnectClassroom()">Desconectar</button>
        </div>
      </div>

      <div class="grid-3" style="margin-bottom:24px;">
        <div class="stat-card purple"><div class="stat-icon">üìö</div><div class="stat-value">6</div><div class="stat-label">Asignaturas importadas</div></div>
        <div class="stat-card amber"><div class="stat-icon">üìù</div><div class="stat-value" id="pending-tasks-count">8</div><div class="stat-label">Tareas pendientes</div></div>
        <div class="stat-card green"><div class="stat-icon">‚ö°</div><div class="stat-value">5</div><div class="stat-label">Bloques sugeridos</div></div>
      </div>

      <div class="tab-bar">
        <div class="tab active" onclick="switchClassroomTab('asignaturas',this)">üìö Asignaturas</div>
        <div class="tab" onclick="switchClassroomTab('tareas',this)">üìù Tareas</div>
        <div class="tab" onclick="switchClassroomTab('sugeridos',this)">‚ö° Sugeridos</div>
        <div class="tab" onclick="switchClassroomTab('ajustes',this)">‚öôÔ∏è Ajustes</div>
      </div>

      <!-- ASIGNATURAS -->
      <div id="cl-asignaturas">
        <div class="section-title">Asignaturas sincronizadas</div>
        <div style="display:flex;flex-direction:column;gap:10px;" id="subjects-list"></div>
      </div>

      <!-- TAREAS -->
      <div id="cl-tareas" style="display:none;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <div class="section-title" style="margin-bottom:0;">Tareas pendientes de Classroom</div>
          <button class="btn btn-primary" style="font-size:13px;padding:8px 18px;" onclick="importAllTasks()">üì• Importar todas al planificador</button>
        </div>
        <div style="display:flex;flex-direction:column;gap:10px;" id="tasks-list"></div>
      </div>

      <!-- SUGERIDOS -->
      <div id="cl-sugeridos" style="display:none;">
        <div style="background:rgba(245,158,11,0.08);border:1px solid rgba(245,158,11,0.2);border-radius:12px;padding:14px 18px;margin-bottom:20px;font-size:13px;color:var(--text-muted);line-height:1.6;">
          üí° <strong style="color:var(--focos);">Focus Family</strong> ha analizado tus tareas y fechas de entrega y sugiere estos bloques de estudio. Acepta los que quieras.
        </div>
        <div style="display:flex;flex-direction:column;gap:10px;" id="suggested-list"></div>
        <button class="btn btn-success" style="width:100%;margin-top:16px;padding:14px;" onclick="acceptAllSuggested()">‚úÖ Aceptar todos y a√±adir al planificador</button>
      </div>

      <!-- AJUSTES -->
      <div id="cl-ajustes" style="display:none;">
        <div class="section-title">Configuraci√≥n de sincronizaci√≥n</div>
        <div class="card">
          <div style="display:flex;flex-direction:column;gap:20px;">
            <div style="display:flex;justify-content:space-between;align-items:center;padding-bottom:16px;border-bottom:1px solid var(--border);">
              <div><div style="font-size:14px;font-weight:700;">Sync autom√°tica al abrir la app</div><div style="font-size:12px;color:var(--text-muted);margin-top:2px;">Siempre tendr√°s las tareas actualizadas</div></div>
              <div class="toggle-switch on" onclick="toggleSwitch(this)"><div class="toggle-knob"></div></div>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;padding-bottom:16px;border-bottom:1px solid var(--border);">
              <div><div style="font-size:14px;font-weight:700;">Notificar nueva tarea</div><div style="font-size:12px;color:var(--text-muted);margin-top:2px;">Alerta cuando el profe suba algo nuevo</div></div>
              <div class="toggle-switch on" onclick="toggleSwitch(this)"><div class="toggle-knob"></div></div>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;padding-bottom:16px;border-bottom:1px solid var(--border);">
              <div><div style="font-size:14px;font-weight:700;">Alerta 48h antes de entrega</div><div style="font-size:12px;color:var(--text-muted);margin-top:2px;">Recordatorio autom√°tico dos d√≠as antes del deadline</div></div>
              <div class="toggle-switch on" onclick="toggleSwitch(this)"><div class="toggle-knob"></div></div>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;padding-bottom:16px;border-bottom:1px solid var(--border);">
              <div><div style="font-size:14px;font-weight:700;">Sugerir bloques autom√°ticamente</div><div style="font-size:12px;color:var(--text-muted);margin-top:2px;">Proponer huecos de estudio seg√∫n las tareas</div></div>
              <div class="toggle-switch on" onclick="toggleSwitch(this)"><div class="toggle-knob"></div></div>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <div><div style="font-size:14px;font-weight:700;">Compartir fechas con padres</div><div style="font-size:12px;color:var(--text-muted);margin-top:2px;">Los padres ven las entregas en su panel familiar</div></div>
              <div class="toggle-switch on" onclick="toggleSwitch(this)"><div class="toggle-knob"></div></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

<!-- TOAST -->
<div class="toast" id="toast">
  <div class="toast-icon" id="toast-icon">üéâ</div>
  <div class="toast-content">
    <div class="toast-title" id="toast-title">T√≠tulo</div>
    <div class="toast-msg" id="toast-msg">Mensaje</div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ
let currentProfile = 'hijo';
let currentPage = 'dashboard';

function showPage(page) {
  document.querySelectorAll('.main').forEach(m => m.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-' + page)?.classList.add('active');
  document.getElementById('nav-' + page)?.classList.add('active');
  currentPage = page;
}

function switchProfile(profile) {
  currentProfile = profile;
  document.getElementById('btn-hijo').classList.toggle('active', profile === 'hijo');
  document.getElementById('btn-padres').classList.toggle('active', profile === 'padres');

  if (profile === 'padres') {
    showPage('padres');
    // hide hijo-only items
    document.getElementById('nav-pomodoro').style.opacity = '0.3';
    document.getElementById('nav-pomodoro').style.pointerEvents = 'none';
    document.getElementById('nav-badges').style.opacity = '0.3';
    document.getElementById('nav-badges').style.pointerEvents = 'none';
  } else {
    document.getElementById('nav-pomodoro').style.opacity = '';
    document.getElementById('nav-pomodoro').style.pointerEvents = '';
    document.getElementById('nav-badges').style.opacity = '';
    document.getElementById('nav-badges').style.pointerEvents = '';
    showPage('dashboard');
  }
}

// ‚îÄ‚îÄ WEEK PLANNER ‚îÄ‚îÄ
const HOURS = ['08:00','09:00','10:00','11:00','12:00','13:00','14:00','15:00','16:00','17:00','18:00','19:00','20:00','21:00','22:00'];
const EVENTS = {
  '0-09:00': {name:'Matem√°ticas', type:'clase'},
  '0-11:00': {name:'Historia', type:'clase'},
  '1-09:00': {name:'F√≠sica', type:'clase'},
  '1-11:00': {name:'Ingl√©s', type:'clase'},
  '1-16:00': {name:'Repaso F√≠sica', type:'estudio'},
  '2-09:00': {name:'Lengua', type:'clase'},
  '2-11:00': {name:'Matem√°ticas', type:'clase'},
  '2-16:00': {name:'Examen de Mates üö®', type:'examen'},
  '3-09:00': {name:'Ingl√©s', type:'clase'},
  '3-11:00': {name:'F√≠sica', type:'clase'},
  '3-16:00': {name:'Repaso Lengua', type:'estudio'},
  '3-18:00': {name:'Ocio libre', type:'ocio'},
  '4-09:00': {name:'Historia', type:'clase'},
  '4-16:00': {name:'Repaso mates', type:'estudio'},
  '4-19:00': {name:'Ocio libre üéÆ', type:'ocio'},
  '5-10:00': {name:'Repaso general', type:'estudio'},
  '5-16:00': {name:'Ocio', type:'ocio'},
  '6-11:00': {name:'Repaso ingl√©s', type:'estudio'},
};

// ‚îÄ‚îÄ PLANNER EVENT MODAL STATE ‚îÄ‚îÄ
let eventModalDay = 0;
let eventModalHour = '';
let eventModalHourIdx = 0;
let eventSelectedType = 'estudio';
let eventSelectedDuration = 2;

const TYPE_COLORS = {
  clase:   { border:'rgba(124,58,237,0.5)', bg:'rgba(124,58,237,0.15)', label:'#c4b5fd' },
  estudio: { border:'rgba(16,185,129,0.5)',  bg:'rgba(16,185,129,0.15)', label:'#6ee7b7' },
  ocio:    { border:'rgba(245,158,11,0.5)',  bg:'rgba(245,158,11,0.15)', label:'#fde68a' },
  examen:  { border:'rgba(244,63,94,0.5)',   bg:'rgba(244,63,94,0.15)', label:'#fda4af' },
};
const TYPE_ICONS = { clase:'üè´', estudio:'üìñ', ocio:'üéÆ', examen:'üìù' };
const DAY_NAMES = ['Lun','Mar','Mi√©','Jue','Vie','S√°b','Dom'];
const DAY_NUMS  = [17,18,19,20,21,22,23];

function buildPlanner() {
  const container = document.getElementById('time-rows');
  if (!container) return;
  container.innerHTML = '';

  HOURS.forEach((h, hi) => {
    const row = document.createElement('div');
    row.className = 'week-grid';
    row.innerHTML = `<div class="time-label">${h}</div>`;

    for (let d = 0; d < 7; d++) {
      const key = `${d}-${h}`;
      const ev = EVENTS[key];
      const slot = document.createElement('div');
      slot.className = 'time-slot';
      slot.style.cursor = 'pointer';
      slot.style.transition = 'background 0.15s';
      slot.style.position = 'relative';

      if (ev) {
        const tc = TYPE_COLORS[ev.type] || TYPE_COLORS.estudio;
        slot.innerHTML = `
          <div class="event-block ${ev.type}" style="
            position:absolute;inset:2px;border-radius:8px;
            background:${tc.bg};border:1.5px solid ${tc.border};
            display:flex;align-items:center;justify-content:space-between;
            padding:0 8px;cursor:pointer;
          " onclick="openEventModal(${d},'${h}',${hi},true)">
            <span style="font-size:11px;font-weight:700;color:${tc.label};overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;">
              ${TYPE_ICONS[ev.type] || ''} ${ev.name}
            </span>
            <span style="font-size:14px;opacity:0;transition:opacity 0.15s;" class="ev-edit-icon">‚úèÔ∏è</span>
          </div>`;
        slot.querySelector('.event-block').onmouseenter = function() {
          this.querySelector('.ev-edit-icon').style.opacity = '1';
        };
        slot.querySelector('.event-block').onmouseleave = function() {
          this.querySelector('.ev-edit-icon').style.opacity = '0';
        };
      } else {
        // Empty slot ‚Äî show + on hover
        slot.innerHTML = `<div style="
          position:absolute;inset:2px;border-radius:8px;border:1.5px dashed transparent;
          display:flex;align-items:center;justify-content:center;
          font-size:16px;color:transparent;transition:all 0.15s;
        " class="empty-slot-inner">+</div>`;
        slot.onmouseenter = function() {
          const inner = this.querySelector('.empty-slot-inner');
          inner.style.borderColor = 'rgba(124,58,237,0.35)';
          inner.style.color = 'rgba(124,58,237,0.5)';
          inner.style.background = 'rgba(124,58,237,0.04)';
        };
        slot.onmouseleave = function() {
          const inner = this.querySelector('.empty-slot-inner');
          inner.style.borderColor = 'transparent';
          inner.style.color = 'transparent';
          inner.style.background = '';
        };
        slot.onclick = () => openEventModal(d, h, hi, false);
      }
      row.appendChild(slot);
    }
    container.appendChild(row);
  });
}

function openEventModal(day, hour, hourIdx, isEdit) {
  eventModalDay = day;
  eventModalHour = hour;
  eventModalHourIdx = hourIdx;

  const modal = document.getElementById('event-modal');
  const key = `${day}-${hour}`;
  const existing = EVENTS[key];

  // Set header
  document.getElementById('event-modal-title').textContent = isEdit ? 'Editar evento' : 'Nuevo evento';
  document.getElementById('event-modal-slot').textContent =
    `${DAY_NAMES[day]} ${DAY_NUMS[day]} Feb  ¬∑  ${hour}`;
  document.getElementById('save-event-label').textContent = isEdit ? 'Guardar cambios' : 'A√±adir al planificador';
  document.getElementById('btn-delete-event').style.display = isEdit ? 'inline-block' : 'none';

  // Always populate the time selects based on the clicked slot hour
  const slotHour = eventModalHour; // e.g. "09:00" or "16:00"
  // Normalize to HH:MM format for the select
  const normalizedStart = slotHour.includes(':') ? slotHour : slotHour + ':00';
  populateTimeSelects(normalizedStart);

  if (isEdit && existing) {
    document.getElementById('event-name-input').value = existing.name;
    selectEventType(existing.type, null);
    // Restore saved start/end if available
    if (existing.startTime) {
      setTimeout(() => {
        const ss = document.getElementById('event-start-select');
        if (ss) { ss.value = existing.startTime; updateEventEndOptions(); }
        const es = document.getElementById('event-end-select');
        if (es && existing.endTime) { es.value = existing.endTime; updateDurationLabel(); }
      }, 50);
    }
  } else {
    document.getElementById('event-name-input').value = '';
    selectEventType('estudio', null);
    eventSelectedDuration = 1;
  }

  modal.style.display = 'flex';
  setTimeout(() => document.getElementById('event-name-input').focus(), 100);
}

function closeEventModal() {
  document.getElementById('event-modal').style.display = 'none';
}

function selectEventType(type, el) {
  eventSelectedType = type;
  document.querySelectorAll('.type-opt').forEach(opt => {
    const t = opt.dataset.type;
    const tc = TYPE_COLORS[t];
    opt.style.borderColor = 'rgba(255,255,255,0.08)';
    opt.style.background = 'var(--surface2)';
    opt.style.transform = '';
    opt.style.boxShadow = '';
  });
  const selected = el || document.querySelector(`.type-opt[data-type="${type}"]`);
  if (selected) {
    const tc = TYPE_COLORS[type];
    selected.style.borderColor = tc.border;
    selected.style.background = tc.bg;
    selected.style.transform = 'scale(1.05)';
    selected.style.boxShadow = `0 0 12px ${tc.bg}`;
  }
}

function populateTimeSelects(startHour) {
  const startSel = document.getElementById('event-start-select');
  const endSel   = document.getElementById('event-end-select');
  if (!startSel || !endSel) return;

  // Build 15-min slots from 08:00 to 22:00
  const slots = [];
  for (let h = 8; h <= 22; h++) {
    slots.push(`${h}:00`);
    if (h < 22) {
      slots.push(`${h}:15`);
      slots.push(`${h}:30`);
      slots.push(`${h}:45`);
    }
  }

  startSel.innerHTML = slots.map(s =>
    `<option value="${s}" ${s === startHour ? 'selected' : ''}>${s}</option>`
  ).join('');

  updateEventEndOptions();
}

function updateEventEndOptions() {
  const startSel = document.getElementById('event-start-select');
  const endSel   = document.getElementById('event-end-select');
  if (!startSel || !endSel) return;

  const startVal = startSel.value;
  const [sh, sm] = startVal.split(':').map(Number);
  const startMins = sh * 60 + sm;

  // End options: startMins+15 up to 22:00, in 15-min steps
  const endSlots = [];
  for (let mins = startMins + 15; mins <= 22 * 60; mins += 15) {
    const hh = Math.floor(mins / 60);
    const mm = mins % 60;
    endSlots.push(`${hh}:${mm === 0 ? '00' : mm}`);
  }

  // Keep previous end selection if still valid
  const prevEnd = endSel.value;
  endSel.innerHTML = endSlots.map(s =>
    `<option value="${s}" ${s === prevEnd ? 'selected' : ''}>${s}</option>`
  ).join('');

  // Default end = start + 1h
  if (!endSlots.includes(prevEnd)) {
    const defaultMins = startMins + 60;
    const dh = Math.floor(defaultMins / 60);
    const dm = defaultMins % 60;
    const defaultEnd = `${dh}:${dm === 0 ? '00' : dm}`;
    if (endSlots.includes(defaultEnd)) endSel.value = defaultEnd;
  }

  updateDurationLabel();
}

function updateDurationLabel() {
  const startSel = document.getElementById('event-start-select');
  const endSel   = document.getElementById('event-end-select');
  const label    = document.getElementById('duration-label');
  const preview  = document.getElementById('time-range-text');
  if (!startSel || !endSel || !label) return;

  const [sh, sm] = startSel.value.split(':').map(Number);
  const [eh, em] = endSel.value.split(':').map(Number);
  const totalMins = (eh * 60 + em) - (sh * 60 + sm);

  const hours   = Math.floor(totalMins / 60);
  const minutes = totalMins % 60;

  let durationStr = '';
  if (hours > 0 && minutes > 0) durationStr = `${hours}h ${minutes}min`;
  else if (hours > 0)            durationStr = `${hours}h`;
  else                           durationStr = `${minutes}min`;

  // For slot spanning we use fractional logic: 1 slot = 1h
  // but we store duration in minutes for accurate display

  label.textContent   = durationStr;
  if (preview) preview.textContent = durationStr;

  // Slot count: each grid row = 1h; sub-hour events still occupy 1 row minimum
  eventSelectedDuration = Math.max(1, Math.ceil(totalMins / 60));
}

function selectDuration(val, el) {
  // Legacy fallback ‚Äî no longer used but kept to avoid errors
  eventSelectedDuration = val;
}

function updateDurationSelector(val) {
  // Legacy ‚Äî no-op now
}

function saveEvent() {
  const name = document.getElementById('event-name-input').value.trim();
  if (!name) {
    document.getElementById('event-name-input').style.borderColor = '#f43f5e';
    document.getElementById('event-name-input').focus();
    return;
  }
  document.getElementById('event-name-input').style.borderColor = '';

  // Read start / end from selects
  const startSel = document.getElementById('event-start-select');
  const endSel   = document.getElementById('event-end-select');
  const startTime = startSel ? startSel.value : eventModalHour;
  const endTime   = endSel   ? endSel.value   : '';

  // Compute slot span from time range
  let slotSpan = eventSelectedDuration || 1;
  if (startTime && endTime) {
    const [sh, sm] = startTime.split(':').map(Number);
    const [eh, em] = endTime.split(':').map(Number);
    const totalMins = (eh * 60 + em) - (sh * 60 + sm);
    slotSpan = Math.max(1, Math.ceil(totalMins / 60));
  }

  // Find which HOURS index corresponds to startTime
  const startHourKey = startTime.endsWith(':00') ? startTime.replace(':00','') + ':00' : startTime;
  const startIdx = HOURS.findIndex(h => {
    const norm = h.includes(':') ? h : h + ':00';
    return norm === startHourKey || h === startTime.split(':')[0] + ':00';
  });
  const useIdx = startIdx !== -1 ? startIdx : eventModalHourIdx;

  // Clear any old event slots in range first (delete + edit)
  const oldKey = `${eventModalDay}-${eventModalHour}`;
  const oldEv = EVENTS[oldKey];
  if (oldEv) {
    const oldSpan = oldEv.duration || 1;
    for (let s = 0; s < oldSpan; s++) {
      if (HOURS[eventModalHourIdx + s]) delete EVENTS[`${eventModalDay}-${HOURS[eventModalHourIdx + s]}`];
    }
  }

  // Write new event across slots
  for (let span = 0; span < slotSpan; span++) {
    const spanIdx = useIdx + span;
    if (spanIdx < HOURS.length) {
      const spanKey = `${eventModalDay}-${HOURS[spanIdx]}`;
      EVENTS[spanKey] = {
        name: span === 0 ? name : '‚Ü≥ ' + name,
        type: eventSelectedType,
        duration: span === 0 ? slotSpan : 0,
        startTime: span === 0 ? startTime : null,
        endTime:   span === 0 ? endTime   : null,
      };
    }
  }

  closeEventModal();
  buildPlanner();

  const icons = { clase:'üè´', estudio:'üìñ', ocio:'üéÆ', examen:'üìù' };
  const timeLabel = startTime && endTime ? `${startTime} ‚Üí ${endTime}` : DAY_NAMES[eventModalDay];
  const focosBonus = eventSelectedType === 'estudio' ? ' +5 üîÜ' : '';
  showToast(icons[eventSelectedType], name, `${DAY_NAMES[eventModalDay]} ¬∑ ${timeLabel}${focosBonus}`);

  if (eventSelectedType === 'estudio') {
    focos += 5;
    document.getElementById('focos-display').textContent = focos;
    document.getElementById('focos-display2').textContent = focos;
  }
}

function deleteEvent() {
  const key = `${eventModalDay}-${eventModalHour}`;
  const ev = EVENTS[key];
  if (ev) {
    // Remove this slot and any continuations
    const dur = ev.duration || 1;
    for (let span = 0; span < dur; span++) {
      const spanIdx = eventModalHourIdx + span;
      if (spanIdx < HOURS.length) {
        delete EVENTS[`${eventModalDay}-${HOURS[spanIdx]}`];
      }
    }
  }
  closeEventModal();
  buildPlanner();
  showToast('üóëÔ∏è', 'Evento eliminado', '');
}

buildPlanner();

// ‚îÄ‚îÄ TIMER ‚îÄ‚îÄ
let timerInterval = null;
let secondsLeft = 25 * 60;
let isRunning = false;
let pomodoroNum = 1;
let sessionFocos = 0;
let completedPomodoros = 0;
let interruptions = 0;

function pad(n) { return n.toString().padStart(2,'0'); }

function updateTimerDisplay() {
  const m = Math.floor(secondsLeft / 60);
  const s = secondsLeft % 60;
  const el = document.getElementById('timer-display');
  if (el) el.textContent = `${pad(m)}:${pad(s)}`;

  const total = 25 * 60;
  const pct = secondsLeft / total;
  const circ = 440;
  const offset = circ * pct;
  const circle = document.getElementById('timer-circle');
  if (circle) circle.style.strokeDashoffset = offset;
}

function toggleTimer() {
  const btn = document.getElementById('timer-btn');
  if (isRunning) {
    clearInterval(timerInterval);
    isRunning = false;
    btn.textContent = '‚ñ∂ Continuar';
    interruptions++;
    document.getElementById('interruption-count').textContent = interruptions + ' interrupciones';
    document.getElementById('interruption-count').style.color = 'var(--accent4)';
    document.getElementById('interruption-log').textContent = `üì± Interrupci√≥n #${interruptions} detectada`;
  } else {
    isRunning = true;
    btn.textContent = '‚è∏ Pausar';
    timerInterval = setInterval(() => {
      secondsLeft--;
      updateTimerDisplay();
      if (secondsLeft <= 0) {
        clearInterval(timerInterval);
        isRunning = false;
        completedPomodoros++;
        const earned = interruptions === 0 ? 15 : 3;
        sessionFocos += earned;
        focos += earned;
        document.getElementById('focos-display').textContent = focos;
        document.getElementById('focos-display2').textContent = focos;
        document.getElementById('wallet-balance').textContent = focos;
        document.getElementById('completed-count').textContent = completedPomodoros;
        document.getElementById('session-focos').textContent = sessionFocos;
        btn.textContent = '‚ñ∂ Iniciar';
        secondsLeft = 25 * 60;
        pomodoroNum++;
        document.getElementById('pomodoro-count').textContent = Math.min(pomodoroNum, 4);
        interruptions = 0;
        document.getElementById('interruption-count').textContent = '0 interrupciones';
        document.getElementById('interruption-count').style.color = 'var(--accent3)';
        document.getElementById('interruption-log').textContent = 'Sin interrupciones üíé';
        updateTimerDisplay();
        showToast(earned === 15 ? 'üíé':'‚úÖ', earned === 15 ? '¬°Bloque perfecto!':'Bloque completado', `+${earned} üîÜ Focos ganados`);
      }
    }, 1000);
  }
}

function resetTimer() {
  clearInterval(timerInterval);
  isRunning = false;
  secondsLeft = 25 * 60;
  interruptions = 0;
  document.getElementById('timer-btn').textContent = '‚ñ∂ Iniciar';
  document.getElementById('interruption-count').textContent = '0 interrupciones';
  document.getElementById('interruption-count').style.color = 'var(--accent3)';
  document.getElementById('interruption-log').textContent = 'Sin interrupciones üíé';
  updateTimerDisplay();
}

function updateSubject() {
  const sel = document.getElementById('subject-select');
  const disp = document.getElementById('subject-display');
  if (sel && disp) disp.textContent = sel.value;
}

updateTimerDisplay();

// ‚îÄ‚îÄ FOCOS ‚îÄ‚îÄ
let focos = 347;

function canjear(nombre, coste) {
  if (focos < coste) { showToast('‚ùå','Sin focos suficientes','Sigue estudiando para ganar m√°s üîÜ'); return; }
  focos -= coste;
  document.getElementById('focos-display').textContent = focos;
  document.getElementById('focos-display2').textContent = focos;
  document.getElementById('wallet-balance').textContent = focos;
  showToast('üéÅ','¬°Recompensa canjeada!', `"${nombre}" desbloqueada. -${coste} üîÜ`);
}

// ‚îÄ‚îÄ EMOTION ‚îÄ‚îÄ
function selectEmotion(el, type) {
  el.closest('.emotion-grid').querySelectorAll('.emotion-btn').forEach(b => b.classList.remove('selected'));
  el.classList.add('selected');
}

function saveEmotion() {
  focos += 2;
  document.getElementById('focos-display').textContent = focos;
  showToast('üòä','Emoci√≥n registrada','¬°Autoconocimiento! +2 üîÜ');
}

// ‚îÄ‚îÄ BADGES ‚îÄ‚îÄ
function filterBadges(cat, el) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  document.querySelectorAll('.badge-item').forEach(b => {
    if (cat === 'todas' || b.dataset.cat === cat) {
      b.style.display = '';
    } else {
      b.style.display = 'none';
    }
  });
}

// ‚îÄ‚îÄ TABS ‚îÄ‚îÄ
function switchEcoTab(tab, el) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('eco-catalogo').style.display = tab === 'catalogo' ? '' : 'none';
  document.getElementById('eco-historial').style.display = tab === 'historial' ? '' : 'none';
}

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ
function showToast(icon, title, msg) {
  const t = document.getElementById('toast');
  document.getElementById('toast-icon').textContent = icon;
  document.getElementById('toast-title').textContent = title;
  document.getElementById('toast-msg').textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3500);
}
// ‚îÄ‚îÄ CLASSROOM DATA ‚îÄ‚îÄ
const CLASSROOM_SUBJECTS = [
  { name:'Matem√°ticas', teacher:'Profa. Mart√≠nez', color:'#7c3aed', tasks:3, emoji:'üìê' },
  { name:'F√≠sica', teacher:'Prof. Rodr√≠guez', color:'#4285F4', tasks:2, emoji:'üî¨' },
  { name:'Historia', teacher:'Profa. S√°nchez', color:'#f59e0b', tasks:1, emoji:'üìñ' },
  { name:'Ingl√©s', teacher:'Prof. Williams', color:'#10b981', tasks:1, emoji:'üá¨üáß' },
  { name:'Lengua', teacher:'Profa. L√≥pez', color:'#f43f5e', tasks:0, emoji:'‚úèÔ∏è' },
  { name:'Qu√≠mica', teacher:'Prof. Garc√≠a', color:'#06b6d4', tasks:1, emoji:'‚öóÔ∏è' },
];

const CLASSROOM_TASKS = [
  { subject:'Matem√°ticas', color:'#7c3aed', emoji:'üìê', title:'Ejercicios derivadas - P√°g 87-90', due:'Ma√±ana', daysLeft:1, urgency:'high' },
  { subject:'F√≠sica', color:'#4285F4', emoji:'üî¨', title:'Informe pr√°ctica de laboratorio', due:'Jueves 27 Feb', daysLeft:3, urgency:'high' },
  { subject:'Ingl√©s', color:'#10b981', emoji:'üá¨üáß', title:'Writing: describe your ideal weekend', due:'Viernes 28 Feb', daysLeft:4, urgency:'mid' },
  { subject:'Matem√°ticas', color:'#7c3aed', emoji:'üìê', title:'Problemas de integrales - Unidad 6', due:'Lunes 3 Mar', daysLeft:8, urgency:'mid' },
  { subject:'Historia', color:'#f59e0b', emoji:'üìñ', title:'Resumen Revoluci√≥n Industrial (1 p√°g)', due:'Martes 4 Mar', daysLeft:9, urgency:'mid' },
  { subject:'Qu√≠mica', color:'#06b6d4', emoji:'‚öóÔ∏è', title:'Formulaci√≥n inorg√°nica - Ejercicios', due:'Mi√©rcoles 5 Mar', daysLeft:10, urgency:'low' },
  { subject:'F√≠sica', color:'#4285F4', emoji:'üî¨', title:'Problemas cinem√°tica - Tema 4', due:'Viernes 7 Mar', daysLeft:12, urgency:'low' },
  { subject:'Matem√°ticas', color:'#7c3aed', emoji:'üìê', title:'Examen Unidades 5 y 6', due:'Lunes 10 Mar', daysLeft:15, urgency:'low' },
];

const SUGGESTED_BLOCKS = [
  { subject:'Matem√°ticas', emoji:'üìê', color:'#7c3aed', task:'Ejercicios derivadas', day:'Hoy', time:'16:30-17:30', focos:15, reason:'Entrega ma√±ana ‚Äî ¬°urgente!' },
  { subject:'F√≠sica', emoji:'üî¨', color:'#4285F4', task:'Informe laboratorio', day:'Ma√±ana', time:'17:00-18:00', focos:15, reason:'Entrega en 3 d√≠as' },
  { subject:'Ingl√©s', emoji:'üá¨üáß', color:'#10b981', task:'Writing weekend', day:'Mi√©rcoles', time:'16:30-17:00', focos:10, reason:'Entrega en 4 d√≠as' },
  { subject:'Historia', emoji:'üìñ', color:'#f59e0b', task:'Resumen Revoluci√≥n Industrial', day:'Jueves', time:'17:00-17:30', focos:10, reason:'Entrega la semana que viene' },
  { subject:'Qu√≠mica', emoji:'‚öóÔ∏è', color:'#06b6d4', task:'Formulaci√≥n inorg√°nica', day:'S√°bado', time:'10:00-11:00', focos:10, reason:'Sin fecha urgente ‚Äî buen momento' },
];

let classroomConnected = false;
let importedTasks = new Set();
let acceptedBlocks = new Set();

function connectClassroom() {
  document.getElementById('classroom-disconnected').style.display = 'none';
  document.getElementById('classroom-connecting').style.display = 'block';
  const bar = document.getElementById('sync-bar');
  const step = document.getElementById('sync-step');
  const steps = [
    [15, 'Autenticando con Google...'],
    [35, 'Obteniendo permisos de Classroom...'],
    [55, 'Importando asignaturas (6)...'],
    [75, 'Importando tareas pendientes (8)...'],
    [90, 'Generando bloques sugeridos...'],
    [100, '¬°Sincronizaci√≥n completada!'],
  ];
  let i = 0;
  const run = () => {
    if (i >= steps.length) {
      setTimeout(finishConnect, 400);
      return;
    }
    bar.style.width = steps[i][0] + '%';
    step.textContent = steps[i][1];
    i++;
    setTimeout(run, 600);
  };
  run();
}

function finishConnect() {
  classroomConnected = true;
  document.getElementById('classroom-connecting').style.display = 'none';
  document.getElementById('classroom-connected').style.display = 'block';
  const dot = document.getElementById('status-dot');
  dot.style.background = 'var(--accent3)';
  dot.style.boxShadow = '0 0 6px var(--accent3)';
  document.getElementById('status-label').textContent = 'Conectado';
  document.getElementById('classroom-status-badge').style.borderColor = 'rgba(16,185,129,0.3)';
  document.getElementById('classroom-status-badge').style.color = 'var(--accent3)';
  buildSubjectsList();
  buildTasksList();
  buildSuggestedList();
  showToast('üéì','¬°Classroom conectado!','6 asignaturas y 8 tareas importadas');
}

function disconnectClassroom() {
  classroomConnected = false;
  document.getElementById('classroom-connected').style.display = 'none';
  document.getElementById('classroom-disconnected').style.display = 'block';
  const dot = document.getElementById('status-dot');
  dot.style.background = 'var(--text-muted)';
  dot.style.boxShadow = 'none';
  document.getElementById('status-label').textContent = 'Sin conectar';
  document.getElementById('classroom-status-badge').style.borderColor = 'var(--border)';
  document.getElementById('classroom-status-badge').style.color = 'var(--text-muted)';
  importedTasks.clear();
  acceptedBlocks.clear();
  showToast('üîå','Desconectado','Puedes volver a conectar cuando quieras');
}

function resync() {
  showToast('‚Ü∫','Sincronizando...','Actualizando tareas de Classroom');
  setTimeout(() => showToast('‚úÖ','Sync completada','Todo al d√≠a ¬∑ 8 tareas pendientes'), 2000);
}

function buildSubjectsList() {
  const el = document.getElementById('subjects-list');
  el.innerHTML = CLASSROOM_SUBJECTS.map(s => `
    <div style="display:flex;align-items:center;gap:14px;padding:16px;background:var(--surface2);border:1px solid var(--border);border-radius:14px;transition:all 0.2s;" onmouseover="this.style.borderColor='${s.color}44'" onmouseout="this.style.borderColor='var(--border)'">
      <div style="width:44px;height:44px;background:${s.color}22;border:2px solid ${s.color}55;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px;">${s.emoji}</div>
      <div style="flex:1;">
        <div style="font-size:15px;font-weight:800;">${s.name}</div>
        <div style="font-size:12px;color:var(--text-muted);margin-top:2px;">${s.teacher}</div>
      </div>
      <div style="text-align:right;">
        <div style="font-size:13px;font-weight:700;color:${s.tasks>0?'var(--focos)':'var(--text-muted)'};">${s.tasks} tarea${s.tasks!==1?'s':''} pendiente${s.tasks!==1?'s':''}</div>
        <div style="display:inline-flex;align-items:center;gap:4px;font-size:11px;color:var(--accent3);margin-top:4px;font-weight:700;">üü¢ Sincronizada</div>
      </div>
    </div>
  `).join('');
}

function buildTasksList() {
  const el = document.getElementById('tasks-list');
  el.innerHTML = CLASSROOM_TASKS.map((t, i) => `
    <div class="cl-task ${importedTasks.has(i)?'imported':''}" id="task-${i}">
      <div class="cl-subject-dot" style="background:${t.color};box-shadow:0 0 6px ${t.color}66;"></div>
      <div style="font-size:18px;">${t.emoji}</div>
      <div style="flex:1;">
        <div style="font-size:14px;font-weight:800;">${t.title}</div>
        <div style="font-size:12px;color:var(--text-muted);margin-top:3px;">${t.subject} ¬∑ üìÖ ${t.due}</div>
      </div>
      <span class="urgency-badge urgency-${t.urgency}">${t.urgency==='high'?'üî¥ Urgente':t.urgency==='mid'?'üü° Pr√≥ximo':'üü¢ Con tiempo'}</span>
      ${importedTasks.has(i)
        ? '<span style="font-size:12px;font-weight:700;color:var(--accent3);">‚úÖ Importada</span>'
        : `<button class="btn btn-ghost" style="font-size:12px;padding:6px 12px;white-space:nowrap;" onclick="importTask(${i})">üì• Importar</button>`}
    </div>
  `).join('');
}

function importTask(i) {
  importedTasks.add(i);
  buildTasksList();
  focos += 2;
  document.getElementById('focos-display').textContent = focos;
  document.getElementById('focos-display2').textContent = focos;
  showToast('üì•','Tarea importada','A√±adida al planificador ¬∑ +2 üîÜ');
}

function importAllTasks() {
  CLASSROOM_TASKS.forEach((_, i) => importedTasks.add(i));
  buildTasksList();
  focos += 10;
  document.getElementById('focos-display').textContent = focos;
  document.getElementById('focos-display2').textContent = focos;
  showToast('üì•','¬°Todas importadas!','8 tareas a√±adidas al planificador ¬∑ +10 üîÜ');
}

function buildSuggestedList() {
  const el = document.getElementById('suggested-list');
  el.innerHTML = SUGGESTED_BLOCKS.map((b, i) => `
    <div style="background:var(--surface2);border:1px solid ${acceptedBlocks.has(i)?'rgba(16,185,129,0.4)':'var(--border)'};border-radius:14px;padding:16px;display:flex;align-items:center;gap:14px;transition:all 0.2s;" id="block-${i}">
      <div style="width:44px;height:44px;background:${b.color}22;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;">${b.emoji}</div>
      <div style="flex:1;">
        <div style="font-size:14px;font-weight:800;">${b.subject} ‚Äî ${b.task}</div>
        <div style="font-size:12px;color:var(--text-muted);margin-top:3px;">üìÖ ${b.day} ¬∑ üïì ${b.time}</div>
        <div style="font-size:11px;color:#a78bfa;margin-top:4px;font-weight:600;">üí° ${b.reason}</div>
      </div>
      <div style="text-align:right;flex-shrink:0;">
        <div style="font-size:13px;font-weight:700;color:var(--focos);">+${b.focos} üîÜ</div>
        ${acceptedBlocks.has(i)
          ? '<div style="font-size:12px;color:var(--accent3);font-weight:700;margin-top:4px;">‚úÖ A√±adido</div>'
          : `<button class="btn btn-primary" style="font-size:12px;padding:6px 14px;margin-top:6px;" onclick="acceptBlock(${i})">Aceptar</button>`}
      </div>
    </div>
  `).join('');
}

function acceptBlock(i) {
  acceptedBlocks.add(i);
  buildSuggestedList();
  focos += SUGGESTED_BLOCKS[i].focos;
  document.getElementById('focos-display').textContent = focos;
  document.getElementById('focos-display2').textContent = focos;
  showToast('‚ö°','Bloque a√±adido','Aparece en tu planificador ¬∑ +' + SUGGESTED_BLOCKS[i].focos + ' üîÜ');
}

function acceptAllSuggested() {
  let earned = 0;
  SUGGESTED_BLOCKS.forEach((b, i) => { if (!acceptedBlocks.has(i)) { acceptedBlocks.add(i); earned += b.focos; }});
  buildSuggestedList();
  focos += earned;
  document.getElementById('focos-display').textContent = focos;
  document.getElementById('focos-display2').textContent = focos;
  showToast('üéâ','¬°Semana planificada!','5 bloques a√±adidos al planificador ¬∑ +' + earned + ' üîÜ');
}

function switchClassroomTab(tab, el) {
  document.querySelectorAll('#page-classroom .tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  ['asignaturas','tareas','sugeridos','ajustes'].forEach(t => {
    const d = document.getElementById('cl-' + t);
    if (d) d.style.display = t === tab ? '' : 'none';
  });
}

function toggleSwitch(el) {
  el.classList.toggle('on');
}

// ‚îÄ‚îÄ NOTIFICACIONES IA ‚îÄ‚îÄ
const NOTIFS = [
  { icon:'‚è∞', color:'rgba(124,58,237,0.15)', border:'rgba(124,58,237,0.3)', title:'Tu franja optima empieza en 30 min', desc:'Las 16:30 es historicamente tu hora pico. Tienes Matematicas pendiente ‚Äî es el momento ideal.', action:'Preparar sesion', time:'Ahora', type:'optima' },
  { icon:'üìà', color:'rgba(16,185,129,0.1)', border:'rgba(16,185,129,0.25)', title:'Nuevo record personal de bloques perfectos', desc:'Esta semana llevas 8 bloques perfectos. Tu anterior record era 6. Sigue asi.', action:'Ver estadisticas', time:'Hace 2h', type:'logro' },
  { icon:'üö®', color:'rgba(244,63,94,0.1)', border:'rgba(244,63,94,0.25)', title:'Examen de Fisica en 3 dias', desc:'Solo tienes 2.1h de estudio acumuladas. El predictor indica esfuerzo insuficiente para tu objetivo del 70%.', action:'Activar modo examen', time:'Hace 3h', type:'urgente' },
  { icon:'üîç', color:'rgba(245,158,11,0.1)', border:'rgba(245,158,11,0.25)', title:'Patron detectado: interrupciones los jueves', desc:'El 80% de tus interrupciones de esta semana han sido los jueves entre 16-18h. Considera un descanso activo antes.', action:'Aligerar el jueves', time:'Ayer', type:'patron' },
];

const ADVICE_HISTORY = [
  { day:'Jueves 20', icon:'üò¥', text:'Detectamos cansancio acumulado. Recomendamos reducir la sesion de hoy a 1 Pomodoro.', followed:true },
  { day:'Miercoles 19', icon:'üí°', text:'Tu mejor dia para Historia es el miercoles por la tarde. Hoy es el momento.', followed:true },
  { day:'Martes 18', icon:'üçÖ', text:'Prueba bloques de 50 min para Ingles. Entras en flujo pasado el minuto 20.', followed:false },
  { day:'Lunes 17', icon:'üìÖ', text:'Planifica la semana ahora y gana 10 Focos extra. Es el mejor momento del dia.', followed:true },
];

function buildNotifFeed() {
  const el = document.getElementById('notif-feed');
  if (!el) return;
  el.innerHTML = NOTIFS.map((n, i) => `
    <div style="background:${n.color};border:1px solid ${n.border};border-radius:16px;padding:18px;display:flex;gap:14px;align-items:flex-start;transition:all 0.2s;" onmouseover="this.style.transform='translateX(4px)'" onmouseout="this.style.transform=''">
      <div style="font-size:28px;flex-shrink:0;">${n.icon}</div>
      <div style="flex:1;">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px;">
          <div style="font-size:15px;font-weight:800;">${n.title}</div>
          <div style="font-size:11px;color:var(--text-muted);white-space:nowrap;margin-left:12px;">${n.time}</div>
        </div>
        <div style="font-size:13px;color:var(--text-muted);line-height:1.6;margin-bottom:12px;">${n.desc}</div>
        <div style="display:flex;gap:8px;">
          <button class="btn btn-primary" style="font-size:12px;padding:6px 14px;" onclick="handleNotifAction(${i})">${n.action}</button>
          <button class="btn btn-ghost" style="font-size:12px;padding:6px 12px;" onclick="this.closest('[style]').style.opacity='0.4'">OK</button>
        </div>
      </div>
    </div>
  `).join('');
}

function handleNotifAction(i) {
  const actions = [
    () => showToast('‚è±Ô∏è','Sesion preparada','Bloque de Matematicas a las 16:30 creado'),
    () => showPage('heatmap'),
    () => showPage('examenes'),
    () => showToast('üìÖ','Jueves ajustado','Carga reducida en tu planificador'),
  ];
  actions[i]?.();
}

function buildAdviceHistory() {
  const el = document.getElementById('advice-history');
  if (!el) return;
  el.innerHTML = ADVICE_HISTORY.map(a => `
    <div style="display:flex;gap:14px;align-items:center;padding:14px;background:var(--surface2);border:1px solid var(--border);border-radius:12px;">
      <span style="font-size:22px;">${a.icon}</span>
      <div style="flex:1;">
        <div style="font-size:11px;color:var(--text-muted);font-weight:700;margin-bottom:4px;">${a.day}</div>
        <div style="font-size:13px;color:var(--text);">${a.text}</div>
      </div>
      <div style="font-size:12px;font-weight:700;flex-shrink:0;padding:4px 10px;border-radius:20px;${a.followed ? 'background:rgba(16,185,129,0.15);color:var(--accent3);' : 'background:rgba(255,255,255,0.05);color:var(--text-muted);'}">${a.followed ? 'Seguido' : 'No seguido'}</div>
    </div>
  `).join('');
}

function addSuggestedBlock() {
  showToast('üìÖ','Bloque anadido','Matematicas a las 16:30 en tu planificador. +10 Focos al completarlo');
}

buildNotifFeed();
buildAdviceHistory();

// ‚îÄ‚îÄ ANNUAL HEATMAP ‚îÄ‚îÄ
function buildAnnualHeatmap() {
  const el = document.getElementById('annual-heatmap');
  if (!el) return;
  const examDays = new Set([45,72,110,143]);
  const holidayDays = new Set([0,1,2,3,20,21,87,88,89]);
  const months = ['Sep','Oct','Nov','Dic','Ene','Feb','Mar','Abr','May','Jun'];
  const daysPerMonth = [22,23,21,20,23,20,21,22,21,22];
  let html = '';
  let monthStart = 0;
  daysPerMonth.forEach((days, mi) => {
    html += `<div style="display:flex;flex-direction:column;gap:2px;margin-right:8px;margin-bottom:8px;">`;
    html += `<div style="font-size:10px;color:var(--text-muted);font-weight:700;margin-bottom:4px;text-align:center;">${months[mi]}</div>`;
    html += `<div style="display:grid;grid-template-columns:repeat(5,14px);gap:2px;">`;
    for (let d = 0; d < days; d++) {
      const abs = monthStart + d;
      let bg, border='transparent';
      if (holidayDays.has(abs)) { bg='rgba(244,63,94,0.25)'; }
      else if (examDays.has(abs)) { bg='rgba(245,158,11,0.6)'; border='rgba(245,158,11,0.8)'; }
      else if (abs > 150) { bg='rgba(124,58,237,0.08)'; }
      else {
        const r = Math.random();
        if (r<0.15) bg='rgba(124,58,237,0.08)';
        else if (r<0.3) bg='rgba(124,58,237,0.25)';
        else if (r<0.55) bg='rgba(124,58,237,0.45)';
        else if (r<0.8) bg='rgba(124,58,237,0.7)';
        else bg='#a78bfa';
      }
      html += `<div style="width:14px;height:14px;border-radius:3px;background:${bg};border:1px solid ${border};cursor:pointer;transition:transform 0.1s;" title="${months[mi]} dia ${d+1}" onmouseover="this.style.transform='scale(1.3)'" onmouseout="this.style.transform=''"></div>`;
    }
    html += '</div></div>';
    monthStart += days;
  });
  el.innerHTML = html;
}
buildAnnualHeatmap();

// ‚îÄ‚îÄ EX√ÅMENES ‚îÄ‚îÄ
const EXAMS = [
  { subj:'Matem√°ticas', emoji:'üìê', color:'#7c3aed', date:'Mi√©rcoles 26 Feb', daysLeft:3, hours:4.5 },
  { subj:'F√≠sica', emoji:'üî¨', color:'#4285F4', date:'Viernes 7 Mar', daysLeft:14, hours:2.1 },
  { subj:'Historia', emoji:'üìñ', color:'#f59e0b', date:'Lunes 10 Mar', daysLeft:17, hours:1.5 },
  { subj:'Ingl√©s', emoji:'üá¨üáß', color:'#10b981', date:'Mi√©rcoles 12 Mar', daysLeft:19, hours:3.2 },
];

function buildExamsList() {
  const el = document.getElementById('exams-list');
  if (!el) return;
  el.innerHTML = EXAMS.map(e => {
    const urgColor = e.daysLeft <= 5 ? '#fb7185' : e.daysLeft <= 10 ? 'var(--focos)' : 'var(--accent3)';
    return `<div style="background:var(--surface2);border:1px solid var(--border);border-radius:16px;padding:18px;display:flex;align-items:center;gap:16px;transition:all 0.2s;" onmouseover="this.style.borderColor='${e.color}55'" onmouseout="this.style.borderColor='var(--border)'">
      <div style="width:48px;height:48px;background:${e.color}22;border:2px solid ${e.color}55;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0;">${e.emoji}</div>
      <div style="flex:1;">
        <div style="font-size:16px;font-weight:800;">${e.subj}</div>
        <div style="font-size:12px;color:var(--text-muted);margin-top:2px;">üìÖ ${e.date} ¬∑ ${e.hours}h estudiadas</div>
      </div>
      <div style="text-align:center;padding:8px 16px;background:${urgColor}15;border:1px solid ${urgColor}40;border-radius:10px;">
        <div style="font-size:22px;font-weight:900;font-family:'Space Mono',monospace;color:${urgColor};">${e.daysLeft}</div>
        <div style="font-size:10px;color:${urgColor};font-weight:700;">d√≠as</div>
      </div>
      ${e.daysLeft <= 5 ? '<button class="btn btn-primary" style="font-size:13px;padding:8px 16px;" onclick="activateExamMode()">‚ö° Modo examen</button>' : ''}
    </div>`;
  }).join('');
}
buildExamsList();

function buildPredictorList() {
  const el = document.getElementById('predictor-list');
  if (!el) return;
  const data = [
    { subj:'Matem√°ticas', emoji:'üìê', pct:72, label:'‚ö†Ô∏è Puedes mejorar', color:'var(--focos)' },
    { subj:'F√≠sica', emoji:'üî¨', pct:45, label:'üî¥ Refuerza estudio', color:'#fb7185' },
    { subj:'Historia', emoji:'üìñ', pct:58, label:'‚ö†Ô∏è Puedes mejorar', color:'var(--focos)' },
    { subj:'Ingl√©s', emoji:'üá¨üáß', pct:88, label:'‚úÖ Bien encaminado', color:'var(--accent3)' },
  ];
  el.innerHTML = data.map(d => `
    <div style="display:flex;align-items:center;gap:14px;padding:14px;background:var(--surface2);border-radius:12px;border:1px solid var(--border);">
      <span style="font-size:22px;">${d.emoji}</span>
      <div style="flex:1;">
        <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
          <span style="font-size:14px;font-weight:700;">${d.subj}</span>
          <span style="font-size:12px;font-weight:700;color:${d.color};">${d.label}</span>
        </div>
        <div style="background:rgba(255,255,255,0.06);border-radius:100px;height:8px;overflow:hidden;">
          <div style="width:${d.pct}%;height:100%;background:${d.color};border-radius:100px;"></div>
        </div>
        <div style="font-size:11px;color:var(--text-muted);margin-top:4px;">Esfuerzo relativo: ${d.pct}%</div>
      </div>
    </div>`).join('');
}
buildPredictorList();

function activateExamMode() {
  showToast('üö®','¬°Modo Examen activado!','Plan de repaso para Matem√°ticas a√±adido al planificador');
}

// ‚îÄ‚îÄ FOCOS SOLIDARIOS ‚îÄ‚îÄ
function donateToFund(amount) {
  if (focos < amount) { showToast('‚ùå','Sin Focos suficientes','Sigue estudiando üîÜ'); return; }
  focos -= amount;
  document.getElementById('focos-display').textContent = focos;
  document.getElementById('focos-display2').textContent = focos;
  const sf = document.getElementById('solidario-focos');
  if (sf) sf.textContent = focos;
  const hist = document.getElementById('fund-history');
  if (hist) {
    const div = document.createElement('div');
    div.style.cssText = 'display:flex;align-items:center;gap:12px;padding:12px;background:var(--surface2);border-radius:12px;border:1px solid rgba(16,185,129,0.2);animation:fadeIn 0.3s ease;';
    div.innerHTML = '<span style="font-size:18px;">üë¶</span><div style="flex:1;"><div style="font-size:13px;font-weight:700;">Alejandro don√≥</div><div style="font-size:11px;color:var(--text-muted);">Ahora mismo</div></div><span style="font-family:Space Mono,monospace;font-weight:700;color:var(--focos);">+' + amount + ' üîÜ</span>';
    hist.prepend(div);
  }
  showToast('ü´∂','Donaci√≥n realizada!', '+' + amount + ' üîÜ al fondo familiar');
}

// ‚îÄ‚îÄ RANKING TEMPORADA ‚îÄ‚îÄ
function buildRanking() {
  const el = document.getElementById('ranking-list');
  if (!el) return;
  const data = [
    { pos:1, name:'Sof√≠a', emoji:'üëß', focos:512, racha:8, perfect:12, you:false },
    { pos:2, name:'Alejandro', emoji:'üë¶', focos:487, racha:5, perfect:8, you:true },
    { pos:3, name:'Primo Marco', emoji:'üë¶üèª', focos:321, racha:3, perfect:5, you:false },
    { pos:4, name:'Prima Laura', emoji:'üë©', focos:198, racha:1, perfect:2, you:false },
  ];
  const medals = ['ü•á','ü•à','ü•â'];
  el.innerHTML = data.map(r => {
    const medal = r.pos <= 3 ? medals[r.pos-1] : '#' + r.pos;
    const hl = r.you ? 'border-color:rgba(124,58,237,0.5);background:rgba(124,58,237,0.08);' : '';
    return `<div style="display:flex;align-items:center;gap:14px;padding:16px;background:var(--surface2);border:1px solid var(--border);border-radius:14px;transition:all 0.2s;${hl}" onmouseover="this.style.transform='translateX(4px)'" onmouseout="this.style.transform=''">
      <div style="font-size:24px;width:32px;text-align:center;">${medal}</div>
      <div style="font-size:24px;">${r.emoji}</div>
      <div style="flex:1;">
        <div style="font-size:15px;font-weight:800;">${r.name} ${r.you ? '<span style="font-size:11px;color:#a78bfa;font-weight:700;">(T√∫)</span>' : ''}</div>
        <div style="font-size:12px;color:var(--text-muted);margin-top:2px;">üî• ${r.racha} d√≠as ¬∑ üíé ${r.perfect} perfectos</div>
      </div>
      <div style="font-family:Space Mono,monospace;font-size:20px;font-weight:700;color:var(--focos);">${r.focos} üîÜ</div>
    </div>`;
  }).join('');
}
buildRanking();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ONBOARDING & AUTH FLOW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let currentRole = null;
let currentUser = { name:'Alejandro Garc√≠a', email:'alejandro@gmail.com', role:'hijo', familyCode:'FAM-4X92K' };
let isLinked = false;

// QR Matrix for visual QR (simplified pattern)
function drawQR(canvasId, code) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const size = canvas.width;
  const cells = 15;
  const cellSize = size / cells;

  ctx.fillStyle = 'white';
  ctx.fillRect(0, 0, size, size);

  // Seed-based pseudo-random from code
  let seed = code.split('').reduce((a, c) => a + c.charCodeAt(0), 0);
  const rand = () => { seed = (seed * 9301 + 49297) % 233280; return seed / 233280; };

  ctx.fillStyle = '#0a0a0f';

  // Corner squares (fixed pattern)
  const drawCorner = (x, y) => {
    ctx.fillRect(x * cellSize, y * cellSize, 7 * cellSize, 7 * cellSize);
    ctx.fillStyle = 'white';
    ctx.fillRect((x+1) * cellSize, (y+1) * cellSize, 5 * cellSize, 5 * cellSize);
    ctx.fillStyle = '#0a0a0f';
    ctx.fillRect((x+2) * cellSize, (y+2) * cellSize, 3 * cellSize, 3 * cellSize);
    ctx.fillStyle = '#0a0a0f';
  };
  drawCorner(0, 0);
  drawCorner(cells - 7, 0);
  drawCorner(0, cells - 7);

  // Data cells (random based on seed)
  for (let row = 0; row < cells; row++) {
    for (let col = 0; col < cells; col++) {
      const inCorner = (row < 8 && col < 8) || (row < 8 && col >= cells-8) || (row >= cells-8 && col < 8);
      if (!inCorner && rand() > 0.5) {
        ctx.fillStyle = '#0a0a0f';
        ctx.beginPath();
        ctx.roundRect(col * cellSize + 1, row * cellSize + 1, cellSize - 2, cellSize - 2, 2);
        ctx.fill();
      }
    }
  }

  // Accent dot in center
  ctx.fillStyle = '#7c3aed';
  const cx = (cells / 2) * cellSize;
  ctx.beginPath();
  ctx.arc(cx, cx, cellSize * 1.2, 0, Math.PI * 2);
  ctx.fill();
  ctx.fillStyle = 'white';
  ctx.font = 'bold 10px Space Mono';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText('FF', cx, cx);
}

// Step 1: Select role
function selectRole(role) {
  currentRole = role;
  document.querySelectorAll('.role-card').forEach(c => c.classList.remove('selected'));
  document.getElementById('role-' + role).classList.add('selected');
  document.getElementById('btn-role-continue').removeAttribute('disabled');
  document.getElementById('btn-role-continue').style.opacity = '1';
}

// Step 2: Go to login
function goToLogin() {
  if (!currentRole) { selectRole('hijo'); }
  const isHijo = currentRole === 'hijo';
  document.getElementById('ob-login-emoji').textContent = isHijo ? 'üéí' : 'üë®‚Äçüë©‚Äçüë¶';
  document.getElementById('ob-login-title').textContent = isHijo ? 'Crea tu cuenta de alumno' : 'Crea tu cuenta familiar';
  document.getElementById('ob-login-subtitle').textContent = isHijo
    ? 'Organiza tu estudio, gana Focos y conecta con tu familia'
    : 'Acompa√±a a tus hijos y gestiona pactos y recompensas';
  showScreen('ob-login');
}

// Login with Google (simulated)
function loginWithGoogle() {
  const name = currentRole === 'hijo' ? 'Alejandro Garc√≠a' : 'Carlos Garc√≠a';
  const email = currentRole === 'hijo' ? 'alejandro@gmail.com' : 'carlos@gmail.com';
  document.getElementById('input-name').value = name;
  document.getElementById('input-email').value = email;
  setTimeout(() => doRegister(), 400);
}

// Step 3a: Register and go to QR screen
function doRegister() {
  const name = document.getElementById('input-name').value || (currentRole === 'hijo' ? 'Alumno' : 'Padre');
  currentUser = { name, email: document.getElementById('input-email').value || 'user@email.com', role: currentRole, familyCode: 'FAM-4X92K' };

  if (currentRole === 'padre') {
    showScreen('ob-padre-qr');
    setTimeout(() => {
      drawQR('qr-canvas', 'FAM-4X92K');
      // Simulate child joining after 4s in demo
      setTimeout(simulateChildJoined, 4000);
    }, 200);
  } else {
    showScreen('ob-hijo-qr');
  }
}

// Simulate a child connecting (for padre demo)
function simulateChildJoined() {
  const waiting = document.getElementById('qr-waiting');
  if (!waiting || !document.getElementById('ob-padre-qr').classList.contains('hidden') === false) return;
  waiting.innerHTML = '<div style="width:8px;height:8px;border-radius:50%;background:var(--accent3);"></div><span style="color:var(--accent3);font-weight:700;">¬°Alejandro se ha unido!</span>';
  waiting.style.background = 'rgba(16,185,129,0.1)';
  waiting.style.borderColor = 'rgba(16,185,129,0.3)';
  const linked = document.getElementById('linked-children');
  linked.style.display = 'block';
  linked.innerHTML += '<div style="display:flex;align-items:center;gap:10px;padding:10px;background:rgba(16,185,129,0.08);border:1px solid rgba(16,185,129,0.2);border-radius:10px;font-size:13px;font-weight:700;color:var(--accent3);">üë¶ Alejandro ‚Äî Conectado ‚úì</div>';
}

// Child: check code length
function checkCode(input) {
  input.value = input.value.toUpperCase();
  document.getElementById('btn-verify-code').disabled = input.value.length < 5;
}

// Child: simulate QR scan
function simulateScan() {
  const scanner = document.getElementById('scanner-view');
  scanner.style.borderColor = 'rgba(16,185,129,0.6)';
  scanner.innerHTML = '<div style="font-size:48px;animation:popIn 0.4s ease;">‚úì</div><div style="position:absolute;bottom:-24px;font-size:11px;color:var(--accent3);font-weight:700;">QR detectado!</div>';
  setTimeout(() => showSuccess(), 800);
}

// Child: verify manual code
function verifyCode() {
  const code = document.getElementById('code-input').value;
  if (code.length >= 5) {
    showSuccess();
  }
}

function showSuccess() {
  const isHijo = currentRole === 'hijo';
  document.getElementById('success-title').textContent = isHijo ? '¬°Ya est√°is conectados!' : '¬°Familia vinculada!';
  document.getElementById('success-subtitle').textContent = isHijo
    ? 'Tu cuenta est√° vinculada a la cuenta familiar. Tus padres recibir√°n tu resumen semanal.'
    : 'Alejandro ya forma parte de tu grupo familiar. Recibir√°s su resumen cada domingo.';

  if (isHijo) {
    document.getElementById('success-child-emoji').textContent = 'üéí';
    document.getElementById('success-child-name').textContent = currentUser.name;
    document.getElementById('success-parent-emoji').textContent = 'üë®‚Äçüë©‚Äçüë¶';
    document.getElementById('success-parent-name').textContent = 'Cuenta familiar';
  }
  showScreen('ob-success');
}

// Enter the app
function enterApp() {
  // Hide all onboarding screens
  document.querySelectorAll('.onboarding').forEach(o => o.classList.add('hidden'));

  // Show the app shell (override the display:none)
  const shell = document.getElementById('app-shell');
  shell.style.cssText = 'display:flex!important;';

  const isHijo = currentUser.role === 'hijo';

  // Update sidebar user card
  document.getElementById('sidebar-avatar').textContent = isHijo ? 'üéí' : 'üë®‚Äçüë©‚Äçüë¶';
  document.getElementById('sidebar-name').textContent = currentUser.name.split(' ')[0];
  document.getElementById('sidebar-role').textContent = isHijo ? 'Alumno' : 'Padre/Madre';
  document.getElementById('sidebar-role').style.color = isHijo ? 'var(--accent3)' : '#a78bfa';

  if (isHijo) {
    // Show hijo dashboard
    showPage('dashboard');
  } else {
    // Show parent panel directly
    showPage('padres');
    // Grey out hijo-only nav items
    ['nav-pomodoro','nav-badges','nav-ia','nav-heatmap','nav-economia'].forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.style.opacity = '0.3';
        el.style.pointerEvents = 'none';
        el.title = 'Solo disponible en el perfil del alumno';
      }
    });
    // Add switch-to-child hint in sidebar
    const hint = document.createElement('div');
    hint.style.cssText = 'margin:8px 12px;padding:10px 12px;background:rgba(124,58,237,0.08);border:1px solid rgba(124,58,237,0.2);border-radius:10px;font-size:11px;color:#a78bfa;font-weight:600;cursor:pointer;';
    hint.innerHTML = 'üë¶ Ver perfil de Alejandro';
    hint.onclick = () => switchToChildView();
    document.querySelector('.nav-section').appendChild(hint);
  }

  showToast('üöÄ', '¬°Bienvenido!', 'Focus Family ¬∑ ' + currentUser.name);
}

function switchToChildView() {
  // Restore hijo nav items
  ['nav-pomodoro','nav-badges','nav-ia','nav-heatmap','nav-economia'].forEach(id => {
    const el = document.getElementById(id);
    if (el) { el.style.opacity = ''; el.style.pointerEvents = ''; }
  });
  showPage('dashboard');
  document.getElementById('sidebar-avatar').textContent = 'üë¶';
  document.getElementById('sidebar-name').textContent = 'Alejandro';
  document.getElementById('sidebar-role').textContent = 'Alumno (vista)';
  document.getElementById('sidebar-role').style.color = 'var(--focos)';
  showToast('üë¶','Vista del alumno','Viendo el perfil de Alejandro');
}

// Utility: show a specific screen
function showScreen(id) {
  document.querySelectorAll('.onboarding').forEach(o => o.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
}

function goBack(targetId) {
  showScreen(targetId);
}

// Sidebar QR button
function showQRAgain() {
  const modal = document.getElementById('qr-modal');
  modal.style.display = 'flex';
  setTimeout(() => drawQR('qr-modal-canvas', 'FAM-4X92K'), 100);
}

// Copy code
function copyCode() {
  navigator.clipboard?.writeText('FAM-4X92K').catch(()=>{});
  showToast('üìã','C√≥digo copiado','FAM-4X92K copiado al portapapeles');
}

function shareQR() {
  showToast('üì§','Compartir QR','En la versi√≥n final puedes enviar el QR por WhatsApp o email');
}

function regenerateCode() {
  showToast('‚Ü∫','C√≥digo regenerado','El anterior c√≥digo ya no es v√°lido');
  document.getElementById('family-code-display').textContent = 'FAM-' + Math.random().toString(36).substring(2,7).toUpperCase();
}


function logOut() {
  document.getElementById('app-shell').style.cssText = 'display:none!important;';
  currentRole = null;
  currentUser = {};
  document.querySelectorAll('.role-card').forEach(c => c.classList.remove('selected'));
  const btn = document.getElementById('btn-role-continue');
  if (btn) { btn.disabled = true; btn.style.opacity = '0.4'; }
  document.getElementById('input-name').value = '';
  document.getElementById('input-email').value = '';
  document.getElementById('input-pass').value = '';
  showScreen('ob-welcome');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REWARDS MANAGER (PADRES)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let editingRewardId = null;
let selectedEmoji = 'üéÅ';
let selectedCat = 'medium';

const REWARDS_DB = [
  { id:1, emoji:'üéÆ', name:'Tarde de videojuegos', desc:'2 horas sin l√≠mite de pantalla', cost:80, cat:'medium', active:true, requests:1 },
  { id:2, emoji:'üçï', name:'Pedir comida a domicilio', desc:'Eliges el restaurante', cost:50, cat:'small', active:true, requests:0 },
  { id:3, emoji:'üé¨', name:'Noche de cine en casa', desc:'Eliges peli y snacks', cost:120, cat:'medium', active:true, requests:1 },
  { id:4, emoji:'üëü', name:'Ropa o zapatillas', desc:'Hasta 60‚Ç¨ en la tienda que quieras', cost:400, cat:'big', active:true, requests:0 },
  { id:5, emoji:'üèïÔ∏è', name:'Excursi√≥n con amigos', desc:'Un d√≠a de actividad exterior', cost:300, cat:'big', active:false, requests:0 },
];

const REWARD_REQUESTS = [
  { id:1, rewardId:3, childName:'Alejandro', emoji:'üé¨', rewardName:'Noche de cine en casa', cost:120, date:'Hace 1 hora', status:'pending' },
  { id:2, rewardId:1, childName:'Alejandro', emoji:'üéÆ', rewardName:'Tarde de videojuegos', cost:80, date:'Hace 3 horas', status:'pending' },
];

const REWARD_HISTORY = [
  { emoji:'üçï', name:'Pedir comida a domicilio', childName:'Alejandro', cost:50, date:'15 Feb 2025', status:'approved' },
  { emoji:'üéÆ', name:'Tarde de videojuegos', childName:'Alejandro', cost:80, date:'8 Feb 2025', status:'approved' },
  { emoji:'üé¨', name:'Noche de cine', childName:'Alejandro', cost:120, date:'1 Feb 2025', status:'rejected' },
];

const CAT_STYLES = {
  small:  { label:'üü¢ Peque√±a',  color:'var(--accent3)',  bg:'rgba(16,185,129,0.12)',  border:'rgba(16,185,129,0.3)' },
  medium: { label:'üü£ Mediana',  color:'#a78bfa',         bg:'rgba(124,58,237,0.12)', border:'rgba(124,58,237,0.3)' },
  big:    { label:'üî¥ Grande',   color:'#fb7185',         bg:'rgba(244,63,94,0.12)',  border:'rgba(244,63,94,0.3)'  },
};

function buildRewardsCatalog() {
  const el = document.getElementById('rewards-catalog-list');
  if (!el) return;
  el.innerHTML = REWARDS_DB.map(r => {
    const cat = CAT_STYLES[r.cat];
    return `
    <div style="background:var(--surface2);border:1px solid ${r.active ? 'var(--border)' : 'rgba(255,255,255,0.04)'};border-radius:16px;padding:18px;display:flex;align-items:center;gap:14px;opacity:${r.active ? '1' : '0.5'};transition:all 0.2s;">
      <div style="width:52px;height:52px;background:${cat.bg};border:1.5px solid ${cat.border};border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:26px;flex-shrink:0;">${r.emoji}</div>
      <div style="flex:1;min-width:0;">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:3px;">
          <span style="font-size:15px;font-weight:800;">${r.name}</span>
          <span style="font-size:10px;font-weight:700;color:${cat.color};background:${cat.bg};padding:2px 8px;border-radius:20px;">${cat.label}</span>
          ${!r.active ? '<span style="font-size:10px;color:var(--text-muted);background:rgba(255,255,255,0.06);padding:2px 8px;border-radius:20px;">INACTIVA</span>' : ''}
        </div>
        <div style="font-size:12px;color:var(--text-muted);">${r.desc}</div>
      </div>
      <div style="text-align:right;flex-shrink:0;">
        <div style="font-family:Space Mono,monospace;font-size:22px;font-weight:700;color:var(--focos);">${r.cost}</div>
        <div style="font-size:10px;color:var(--text-muted);">Focos</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px;flex-shrink:0;">
        <button class="btn btn-ghost" style="font-size:12px;padding:5px 12px;" onclick="editReward(${r.id})">‚úèÔ∏è Editar</button>
        <button class="btn btn-ghost" style="font-size:12px;padding:5px 12px;" onclick="toggleReward(${r.id})">${r.active ? 'üîï Ocultar' : 'üëÅÔ∏è Activar'}</button>
      </div>
    </div>`;
  }).join('');
}

function buildRewardRequests() {
  const el = document.getElementById('reward-requests-list');
  if (!el) return;
  if (REWARD_REQUESTS.length === 0) {
    el.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted);">No hay solicitudes pendientes</div>';
    return;
  }
  el.innerHTML = REWARD_REQUESTS.map(req => `
    <div style="background:var(--surface2);border:1px solid rgba(245,158,11,0.25);border-radius:16px;padding:20px;" id="req-${req.id}">
      <div style="display:flex;align-items:center;gap:14px;margin-bottom:14px;">
        <div style="font-size:32px;">${req.emoji}</div>
        <div style="flex:1;">
          <div style="font-size:16px;font-weight:800;">${req.rewardName}</div>
          <div style="font-size:12px;color:var(--text-muted);">Solicitado por ${req.childName} ¬∑ ${req.date}</div>
        </div>
        <div style="font-family:Space Mono,monospace;font-size:24px;font-weight:700;color:var(--focos);">${req.cost} üîÜ</div>
      </div>
      <div style="display:flex;gap:10px;">
        <button class="btn btn-primary" style="flex:1;padding:12px;" onclick="approveRequest(${req.id})">‚úÖ Aprobar</button>
        <button class="btn btn-ghost" style="flex:1;padding:12px;color:#fb7185;" onclick="rejectRequest(${req.id})">‚ùå Rechazar</button>
      </div>
    </div>
  `).join('');
}

function buildRewardHistory() {
  const el = document.getElementById('reward-history-list');
  if (!el) return;
  el.innerHTML = REWARD_HISTORY.map(h => `
    <div style="display:flex;align-items:center;gap:12px;padding:14px;background:var(--surface2);border-radius:12px;border:1px solid var(--border);">
      <span style="font-size:24px;">${h.emoji}</span>
      <div style="flex:1;">
        <div style="font-size:14px;font-weight:700;">${h.name}</div>
        <div style="font-size:11px;color:var(--text-muted);">${h.childName} ¬∑ ${h.date}</div>
      </div>
      <div style="font-family:Space Mono,monospace;font-size:14px;color:var(--focos);margin-right:8px;">-${h.cost} üîÜ</div>
      <div style="font-size:12px;font-weight:700;padding:4px 10px;border-radius:20px;${h.status === 'approved' ? 'color:var(--accent3);background:rgba(16,185,129,0.12);' : 'color:#fb7185;background:rgba(244,63,94,0.1);'}">
        ${h.status === 'approved' ? '‚úÖ Aprobada' : '‚ùå Rechazada'}
      </div>
    </div>
  `).join('');
}

function switchRewardTab(tab, el) {
  document.querySelectorAll('#page-recompensas .tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  ['catalogo','solicitudes','historial'].forEach(t => {
    const d = document.getElementById('rw-' + t);
    if (d) d.style.display = t === tab ? '' : 'none';
  });
  if (tab === 'catalogo') buildRewardsCatalog();
  if (tab === 'solicitudes') buildRewardRequests();
  if (tab === 'historial') buildRewardHistory();
}

function openRewardModal(id = null) {
  editingRewardId = id;
  const modal = document.getElementById('reward-modal');
  modal.style.display = 'flex';

  if (id) {
    const r = REWARDS_DB.find(x => x.id === id);
    document.getElementById('modal-title').textContent = 'Editar recompensa';
    document.getElementById('rw-name').value = r.name;
    document.getElementById('rw-desc').value = r.desc;
    document.getElementById('rw-cost-slider').value = r.cost;
    document.getElementById('rw-cost-display').textContent = r.cost;
    selectedEmoji = r.emoji;
    selectedCat = r.cat;
    // Highlight selected emoji
    document.querySelectorAll('.emoji-opt').forEach(e => {
      e.style.border = e.textContent === r.emoji ? '2px solid var(--accent)' : '2px solid transparent';
      e.style.background = e.textContent === r.emoji ? 'rgba(124,58,237,0.15)' : '';
    });
    // Highlight selected cat
    document.querySelectorAll('.cat-opt').forEach(e => {
      const isSelected = (e.dataset.cat || e.onclick?.toString().includes(r.cat));
      e.style.outline = '';
    });
  } else {
    document.getElementById('modal-title').textContent = 'Nueva recompensa';
    document.getElementById('rw-name').value = '';
    document.getElementById('rw-desc').value = '';
    document.getElementById('rw-cost-slider').value = 100;
    document.getElementById('rw-cost-display').textContent = '100';
    selectedEmoji = 'üéÅ';
    selectedCat = 'medium';
    document.querySelectorAll('.emoji-opt').forEach(e => {
      e.style.border = '2px solid transparent';
      e.style.background = '';
    });
  }
}

function closeRewardModal() {
  document.getElementById('reward-modal').style.display = 'none';
  editingRewardId = null;
}

function selectEmoji(el) {
  document.querySelectorAll('.emoji-opt').forEach(e => {
    e.style.border = '2px solid transparent';
    e.style.background = '';
  });
  el.style.border = '2px solid var(--accent)';
  el.style.background = 'rgba(124,58,237,0.15)';
  selectedEmoji = el.textContent;
}

function selectCat(el, cat) {
  document.querySelectorAll('.cat-opt').forEach(e => e.style.boxShadow = '');
  el.style.boxShadow = '0 0 0 2px var(--accent)';
  selectedCat = cat;
  // Auto-adjust cost preset
  const presets = { small: 30, medium: 100, big: 300 };
  setCost(presets[cat]);
}

function setCost(val) {
  document.getElementById('rw-cost-slider').value = val;
  document.getElementById('rw-cost-display').textContent = val;
}

function saveReward() {
  const name = document.getElementById('rw-name').value.trim();
  if (!name) {
    document.getElementById('rw-name').style.borderColor = '#f43f5e';
    document.getElementById('rw-name').focus();
    return;
  }
  document.getElementById('rw-name').style.borderColor = '';
  const cost = parseInt(document.getElementById('rw-cost-slider').value);
  const desc = document.getElementById('rw-desc').value.trim();

  if (editingRewardId) {
    const r = REWARDS_DB.find(x => x.id === editingRewardId);
    r.name = name; r.desc = desc; r.cost = cost;
    r.emoji = selectedEmoji; r.cat = selectedCat;
    showToast('‚úÖ', 'Recompensa actualizada', name + ' ¬∑ ' + cost + ' Focos');
  } else {
    REWARDS_DB.push({
      id: Date.now(), emoji: selectedEmoji, name, desc,
      cost, cat: selectedCat, active: true, requests: 0
    });
    showToast('üéÅ', 'Recompensa creada', name + ' ¬∑ ' + cost + ' Focos ¬∑ Alejandro ya puede verla');
  }
  closeRewardModal();
  buildRewardsCatalog();
}

function editReward(id) {
  openRewardModal(id);
}

function toggleReward(id) {
  const r = REWARDS_DB.find(x => x.id === id);
  r.active = !r.active;
  showToast(r.active ? 'üëÅÔ∏è' : 'üîï', r.active ? 'Recompensa activada' : 'Recompensa ocultada', r.name);
  buildRewardsCatalog();
}

function approveRequest(reqId) {
  const req = REWARD_REQUESTS.find(r => r.id === reqId);
  req.status = 'approved';
  REWARD_HISTORY.unshift({ emoji: req.emoji, name: req.rewardName, childName: req.childName, cost: req.cost, date: 'Hoy', status: 'approved' });
  REWARD_REQUESTS.splice(REWARD_REQUESTS.indexOf(req), 1);
  showToast('‚úÖ', '¬°Aprobada!', req.rewardName + ' canjeada para ' + req.childName + ' ¬∑ -' + req.cost + ' Focos');
  buildRewardRequests();
}

function rejectRequest(reqId) {
  const req = REWARD_REQUESTS.find(r => r.id === reqId);
  req.status = 'rejected';
  REWARD_HISTORY.unshift({ emoji: req.emoji, name: req.rewardName, childName: req.childName, cost: req.cost, date: 'Hoy', status: 'rejected' });
  REWARD_REQUESTS.splice(REWARD_REQUESTS.indexOf(req), 1);
  showToast('‚ùå', 'Solicitud rechazada', req.rewardName);
  buildRewardRequests();
}

// Init rewards page on first load
buildRewardsCatalog();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PACTOS SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let editingPactoId = null;
let selectedPactoType = 'bloques';

const PACTOS_DB = {
  activos: [
    { id:1, title:'Semana de Matem√°ticas', goal:'4 bloques de mates sin interrupciones', type:'bloques', target:4, current:3, deadline:'Esta semana', reward:'üé¨ Noche de cine', focos:100, note:'¬°Ya casi lo tienes!', proposedBy:'padres' },
    { id:2, title:'Mes sin suspensos', goal:'Estudia todos los d√≠as de febrero', type:'dias', target:28, current:12, deadline:'28 Feb', reward:'üèïÔ∏è Excursi√≥n en primavera', focos:300, note:'', proposedBy:'padres' },
  ],
  propuestos: [
    { id:3, title:'Semana de ex√°menes de F√≠sica', goal:'3 bloques de F√≠sica sin interrupciones', type:'bloques', target:3, current:0, deadline:'Esta semana', reward:'üéÆ +2h gaming el finde', focos:80, note:'Sabemos que puedes, √°nimo!', proposedBy:'padres' },
  ],
  completados: [
    { id:4, title:'Enero sin fallar', goal:'Estudiar al menos 20 d√≠as en enero', type:'dias', target:20, current:20, deadline:'31 Ene', reward:'üçï Pizza en familia', focos:150, note:'', proposedBy:'padres', result:'completed' },
    { id:5, title:'Repaso de Historia', goal:'2 bloques de Historia esta semana', type:'bloques', target:2, current:1, deadline:'Semana anterior', reward:'üéµ Concierto', focos:200, note:'', proposedBy:'padres', result:'expired' },
  ],
};

const PTYPE_STYLES = {
  bloques: { icon:'üì¶', color:'#a78bfa', bg:'rgba(124,58,237,0.12)', border:'rgba(124,58,237,0.3)' },
  dias:    { icon:'üìÖ', color:'var(--accent3)', bg:'rgba(16,185,129,0.1)', border:'rgba(16,185,129,0.25)' },
  libre:   { icon:'‚ú®', color:'var(--focos)', bg:'rgba(245,158,11,0.1)', border:'rgba(245,158,11,0.25)' },
};

function buildPactosActivos() {
  const el = document.getElementById('pactos-activos-list');
  if (!el) return;
  const list = PACTOS_DB.activos;
  if (!list.length) { el.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted);">No hay pactos activos</div>'; return; }
  el.innerHTML = list.map(p => {
    const pct = Math.round((p.current / p.target) * 100);
    const ps = PTYPE_STYLES[p.type];
    return `
    <div class="pacto-card" style="position:relative;">
      <button onclick="openPactoModal(${p.id})" style="position:absolute;top:14px;right:14px;background:rgba(255,255,255,0.05);border:1px solid var(--border);border-radius:8px;padding:4px 10px;font-size:11px;font-weight:700;color:var(--text-muted);cursor:pointer;transition:all 0.15s;" onmouseover="this.style.background='rgba(124,58,237,0.12)';this.style.color='#a78bfa'" onmouseout="this.style.background='rgba(255,255,255,0.05)';this.style.color='var(--text-muted)'">‚úèÔ∏è Editar</button>
      <div class="pacto-header">
        <div>
          <div class="pacto-title">${ps.icon} ${p.title}</div>
          <div style="font-size:13px;color:var(--text-muted);margin-top:2px;">${p.goal}</div>
        </div>
        <span class="pacto-status activo">üü¢ En curso</span>
      </div>
      <div style="display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap;">
        <div class="pacto-reward">${p.reward}</div>
        <div class="pacto-reward">üîÜ ${p.focos} Focos</div>
        <div class="pacto-reward">üìÖ ${p.deadline}</div>
      </div>
      <div class="pacto-progress-track">
        <div class="pacto-progress-fill" style="width:${pct}%;"></div>
      </div>
      <div class="pacto-meta">
        <span>${p.current} de ${p.target} ${p.type === 'dias' ? 'd√≠as' : 'bloques'} ¬∑ ${pct}%</span>
        <span>Vence: ${p.deadline}</span>
      </div>
      ${p.note ? `<div style="margin-top:10px;padding:8px 12px;background:rgba(245,158,11,0.08);border-radius:8px;font-size:12px;color:var(--focos);">üí¨ "${p.note}"</div>` : ''}
    </div>`;
  }).join('');
}

function buildPactosPropuestos() {
  const el = document.getElementById('pactos-propuestos-list');
  if (!el) return;
  const list = PACTOS_DB.propuestos;
  if (!list.length) { el.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted);">No hay pactos pendientes de respuesta</div>'; return; }
  el.innerHTML = list.map(p => {
    const ps = PTYPE_STYLES[p.type];
    return `
    <div style="background:linear-gradient(135deg,rgba(245,158,11,0.12),rgba(245,158,11,0.03));border:1px solid rgba(245,158,11,0.3);border-radius:16px;padding:20px;position:relative;">
      <div style="display:flex;align-items:flex-start;gap:12px;margin-bottom:14px;">
        <div style="font-size:32px;">${ps.icon}</div>
        <div style="flex:1;">
          <div style="font-size:16px;font-weight:800;margin-bottom:4px;">${p.title}</div>
          <div style="font-size:13px;color:var(--text-muted);margin-bottom:6px;">${p.goal}</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <span class="pacto-reward">${p.reward}</span>
            <span class="pacto-reward">üîÜ ${p.focos}</span>
            <span class="pacto-reward">üìÖ ${p.deadline}</span>
          </div>
        </div>
        <button onclick="openPactoModal(${p.id})" style="background:rgba(255,255,255,0.06);border:1px solid var(--border);border-radius:8px;padding:5px 10px;font-size:11px;font-weight:700;color:var(--text-muted);cursor:pointer;flex-shrink:0;">‚úèÔ∏è Editar</button>
      </div>
      ${p.note ? `<div style="padding:8px 12px;background:rgba(245,158,11,0.08);border-radius:8px;font-size:12px;color:var(--focos);margin-bottom:12px;">üí¨ "${p.note}"</div>` : ''}
      <div style="display:flex;gap:8px;">
        <button class="btn btn-ghost" style="flex:1;font-size:13px;" onclick="counterProposePacto(${p.id})">üí¨ El alumno contrapropone</button>
        <button class="btn btn-primary" style="flex:1;font-size:13px;" onclick="acceptPacto(${p.id})">‚úÖ Marcar como aceptado</button>
        <button class="btn btn-ghost" style="font-size:13px;color:#fb7185;" onclick="rejectPacto(${p.id})">‚úï</button>
      </div>
    </div>`;
  }).join('');
}

function buildPactosCompletados() {
  const el = document.getElementById('pactos-completados-list');
  if (!el) return;
  const list = PACTOS_DB.completados;
  if (!list.length) { el.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted);">Todav√≠a no hay pactos completados</div>'; return; }
  el.innerHTML = list.map(p => {
    const done = p.result === 'completed';
    return `
    <div style="background:var(--surface2);border:1px solid ${done ? 'rgba(16,185,129,0.2)' : 'rgba(255,255,255,0.05)'};border-radius:14px;padding:16px;display:flex;gap:14px;align-items:center;opacity:${done ? '1' : '0.6'};">
      <div style="font-size:32px;">${done ? '‚úÖ' : '‚åõ'}</div>
      <div style="flex:1;">
        <div style="font-size:15px;font-weight:800;">${p.title}</div>
        <div style="font-size:12px;color:var(--text-muted);margin-top:2px;">${p.goal} ¬∑ ${p.deadline}</div>
      </div>
      <div style="text-align:right;flex-shrink:0;">
        <div style="font-size:12px;font-weight:700;color:${done ? 'var(--accent3)' : '#fb7185'};">${done ? 'üèÜ Completado' : '‚åõ Caducado'}</div>
        <div style="font-family:Space Mono,monospace;font-size:14px;color:var(--focos);margin-top:2px;">${done ? '+' + p.focos : '‚Äî'} üîÜ</div>
      </div>
    </div>`;
  }).join('');
}

function switchPactoTab(tab, el) {
  document.querySelectorAll('#page-pactos .tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  ['activos','propuestos','completados'].forEach(t => {
    const d = document.getElementById('pt-' + t);
    if (d) d.style.display = t === tab ? '' : 'none';
  });
  if (tab === 'activos') buildPactosActivos();
  if (tab === 'propuestos') buildPactosPropuestos();
  if (tab === 'completados') buildPactosCompletados();
}

function openPactoModal(id = null) {
  editingPactoId = id;
  const modal = document.getElementById('pacto-modal');
  modal.style.display = 'flex';

  if (id) {
    const all = [...PACTOS_DB.activos, ...PACTOS_DB.propuestos];
    const p = all.find(x => x.id === id);
    document.getElementById('pacto-modal-title').textContent = 'Editar pacto';
    document.getElementById('save-pacto-label').textContent = 'Guardar cambios';
    document.getElementById('btn-delete-pacto').style.display = 'inline-block';
    document.getElementById('pacto-title-input').value = p.title;
    document.getElementById('pacto-goal-input').value = p.goal;
    document.getElementById('pacto-target-input').value = p.target;
    document.getElementById('pacto-reward-input').value = p.reward;
    document.getElementById('pacto-focos-slider').value = p.focos;
    document.getElementById('pacto-focos-display').textContent = p.focos;
    document.getElementById('pacto-note-input').value = p.note || '';
    selectPactoType(p.type, null);
  } else {
    document.getElementById('pacto-modal-title').textContent = 'Nuevo pacto';
    document.getElementById('save-pacto-label').textContent = 'Enviar pacto al alumno';
    document.getElementById('btn-delete-pacto').style.display = 'none';
    document.getElementById('pacto-title-input').value = '';
    document.getElementById('pacto-goal-input').value = '';
    document.getElementById('pacto-target-input').value = '';
    document.getElementById('pacto-reward-input').value = '';
    document.getElementById('pacto-focos-slider').value = 100;
    document.getElementById('pacto-focos-display').textContent = '100';
    document.getElementById('pacto-note-input').value = '';
    selectPactoType('bloques', null);
  }

  setTimeout(() => document.getElementById('pacto-title-input').focus(), 100);
}

function closePactoModal() {
  document.getElementById('pacto-modal').style.display = 'none';
  editingPactoId = null;
}

function selectPactoType(type, el) {
  selectedPactoType = type;
  document.querySelectorAll('.pacto-type-opt').forEach(opt => {
    opt.style.boxShadow = '';
    opt.style.transform = '';
  });
  const selected = el || document.querySelector(`.pacto-type-opt[data-ptype="${type}"]`);
  if (selected) {
    selected.style.boxShadow = '0 0 0 2px var(--accent)';
    selected.style.transform = 'scale(1.04)';
  }
}

function savePacto() {
  const title = document.getElementById('pacto-title-input').value.trim();
  const goal  = document.getElementById('pacto-goal-input').value.trim();
  if (!title) { document.getElementById('pacto-title-input').style.borderColor = '#f43f5e'; document.getElementById('pacto-title-input').focus(); return; }
  if (!goal)  { document.getElementById('pacto-goal-input').style.borderColor = '#f43f5e'; document.getElementById('pacto-goal-input').focus(); return; }
  document.getElementById('pacto-title-input').style.borderColor = '';
  document.getElementById('pacto-goal-input').style.borderColor = '';

  const pacto = {
    id: editingPactoId || Date.now(),
    title,
    goal,
    type: selectedPactoType,
    target: parseInt(document.getElementById('pacto-target-input').value) || 1,
    current: 0,
    deadline: document.getElementById('pacto-deadline-input').value,
    reward: document.getElementById('pacto-reward-input').value.trim() || 'üéÅ Sorpresa',
    focos: parseInt(document.getElementById('pacto-focos-slider').value),
    note: document.getElementById('pacto-note-input').value.trim(),
    proposedBy: 'padres',
  };

  if (editingPactoId) {
    // Update in whichever list it's in
    for (const list of [PACTOS_DB.activos, PACTOS_DB.propuestos]) {
      const idx = list.findIndex(x => x.id === editingPactoId);
      if (idx !== -1) { list[idx] = { ...list[idx], ...pacto }; break; }
    }
    showToast('‚úèÔ∏è', 'Pacto actualizado', title);
  } else {
    PACTOS_DB.propuestos.push(pacto);
    // Update badge
    const badge = document.getElementById('tab-badge-propuestos');
    if (badge) badge.textContent = PACTOS_DB.propuestos.length;
    showToast('ü§ù', '¬°Pacto enviado!', title + ' ¬∑ Alejandro recibir√° la notificaci√≥n');
  }

  closePactoModal();
  // Refresh current visible tab
  buildPactosActivos();
  buildPactosPropuestos();
}

function deletePacto() {
  for (const key of ['activos', 'propuestos']) {
    const idx = PACTOS_DB[key].findIndex(x => x.id === editingPactoId);
    if (idx !== -1) {
      const name = PACTOS_DB[key][idx].title;
      PACTOS_DB[key].splice(idx, 1);
      showToast('üóëÔ∏è', 'Pacto eliminado', name);
      break;
    }
  }
  closePactoModal();
  buildPactosActivos();
  buildPactosPropuestos();
}

function acceptPacto(id) {
  const idx = PACTOS_DB.propuestos.findIndex(x => x.id === id);
  if (idx !== -1) {
    const p = PACTOS_DB.propuestos.splice(idx, 1)[0];
    PACTOS_DB.activos.push(p);
    const badge = document.getElementById('tab-badge-propuestos');
    if (badge) badge.textContent = PACTOS_DB.propuestos.length;
    showToast('‚úÖ', '¬°Pacto activado!', p.title + ' ahora est√° en curso');
    buildPactosPropuestos();
  }
}

function rejectPacto(id) {
  const idx = PACTOS_DB.propuestos.findIndex(x => x.id === id);
  if (idx !== -1) {
    const name = PACTOS_DB.propuestos[idx].title;
    PACTOS_DB.propuestos.splice(idx, 1);
    showToast('‚úï', 'Pacto cancelado', name);
    buildPactosPropuestos();
  }
}

function counterProposePacto(id) {
  showToast('üí¨', 'Contrapropuesta registrada', 'El alumno ha sugerido cambios ¬∑ Revisa el pacto');
}

// Init
buildPactosActivos();

</script>
</body>
</html>
